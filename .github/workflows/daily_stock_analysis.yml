name: æ¯æ—¥è‚¡ç¥¨åˆ†ææ¨é€
# Daily Stock Analysis Push

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š8:30 (UTCæ—¶é—´00:30ï¼ŒåŒ—äº¬æ—¶é—´8:30)
    - cron: '30 0 * * *'
    # æ¯å¤©ä¸‹åˆ6:30 (UTCæ—¶é—´10:30ï¼ŒåŒ—äº¬æ—¶é—´18:30)  
    - cron: '30 10 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'åˆ†æç±»å‹'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - test
        - full

jobs:
  stock_analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy
        
    - name: é…ç½®å¾®ä¿¡ç¯å¢ƒå˜é‡
      env:
        WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
        WECHAT_APP_SECRET: ${{ secrets.WECHAT_APP_SECRET }}
        WECHAT_OPENID: ${{ secrets.WECHAT_OPENID }}
      run: |
        echo "é…ç½®å¾®ä¿¡æ¨é€ç¯å¢ƒ..."
        # åˆ›å»ºé…ç½®æ–‡ä»¶
        cat > wechat_config.py << EOF
        # å¾®ä¿¡å…¬ä¼—å·é…ç½® - GitHub Actionsç‰ˆæœ¬
        import os
        
        WECHAT_APP_ID = os.environ.get('WECHAT_APP_ID', '')
        WECHAT_APP_SECRET = os.environ.get('WECHAT_APP_SECRET', '')
        SUBSCRIBER_OPENIDS = [os.environ.get('WECHAT_OPENID', '')]
        
        # æ¨¡æ¿é…ç½®
        TEMPLATE_ID_DAILY_REPORT = ""
        TEMPLATE_ID_STOCK_ALERT = ""
        EOF
        
    - name: è¿è¡Œè‚¡ç¥¨åˆ†æ
      env:
        WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
        WECHAT_APP_SECRET: ${{ secrets.WECHAT_APP_SECRET }}
        WECHAT_OPENID: ${{ secrets.WECHAT_OPENID }}
      run: |
        echo "ğŸš€ å¼€å§‹æ¯æ—¥è‚¡ç¥¨åˆ†æ..."
        python daily_stock_report.py
        
    - name: ç”Ÿæˆåˆ†ææŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆåˆ†ææŠ¥å‘Š..."
        mkdir -p reports
        echo "# æ¯æ—¥è‚¡ç¥¨åˆ†ææŠ¥å‘Š" > reports/daily_report_$(date +%Y-%m-%d).md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> reports/daily_report_$(date +%Y-%m-%d).md
        echo "åˆ†æçŠ¶æ€: å®Œæˆ" >> reports/daily_report_$(date +%Y-%m-%d).md
        
    - name: æäº¤æŠ¥å‘Šåˆ°ä»“åº“
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add reports/
        git diff --staged --quiet || git commit -m "ğŸ“Š æ¯æ—¥è‚¡ç¥¨åˆ†ææŠ¥å‘Š $(date +%Y-%m-%d)"
        git push
        
    - name: å‘é€é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ è‚¡ç¥¨åˆ†æä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
