name: Daily Stock Analysis and Report

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹è¿è¡Œ (UTCæ—¶é—´22ç‚¹)
    # ç¡®ä¿Aè‚¡æ”¶ç›˜åæ•°æ®å·²æ›´æ–°
    - cron: '0 22 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿æµ‹è¯•
  workflow_dispatch:

jobs:
  analyze-and-report:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºæäº¤
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas sqlite3 fastapi uvicorn
          # å¦‚æœæœ‰requirements.txtæ–‡ä»¶ï¼Œä¹Ÿå®‰è£…å…¶ä¸­çš„ä¾èµ–
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      # 4. å¯åŠ¨AIåˆ†ææœåŠ¡
      - name: Start AI Analysis Service
        run: |
          echo "ğŸš€ å¯åŠ¨AIåˆ†ææœåŠ¡..."
          cd TradingAgents-CN-main
          python simple_api_service.py &
          AI_SERVICE_PID=$!
          echo "AI_SERVICE_PID=$AI_SERVICE_PID" >> $GITHUB_ENV
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…AIæœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸
          curl -f http://localhost:8000/health || exit 1
          echo "âœ… AIæœåŠ¡å¯åŠ¨æˆåŠŸ"
      
      # 5. è¿è¡Œæ¯æ—¥åˆ†æ
      - name: Run Daily Analysis
        run: |
          echo "ğŸ“Š å¼€å§‹æ‰§è¡Œæ¯æ—¥è‚¡ç¥¨åˆ†æ..."
          python daily_analysis.py
          echo "âœ… æ¯æ—¥åˆ†æå®Œæˆ"
      
      # 6. åœæ­¢AIæœåŠ¡
      - name: Stop AI Service
        if: always()
        run: |
          if [ ! -z "$AI_SERVICE_PID" ]; then
            echo "ğŸ›‘ åœæ­¢AIæœåŠ¡..."
            kill $AI_SERVICE_PID || true
          fi
      
      # 7. æäº¤æŠ¥å‘Šåˆ°ä»“åº“
      - name: Commit and Push Report
        run: |
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions-bot@github.com'
          
          # æ·»åŠ ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶
          git add reports/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰æ–°çš„æŠ¥å‘Šéœ€è¦æäº¤"
          else
            # æäº¤å˜åŒ–
            REPORT_DATE=$(date +'%Y-%m-%d')
            git commit -m "ğŸ“ˆ æ¯æ—¥AIåˆ†ææŠ¥å‘Š - $REPORT_DATE

            ğŸ¤– è‡ªåŠ¨ç”Ÿæˆçš„è‚¡ç¥¨åˆ†ææŠ¥å‘Š
            ğŸ“… åˆ†ææ—¥æœŸ: $REPORT_DATE
            ğŸ”§ ç”Ÿæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S UTC')
            
            æœ¬æŠ¥å‘Šç”±TradingAgents-CNå¤šæ™ºèƒ½ä½“ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œ
            åŒ…å«AIå¯¹é‡ç‚¹è‚¡ç¥¨çš„æ·±åº¦åˆ†æå’ŒæŠ•èµ„å»ºè®®ã€‚"
            
            # æ¨é€åˆ°ä»“åº“
            git push
            echo "âœ… æŠ¥å‘Šå·²æäº¤åˆ°ä»“åº“"
          fi
      
      # 8. ç”ŸæˆæŠ¥å‘Šæ‘˜è¦
      - name: Generate Report Summary
        run: |
          echo "ğŸ“‹ ç”ŸæˆæŠ¥å‘Šæ‘˜è¦..."
          REPORT_DATE=$(date +'%Y-%m-%d')
          REPORT_FILE="reports/daily_report_$REPORT_DATE.md"
          
          if [ -f "$REPORT_FILE" ]; then
            echo "## ğŸ“Š ä»Šæ—¥åˆ†ææŠ¥å‘Šæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**åˆ†ææ—¥æœŸï¼š** $REPORT_DATE" >> $GITHUB_STEP_SUMMARY
            echo "**ç”Ÿæˆæ—¶é—´ï¼š** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # æå–æŠ¥å‘Šçš„å‰å‡ è¡Œä½œä¸ºæ‘˜è¦
            head -20 "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“– [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š]($REPORT_FILE)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ æŠ¥å‘Šæ–‡ä»¶æœªæ‰¾åˆ°" >> $GITHUB_STEP_SUMMARY
          fi
      
      # 9. ä¸Šä¼ æŠ¥å‘Šä½œä¸ºæ„å»ºäº§ç‰©
      - name: Upload Report as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: daily-analysis-report
          path: reports/
          retention-days: 30

  # å¯é€‰ï¼šæ¨é€åˆ°å¾®ä¿¡å…¬ä¼—å·
  push-to-wechat:
    needs: analyze-and-report
    runs-on: ubuntu-latest
    if: success() && github.event_name == 'schedule'  # åªåœ¨å®šæ—¶ä»»åŠ¡æˆåŠŸæ—¶è¿è¡Œ
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: main  # ç¡®ä¿è·å–æœ€æ–°çš„æŠ¥å‘Š
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install WeChat Dependencies
        run: |
          pip install wechatpy requests
      
      - name: Push to WeChat Official Account
        env:
          WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
          WECHAT_APP_SECRET: ${{ secrets.WECHAT_APP_SECRET }}
        run: |
          if [ -z "$WECHAT_APP_ID" ] || [ -z "$WECHAT_APP_SECRET" ]; then
            echo "âš ï¸ å¾®ä¿¡å…¬ä¼—å·å¯†é’¥æœªé…ç½®ï¼Œè·³è¿‡æ¨é€"
            exit 0
          fi
          
          echo "ğŸ“± å¼€å§‹æ¨é€åˆ°å¾®ä¿¡å…¬ä¼—å·..."
          python scripts/push_to_wechat.py
          echo "âœ… å¾®ä¿¡å…¬ä¼—å·æ¨é€å®Œæˆ"
