# 利润表数据获取程序使用说明

## 程序概述

本目录包含两个用于获取股票利润表数据的Python程序：

1. `income_statement.py` - 批量获取所有股票的利润表数据
2. `income_statement_test.py` - 测试单个股票的利润表数据获取

## 功能特点

- **数据来源**: 使用Tushare Pro API获取利润表数据
- **数据范围**: 2020年1月1日至2025年4月30日
- **数据字段**: 包含完整的利润表字段（共85个字段）
- **数据存储**: 自动创建MySQL数据表并存储数据
- **错误处理**: 包含完善的异常处理机制
- **API限制**: 内置API调用频率控制

## 数据表结构

程序会自动创建 `stock_income_statement` 表，包含以下主要字段：

### 基本信息
- `ts_code`: 股票代码
- `ann_date`: 公告日期
- `f_ann_date`: 实际公告日期
- `end_date`: 报告期
- `report_type`: 报告类型
- `comp_type`: 公司类型

### 核心财务指标
- `basic_eps`: 基本每股收益
- `diluted_eps`: 稀释每股收益
- `total_revenue`: 营业总收入
- `revenue`: 营业收入
- `total_cogs`: 营业总成本
- `oper_cost`: 营业成本
- `operate_profit`: 营业利润
- `total_profit`: 利润总额
- `n_income`: 净利润
- `n_income_attr_p`: 归属于母公司所有者的净利润

### 详细收入项目
- `int_income`: 利息收入
- `prem_earned`: 已赚保费
- `comm_income`: 手续费及佣金收入
- `invest_income`: 投资净收益
- `fv_value_chg_gain`: 公允价值变动净收益

### 详细成本费用项目
- `sell_exp`: 销售费用
- `admin_exp`: 管理费用
- `fin_exp`: 财务费用
- `rd_exp`: 研发费用
- `assets_impair_loss`: 资产减值损失

### 其他重要指标
- `ebit`: 息税前利润
- `ebitda`: 息税折旧摊销前利润
- `minority_gain`: 少数股东损益
- `oth_compr_income`: 其他综合收益

## 使用方法

### 1. 测试程序（推荐先运行）

```bash
cd /Users/henrylin/PycharmProjects/stock/tushare_pl/local
python income_statement_test.py
```

这个程序会：
- 获取单个测试股票（300474.SZ）的利润表数据
- 显示数据预览和主要财务指标
- 验证API连接和数据格式

### 2. 批量获取程序

```bash
cd /Users/henrylin/PycharmProjects/stock/tushare_pl/local
python income_statement.py
```

这个程序会：
- 从数据库获取所有股票代码
- 批量调用Tushare API获取利润表数据
- 自动创建数据表并存储数据
- 显示处理进度和统计信息

## 程序特性

### API频率控制
- 单次调用间隔：0.2秒
- 批次间隔：1秒
- 批次大小：50只股票

### 错误处理
- 自动跳过无数据的股票
- 记录处理失败的股票数量
- 显示详细的错误信息

### 数据完整性
- 使用 `INSERT IGNORE` 避免重复数据
- 自动处理NaN值
- 保持数据类型一致性

## 注意事项

1. **API权限**: 确保Tushare API token有足够的权限访问利润表数据
2. **数据库连接**: 确保MySQL数据库连接正常
3. **存储空间**: 利润表数据量较大，确保有足够的存储空间
4. **运行时间**: 批量获取可能需要较长时间，建议在网络稳定时运行
5. **数据更新**: 建议定期运行以获取最新的财务数据

## 数据应用

获取的利润表数据可用于：

1. **基本面分析**: 分析公司盈利能力和成长性
2. **财务比率计算**: 计算各种财务比率指标
3. **行业对比**: 进行同行业公司财务对比
4. **趋势分析**: 分析财务指标的历史趋势
5. **量化策略**: 构建基于财务数据的量化投资策略

## 故障排除

### 常见问题

1. **API调用失败**
   - 检查网络连接
   - 验证API token是否有效
   - 确认API调用频率是否超限

2. **数据库连接失败**
   - 检查数据库服务是否启动
   - 验证连接参数是否正确
   - 确认数据库权限是否足够

3. **数据插入失败**
   - 检查数据表是否存在
   - 验证数据格式是否正确
   - 确认字段长度是否足够

### 日志信息

程序会输出详细的处理日志：
- 处理进度
- 成功/失败统计
- 错误详情
- 数据预览

## 扩展功能

可以根据需要扩展以下功能：

1. **增量更新**: 只获取新增或更新的数据
2. **数据验证**: 添加数据质量检查
3. **并行处理**: 使用多线程提高处理速度
4. **数据导出**: 支持导出为Excel或CSV格式
5. **可视化**: 添加财务数据图表展示 