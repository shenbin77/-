# 现金流量表数据获取程序使用说明

## 程序概述

本目录包含两个用于获取股票现金流量表数据的Python程序：

1. `cash_flow.py` - 批量获取所有股票的现金流量表数据
2. `cash_flow_test.py` - 测试单个股票的现金流量表数据获取

## 功能特点

- **数据来源**: 使用Tushare Pro API获取现金流量表数据
- **数据范围**: 2020年1月1日至2025年4月30日
- **数据字段**: 包含完整的现金流量表字段（共91个字段）
- **数据存储**: 自动创建MySQL数据表并存储数据
- **错误处理**: 包含完善的异常处理机制
- **API限制**: 内置API调用频率控制

## 数据表结构

程序会自动创建 `stock_cash_flow` 表，包含以下主要字段：

### 基本信息
- `ts_code`: 股票代码
- `ann_date`: 公告日期
- `f_ann_date`: 实际公告日期
- `end_date`: 报告期
- `comp_type`: 公司类型
- `report_type`: 报告类型
- `end_type`: 报告期类型

### 经营活动现金流量

#### 现金流入
- `c_fr_sale_sg`: 销售商品、提供劳务收到的现金
- `recp_tax_rends`: 收到的税费返还
- `c_fr_oth_operate_a`: 收到其他与经营活动有关的现金
- `c_inf_fr_operate_a`: 经营活动现金流入小计

#### 现金流出
- `c_paid_goods_s`: 购买商品、接受劳务支付的现金
- `c_paid_to_for_empl`: 支付给职工以及为职工支付的现金
- `c_paid_for_taxes`: 支付的各项税费
- `oth_cash_pay_oper_act`: 支付其他与经营活动有关的现金
- `st_cash_out_act`: 经营活动现金流出小计

#### 经营活动净现金流
- `n_cashflow_act`: 经营活动产生的现金流量净额
- `im_net_cashflow_oper_act`: 经营活动产生的现金流量净额(间接法)

### 投资活动现金流量

#### 现金流入
- `c_disp_withdrwl_invest`: 收回投资收到的现金
- `c_recp_return_invest`: 取得投资收益收到的现金
- `n_recp_disp_fiolta`: 处置固定资产无形资产和其他长期资产收回的现金净额
- `n_recp_disp_sobu`: 处置子公司及其他营业单位收到的现金净额
- `oth_recp_ral_inv_act`: 收到其他与投资活动有关的现金
- `stot_inflows_inv_act`: 投资活动现金流入小计

#### 现金流出
- `c_pay_acq_const_fiolta`: 购建固定资产无形资产和其他长期资产支付的现金
- `c_paid_invest`: 投资支付的现金
- `n_disp_subs_oth_biz`: 取得子公司及其他营业单位支付的现金净额
- `oth_pay_ral_inv_act`: 支付其他与投资活动有关的现金
- `stot_out_inv_act`: 投资活动现金流出小计

#### 投资活动净现金流
- `n_cashflow_inv_act`: 投资活动产生的现金流量净额

### 筹资活动现金流量

#### 现金流入
- `c_recp_cap_contrib`: 吸收投资收到的现金
- `incl_cash_rec_saims`: 其中:子公司吸收少数股东投资收到的现金
- `c_recp_borrow`: 取得借款收到的现金
- `proc_issue_bonds`: 发行债券收到的现金
- `oth_cash_recp_ral_fnc_act`: 收到其他与筹资活动有关的现金
- `stot_cash_in_fnc_act`: 筹资活动现金流入小计

#### 现金流出
- `c_prepay_amt_borr`: 偿还债务支付的现金
- `c_pay_dist_dpcp_int_exp`: 分配股利、利润或偿付利息支付的现金
- `incl_dvd_profit_paid_sc_ms`: 其中:子公司支付给少数股东的股利、利润
- `oth_cashpay_ral_fnc_act`: 支付其他与筹资活动有关的现金
- `stot_cashout_fnc_act`: 筹资活动现金流出小计

#### 筹资活动净现金流
- `n_cash_flows_fnc_act`: 筹资活动产生的现金流量净额

### 现金及现金等价物

#### 汇率影响和净增加额
- `eff_fx_flu_cash`: 汇率变动对现金的影响
- `n_incr_cash_cash_equ`: 现金及现金等价物净增加额
- `im_n_incr_cash_equ`: 现金及现金等价物净增加额(间接法)

#### 期初期末余额
- `c_cash_equ_beg_period`: 期初现金及现金等价物余额
- `c_cash_equ_end_period`: 期末现金及现金等价物余额
- `beg_bal_cash`: 现金的期初余额
- `end_bal_cash`: 现金的期末余额
- `beg_bal_cash_equ`: 现金等价物的期初余额
- `end_bal_cash_equ`: 现金等价物的期末余额

### 重要财务指标
- `net_profit`: 净利润
- `free_cashflow`: 企业自由现金流量
- `finan_exp`: 财务费用

### 间接法补充信息
- `prov_depr_assets`: 加:资产减值准备
- `depr_fa_coga_dpba`: 固定资产折旧、油气资产折耗、生产性生物资产折旧
- `amort_intang_assets`: 无形资产摊销
- `lt_amort_deferred_exp`: 长期待摊费用摊销
- `credit_impa_loss`: 信用减值损失
- `use_right_asset_dep`: 使用权资产折旧

### 金融行业特有科目
- `n_depos_incr_fi`: 客户存款和同业存放款项净增加额
- `n_incr_loans_cb`: 向中央银行借款净增加额
- `n_inc_borr_oth_fi`: 向其他金融机构拆入资金净增加额
- `n_incr_clt_loan_adv`: 客户贷款及垫款净增加额
- `ifc_cash_incr`: 收取利息和手续费净增加额

### 保险行业特有科目
- `prem_fr_orig_contr`: 收到原保险合同保费取得的现金
- `n_incr_insured_dep`: 保户储金净增加额
- `n_reinsur_prem`: 收到再保业务现金净额
- `c_pay_claims_orig_inco`: 支付原保险合同赔付款项的现金
- `pay_comm_insur_plcy`: 支付保单红利的现金

## 使用方法

### 1. 测试程序（推荐先运行）

```bash
cd /Users/henrylin/PycharmProjects/stock/tushare_pl/local
python cash_flow_test.py
```

这个程序会：
- 获取单个测试股票（300474.SZ）的现金流量表数据
- 显示详细的现金流量分析
- 计算现金流量比率和结构分析
- 验证API连接和数据格式

### 2. 批量获取程序

```bash
cd /Users/henrylin/PycharmProjects/stock/tushare_pl/local
python cash_flow.py
```

这个程序会：
- 从数据库获取所有股票代码
- 批量调用Tushare API获取现金流量表数据
- 自动创建数据表并存储数据
- 显示处理进度和统计信息

## 程序特性

### API频率控制
- 单次调用间隔：0.2秒
- 批次间隔：3.3秒
- 批次大小：50只股票

### 错误处理
- 自动跳过无数据的股票
- 记录处理失败的股票数量
- 显示详细的错误信息

### 数据完整性
- 使用 `INSERT IGNORE` 避免重复数据
- 自动处理NaN值
- 保持数据类型一致性

## 现金流量分析应用

### 现金流量质量分析

#### 经营现金流量质量
- **经营现金流量与净利润比率** = 经营活动现金流量净额 / 净利润
  - 比率 > 1：现金流量质量较好
  - 比率 < 1：可能存在应收账款增加或盈利质量问题

#### 现金流量充足性
- **自由现金流量** = 经营活动现金流量净额 - 资本支出
- **现金流量对资本支出覆盖率** = 经营活动现金流量净额 / 购建固定资产支付的现金

### 现金流量结构分析

#### 现金流入结构
- **经营活动现金流入占比** = 经营活动现金流入 / 总现金流入
- **投资活动现金流入占比** = 投资活动现金流入 / 总现金流入
- **筹资活动现金流入占比** = 筹资活动现金流入 / 总现金流入

#### 现金流量模式识别
1. **成长型企业**：经营现金流为正，投资现金流为负，筹资现金流为正
2. **成熟型企业**：经营现金流为正，投资现金流为负，筹资现金流为负
3. **衰退型企业**：经营现金流为负，投资现金流为正，筹资现金流可正可负

### 偿债能力分析
- **现金流量利息保障倍数** = (经营活动现金流量净额 + 利息支出) / 利息支出
- **现金流量债务比** = 经营活动现金流量净额 / 总负债
- **现金比率** = 现金及现金等价物 / 流动负债

### 投资价值分析
- **现金流量市盈率** = 市值 / 经营活动现金流量净额
- **企业价值倍数** = 企业价值 / 自由现金流量
- **现金流量增长率** = (本期现金流量 - 上期现金流量) / 上期现金流量

## 注意事项

1. **API权限**: 确保Tushare API token有足够的权限访问现金流量表数据
2. **数据库连接**: 确保MySQL数据库连接正常
3. **存储空间**: 现金流量表数据量较大，确保有足够的存储空间
4. **运行时间**: 批量获取可能需要较长时间，建议在网络稳定时运行
5. **数据更新**: 建议定期运行以获取最新的财务数据
6. **行业差异**: 不同行业的现金流量表科目可能有所差异

## 数据应用场景

### 1. 基本面分析
- 分析公司现金流量质量和可持续性
- 评估公司资金管理能力
- 研究公司投资和筹资策略

### 2. 财务风险评估
- 识别现金流量风险
- 评估短期偿债能力
- 分析资金链安全性

### 3. 投资决策支持
- 价值投资策略构建
- 现金流量折现模型
- 股息支付能力分析

### 4. 行业对比研究
- 同行业现金流量模式对比
- 行业资金使用效率分析
- 识别行业龙头企业

### 5. 量化策略开发
- 基于现金流量的选股策略
- 现金流量异常检测
- 多因子模型构建

## 故障排除

### 常见问题

1. **API调用失败**
   - 检查网络连接
   - 验证API token是否有效
   - 确认API调用频率是否超限

2. **数据库连接失败**
   - 检查数据库服务是否启动
   - 验证连接参数是否正确
   - 确认数据库权限是否足够

3. **数据插入失败**
   - 检查数据表是否存在
   - 验证数据格式是否正确
   - 确认字段长度是否足够

### 性能优化建议

1. **批量处理**: 合理设置批次大小
2. **索引优化**: 为常用查询字段添加索引
3. **数据压缩**: 考虑使用数据压缩减少存储空间
4. **定期清理**: 清理过期或无效数据

## 扩展功能

可以根据需要扩展以下功能：

1. **增量更新**: 只获取新增或更新的数据
2. **数据验证**: 添加现金流量表平衡性检查
3. **比率计算**: 自动计算常用现金流量比率
4. **趋势分析**: 添加现金流量趋势图表
5. **异常检测**: 识别异常的现金流量数据
6. **报告生成**: 自动生成现金流量分析报告

## 现金流量表分析要点

### 经营活动现金流量分析
1. **持续性**: 经营现金流应该持续为正
2. **稳定性**: 现金流波动不应过大
3. **匹配性**: 与营业收入和净利润应该匹配

### 投资活动现金流量分析
1. **资本支出**: 关注固定资产投资规模
2. **投资收益**: 分析投资活动的回报
3. **资产处置**: 关注非核心资产处置情况

### 筹资活动现金流量分析
1. **融资结构**: 分析债务和股权融资比例
2. **偿债能力**: 关注债务偿还情况
3. **股东回报**: 分析分红和回购政策

### 现金管理分析
1. **现金充足性**: 现金余额是否充足
2. **现金使用效率**: 现金是否得到有效利用
3. **资金周转**: 分析资金周转效率 