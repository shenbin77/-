{% extends "base.html" %}

{% block title %}é€‰è‚¡ç­›é€‰ - è‚¡ç¥¨åˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">ğŸ¯ é€‰è‚¡ç­›é€‰</h1>
            <p class="text-muted">åŸºäºè‚¡ç¥¨ä¸šåŠ¡å¤§å®½è¡¨çš„å¤šç»´åº¦æ¡ä»¶ç­›é€‰ï¼Œå‘ç°æŠ•èµ„æœºä¼š</p>
        </div>
    </div>

    <!-- ç­›é€‰æ¡ä»¶ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ç­›é€‰æ¡ä»¶</h5>
                </div>
                <div class="card-body">
                    <form id="screen-form">
                        <!-- åŸºæœ¬æ¡ä»¶ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">ğŸ“Š åŸºæœ¬æ¡ä»¶</h6>
                            </div>
                            <div class="col-md-3">
                                <label for="industry-filter" class="form-label">è¡Œä¸š</label>
                                <select class="form-select" id="industry-filter">
                                    <option value="">å…¨éƒ¨è¡Œä¸š</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="area-filter" class="form-label">åœ°åŸŸ</label>
                                <select class="form-select" id="area-filter">
                                    <option value="">å…¨éƒ¨åœ°åŸŸ</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="market-filter" class="form-label">å¸‚åœº</label>
                                <select class="form-select" id="market-filter">
                                    <option value="">å…¨éƒ¨å¸‚åœº</option>
                                    <option value="SZ">æ·±åœ³</option>
                                    <option value="SH">ä¸Šæµ·</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="date-filter" class="form-label">æ•°æ®æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="date-filter" title="é€‰æ‹©ç‰¹å®šæ—¥æœŸçš„æ•°æ®ï¼Œç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–°æ•°æ®">
                            </div>
                        </div>

                        <!-- ä¼°å€¼æŒ‡æ ‡ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">ğŸ’° ä¼°å€¼æŒ‡æ ‡</h6>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å¸‚ç›ˆç‡(PE)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="pe-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="pe-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å¸‚å‡€ç‡(PB)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="pb-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="pb-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å¸‚é”€ç‡(PS)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="ps-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="ps-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">è‚¡æ¯ç‡(%)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="dv-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="dv-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å¸‚å€¼å’Œäº¤æ˜“æŒ‡æ ‡ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">ğŸ“ˆ å¸‚å€¼ä¸äº¤æ˜“</h6>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">æ€»å¸‚å€¼(ä¸‡å…ƒ)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="mv-min" placeholder="æœ€å°å€¼">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="mv-max" placeholder="æœ€å¤§å€¼">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">æµé€šå¸‚å€¼(ä¸‡å…ƒ)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="circ-mv-min" placeholder="æœ€å°å€¼">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="circ-mv-max" placeholder="æœ€å¤§å€¼">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">æ¢æ‰‹ç‡(%)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="turnover-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="turnover-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">é‡æ¯”</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="volume-ratio-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="volume-ratio-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æŠ€æœ¯æŒ‡æ ‡ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">ğŸ“Š æŠ€æœ¯æŒ‡æ ‡</h6>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">RSI(6æ—¥)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="rsi6-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="rsi6-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">KDJ-Kå€¼</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="kdj-k-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="kdj-k-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">MACD</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="macd-min" placeholder="æœ€å°å€¼" step="0.01">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="macd-max" placeholder="æœ€å¤§å€¼" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CCIæŒ‡æ ‡</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="cci-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="cci-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- èµ„é‡‘æµå‘ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">ğŸ’¸ èµ„é‡‘æµå‘</h6>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">å‡€æµå…¥é¢(ä¸‡å…ƒ)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="net-amount-min" placeholder="æœ€å°å€¼">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="net-amount-max" placeholder="æœ€å¤§å€¼">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">å¤§å•ä¹°å…¥å æ¯”(%)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="lg-buy-rate-min" placeholder="æœ€å°å€¼" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="lg-buy-rate-max" placeholder="æœ€å¤§å€¼" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">5æ—¥å‡€æµå…¥é¢(ä¸‡å…ƒ)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="net-d5-amount-min" placeholder="æœ€å°å€¼">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="net-d5-amount-max" placeholder="æœ€å¤§å€¼">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åŠ¨æ€æŸ¥è¯¢æ¡ä»¶ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">ğŸ”§ åŠ¨æ€æŸ¥è¯¢æ¡ä»¶</h6>
                                <p class="text-muted small">æ”¯æŒå­—æ®µé—´æ¯”è¾ƒï¼Œå¦‚ï¼šMA5 > MA10ï¼ŒPE < PBç­‰</p>
                            </div>
                            <div id="dynamic-conditions">
                                <!-- åŠ¨æ€æ¡ä»¶å°†åœ¨è¿™é‡Œæ·»åŠ  -->
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="add-condition">
                                    <i class="fas fa-plus"></i> æ·»åŠ æ¡ä»¶
                                </button>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search"></i> å¼€å§‹ç­›é€‰
                                </button>
                                <button type="button" class="btn btn-secondary me-2" id="reset-screen">
                                    <i class="fas fa-undo"></i> é‡ç½®æ¡ä»¶
                                </button>
                                <button type="button" class="btn btn-info me-2" id="save-template">
                                    <i class="fas fa-save"></i> ä¿å­˜æ¨¡æ¿
                                </button>
                                <button type="button" class="btn btn-outline-info" id="load-template">
                                    <i class="fas fa-folder-open"></i> åŠ è½½æ¨¡æ¿
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­›é€‰ç»“æœ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ç­›é€‰ç»“æœ</h5>
                    <div>
                        <span class="badge bg-primary me-2" id="result-count">0</span>
                        <button class="btn btn-sm btn-outline-success" id="export-results" style="display: none;">
                            <i class="fas fa-download"></i> å¯¼å‡º
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="screen-results">
                        <div class="text-center py-5">
                            <p class="text-muted">è¯·è®¾ç½®ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»"å¼€å§‹ç­›é€‰"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€å˜é‡
let dynamicConditionCount = 0;
let currentResults = [];

// å¯ç”¨å­—æ®µå®šä¹‰
const AVAILABLE_FIELDS = {
    'åŸºæœ¬ä¿¡æ¯': {
        'daily_close': 'æ”¶ç›˜ä»·',
        'factor_change': 'æ¶¨è·Œé¢',
        'factor_pct_change': 'æ¶¨è·Œå¹…(%)'
    },
    'ä¼°å€¼æŒ‡æ ‡': {
        'pe': 'å¸‚ç›ˆç‡(PE)',
        'pe_ttm': 'å¸‚ç›ˆç‡(TTM)',
        'pb': 'å¸‚å‡€ç‡(PB)',
        'ps': 'å¸‚é”€ç‡(PS)',
        'ps_ttm': 'å¸‚é”€ç‡(TTM)',
        'dv_ratio': 'è‚¡æ¯ç‡(%)',
        'dv_ttm': 'è‚¡æ¯ç‡(TTM)(%)'
    },
    'å¸‚å€¼äº¤æ˜“': {
        'total_mv': 'æ€»å¸‚å€¼(ä¸‡)',
        'circ_mv': 'æµé€šå¸‚å€¼(ä¸‡)',
        'turnover_rate': 'æ¢æ‰‹ç‡(%)',
        'turnover_rate_f': 'æ¢æ‰‹ç‡(è‡ªç”±æµé€š)',
        'volume_ratio': 'é‡æ¯”',
        'factor_vol': 'æˆäº¤é‡',
        'factor_amount': 'æˆäº¤é¢'
    },
    'æŠ€æœ¯æŒ‡æ ‡': {
        'factor_macd_dif': 'MACD DIF',
        'factor_macd_dea': 'MACD DEA',
        'factor_macd': 'MACD',
        'factor_kdj_k': 'KDJ Kå€¼',
        'factor_kdj_d': 'KDJ Då€¼',
        'factor_kdj_j': 'KDJ Jå€¼',
        'factor_rsi_6': 'RSI(6æ—¥)',
        'factor_rsi_12': 'RSI(12æ—¥)',
        'factor_rsi_24': 'RSI(24æ—¥)',
        'factor_boll_upper': 'å¸ƒæ—ä¸Šè½¨',
        'factor_boll_mid': 'å¸ƒæ—ä¸­è½¨',
        'factor_boll_lower': 'å¸ƒæ—ä¸‹è½¨',
        'factor_cci': 'CCIæŒ‡æ ‡'
    },
    'å‡çº¿æŒ‡æ ‡': {
        'ma5': 'MA5',
        'ma10': 'MA10',
        'ma20': 'MA20',
        'ma30': 'MA30',
        'ma60': 'MA60',
        'ma120': 'MA120'
    },
    'èµ„é‡‘æµå‘': {
        'moneyflow_net_amount': 'å‡€æµå…¥é¢',
        'moneyflow_net_d5_amount': '5æ—¥å‡€æµå…¥é¢',
        'moneyflow_buy_lg_amount': 'å¤§å•ä¹°å…¥é¢',
        'moneyflow_buy_lg_amount_rate': 'å¤§å•ä¹°å…¥å æ¯”(%)',
        'moneyflow_buy_md_amount': 'ä¸­å•ä¹°å…¥é¢',
        'moneyflow_buy_md_amount_rate': 'ä¸­å•ä¹°å…¥å æ¯”(%)',
        'moneyflow_buy_sm_amount': 'å°å•ä¹°å…¥é¢',
        'moneyflow_buy_sm_amount_rate': 'å°å•ä¹°å…¥å æ¯”(%)'
    }
};

// æ“ä½œç¬¦å®šä¹‰
const OPERATORS = {
    '>': 'å¤§äº',
    '>=': 'å¤§äºç­‰äº',
    '<': 'å°äº',
    '<=': 'å°äºç­‰äº',
    '=': 'ç­‰äº',
    '!=': 'ä¸ç­‰äº'
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadFilterOptions();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('screen-form').addEventListener('submit', handleScreen);
    document.getElementById('reset-screen').addEventListener('click', resetScreen);
    document.getElementById('add-condition').addEventListener('click', addDynamicCondition);
    document.getElementById('save-template').addEventListener('click', saveTemplate);
    document.getElementById('load-template').addEventListener('click', loadTemplate);
    document.getElementById('export-results').addEventListener('click', exportResults);
});

// åŠ è½½ç­›é€‰é€‰é¡¹
async function loadFilterOptions() {
    try {
        // åŠ è½½è¡Œä¸šåˆ—è¡¨
        const industriesResponse = await apiRequest('/industries');
        if (industriesResponse.code === 200) {
            const select = document.getElementById('industry-filter');
            industriesResponse.data.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                select.appendChild(option);
            });
        }

        // åŠ è½½åœ°åŸŸåˆ—è¡¨
        const areasResponse = await apiRequest('/areas');
        if (areasResponse.code === 200) {
            const select = document.getElementById('area-filter');
            areasResponse.data.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
    }
}

// æ·»åŠ åŠ¨æ€æŸ¥è¯¢æ¡ä»¶
function addDynamicCondition() {
    dynamicConditionCount++;
    const container = document.getElementById('dynamic-conditions');
    
    const conditionDiv = document.createElement('div');
    conditionDiv.className = 'col-12 mb-3';
    conditionDiv.id = `condition-${dynamicConditionCount}`;
    
    conditionDiv.innerHTML = `
        <div class="card border-light">
            <div class="card-body py-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="field-a-${dynamicConditionCount}">
                            <option value="">é€‰æ‹©å­—æ®µA</option>
                            ${generateFieldOptions()}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="operator-${dynamicConditionCount}">
                            ${Object.entries(OPERATORS).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="field-b-${dynamicConditionCount}">
                            <option value="">é€‰æ‹©å­—æ®µB</option>
                            <option value="__value__">å›ºå®šæ•°å€¼</option>
                            ${generateFieldOptions()}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control form-control-sm" id="value-${dynamicConditionCount}" 
                               placeholder="æ•°å€¼" step="0.01" style="display: none;">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="removeDynamicCondition(${dynamicConditionCount})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(conditionDiv);
    
    // ç»‘å®šå­—æ®µBå˜åŒ–äº‹ä»¶
    document.getElementById(`field-b-${dynamicConditionCount}`).addEventListener('change', function() {
        const valueInput = document.getElementById(`value-${dynamicConditionCount}`);
        if (this.value === '__value__') {
            valueInput.style.display = 'block';
            valueInput.required = true;
        } else {
            valueInput.style.display = 'none';
            valueInput.required = false;
            valueInput.value = '';
        }
    });
}

// ç”Ÿæˆå­—æ®µé€‰é¡¹HTML
function generateFieldOptions() {
    let html = '';
    for (const [category, fields] of Object.entries(AVAILABLE_FIELDS)) {
        html += `<optgroup label="${category}">`;
        for (const [key, label] of Object.entries(fields)) {
            html += `<option value="${key}">${label}</option>`;
        }
        html += '</optgroup>';
    }
    return html;
}

// ç§»é™¤åŠ¨æ€æŸ¥è¯¢æ¡ä»¶
function removeDynamicCondition(id) {
    const element = document.getElementById(`condition-${id}`);
    if (element) {
        element.remove();
    }
}

// å¤„ç†ç­›é€‰
function handleScreen(event) {
    event.preventDefault();
    
    // æ”¶é›†åŸºç¡€ç­›é€‰æ¡ä»¶
    const criteria = {
        // åŸºæœ¬æ¡ä»¶
        industry: document.getElementById('industry-filter').value,
        area: document.getElementById('area-filter').value,
        market: document.getElementById('market-filter').value,
        trade_date: document.getElementById('date-filter').value,
        
        // ä¼°å€¼æŒ‡æ ‡
        pe_min: document.getElementById('pe-min').value,
        pe_max: document.getElementById('pe-max').value,
        pb_min: document.getElementById('pb-min').value,
        pb_max: document.getElementById('pb-max').value,
        ps_min: document.getElementById('ps-min').value,
        ps_max: document.getElementById('ps-max').value,
        dv_min: document.getElementById('dv-min').value,
        dv_max: document.getElementById('dv-max').value,
        
        // å¸‚å€¼å’Œäº¤æ˜“
        mv_min: document.getElementById('mv-min').value,
        mv_max: document.getElementById('mv-max').value,
        circ_mv_min: document.getElementById('circ-mv-min').value,
        circ_mv_max: document.getElementById('circ-mv-max').value,
        turnover_min: document.getElementById('turnover-min').value,
        turnover_max: document.getElementById('turnover-max').value,
        volume_ratio_min: document.getElementById('volume-ratio-min').value,
        volume_ratio_max: document.getElementById('volume-ratio-max').value,
        
        // æŠ€æœ¯æŒ‡æ ‡
        rsi6_min: document.getElementById('rsi6-min').value,
        rsi6_max: document.getElementById('rsi6-max').value,
        kdj_k_min: document.getElementById('kdj-k-min').value,
        kdj_k_max: document.getElementById('kdj-k-max').value,
        macd_min: document.getElementById('macd-min').value,
        macd_max: document.getElementById('macd-max').value,
        cci_min: document.getElementById('cci-min').value,
        cci_max: document.getElementById('cci-max').value,
        
        // èµ„é‡‘æµå‘
        net_amount_min: document.getElementById('net-amount-min').value,
        net_amount_max: document.getElementById('net-amount-max').value,
        lg_buy_rate_min: document.getElementById('lg-buy-rate-min').value,
        lg_buy_rate_max: document.getElementById('lg-buy-rate-max').value,
        net_d5_amount_min: document.getElementById('net-d5-amount-min').value,
        net_d5_amount_max: document.getElementById('net-d5-amount-max').value
    };
    
    // æ”¶é›†åŠ¨æ€æŸ¥è¯¢æ¡ä»¶
    const dynamicConditions = [];
    for (let i = 1; i <= dynamicConditionCount; i++) {
        const fieldA = document.getElementById(`field-a-${i}`);
        const operator = document.getElementById(`operator-${i}`);
        const fieldB = document.getElementById(`field-b-${i}`);
        const value = document.getElementById(`value-${i}`);
        
        if (fieldA && fieldA.value && operator && operator.value && fieldB && fieldB.value) {
            const condition = {
                field_a: fieldA.value,
                operator: operator.value,
                field_b: fieldB.value === '__value__' ? null : fieldB.value,
                value: fieldB.value === '__value__' ? value.value : null
            };
            
            // éªŒè¯æ¡ä»¶å®Œæ•´æ€§
            if (condition.field_b || condition.value) {
                dynamicConditions.push(condition);
            }
        }
    }
    
    criteria.dynamic_conditions = dynamicConditions;
    
    performScreen(criteria);
}

// æ‰§è¡Œç­›é€‰
async function performScreen(criteria) {
    showLoading('screen-results');
    
    try {
        console.log('å‘é€ç­›é€‰è¯·æ±‚:', criteria);
        
        // è°ƒç”¨å¢å¼ºçš„ç­›é€‰API
        const response = await apiRequest('/analysis/screen', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            data: criteria
        });
        
        console.log('ç­›é€‰å“åº”:', response);
        
        if (response.code === 200) {
            currentResults = response.data.stocks;
            renderScreenResults(response.data.stocks, criteria);
            document.getElementById('result-count').textContent = response.data.total;
            
            // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
            if (response.data.stocks.length > 0) {
                document.getElementById('export-results').style.display = 'inline-block';
            }
            
            // æ˜¾ç¤ºæ˜¯å¦æœ‰æ›´å¤šç»“æœ
            if (response.data.has_more) {
                showMoreResultsHint();
            }
        } else {
            showError('screen-results', response.message || 'ç­›é€‰å¤±è´¥');
        }
    } catch (error) {
        showError('screen-results', 'ç­›é€‰å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        console.error('ç­›é€‰å¤±è´¥:', error);
    }
}

// æ¸²æŸ“ç­›é€‰ç»“æœ
function renderScreenResults(stocks, criteria) {
    const container = document.getElementById('screen-results');
    
    if (stocks.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</p></div>';
        return;
    }
    
    const html = `
        <div class="mb-3">
            <small class="text-muted">ç­›é€‰æ¡ä»¶ï¼š${formatCriteria(criteria)}</small>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead class="table-light">
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>è‚¡ç¥¨åç§°</th>
                        <th>è¡Œä¸š</th>
                        <th>åœ°åŸŸ</th>
                        <th>æ”¶ç›˜ä»·</th>
                        <th>æ¶¨è·Œå¹…(%)</th>
                        <th>PE</th>
                        <th>PB</th>
                        <th>æ€»å¸‚å€¼(ä¸‡)</th>
                        <th>æ¢æ‰‹ç‡(%)</th>
                        <th>å‡€æµå…¥(ä¸‡)</th>
                        <th>æ•°æ®æ—¥æœŸ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${stocks.map(stock => `
                        <tr>
                            <td><code>${stock.symbol || stock.ts_code}</code></td>
                            <td><strong>${stock.stock_name || stock.name}</strong></td>
                            <td><span class="badge bg-secondary">${stock.industry || '--'}</span></td>
                            <td>${stock.area || '--'}</td>
                            <td class="text-end">${stock.daily_close ? formatNumber(stock.daily_close, 2) : '--'}</td>
                            <td class="text-end ${getChangeClass(stock.factor_pct_change)}">
                                ${stock.factor_pct_change ? formatNumber(stock.factor_pct_change, 2) + '%' : '--'}
                            </td>
                            <td class="text-end">${stock.pe ? formatNumber(stock.pe, 2) : '--'}</td>
                            <td class="text-end">${stock.pb ? formatNumber(stock.pb, 2) : '--'}</td>
                            <td class="text-end">${stock.total_mv ? formatNumber(stock.total_mv, 0) : '--'}</td>
                            <td class="text-end">${stock.turnover_rate ? formatNumber(stock.turnover_rate, 2) : '--'}</td>
                            <td class="text-end ${getChangeClass(stock.moneyflow_net_amount)}">
                                ${stock.moneyflow_net_amount ? formatNumber(stock.moneyflow_net_amount, 0) : '--'}
                            </td>
                            <td>${stock.trade_date || '--'}</td>
                            <td>
                                <a href="/stock/${stock.ts_code}" class="btn btn-sm btn-primary" target="_blank">è¯¦æƒ…</a>
                                <button class="btn btn-sm btn-outline-success ms-1" onclick="addToAnalysis('${stock.ts_code}')">åˆ†æ</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// è·å–æ¶¨è·Œé¢œè‰²ç±»
function getChangeClass(value) {
    if (!value) return '';
    return parseFloat(value) >= 0 ? 'text-success' : 'text-danger';
}

// æ ¼å¼åŒ–ç­›é€‰æ¡ä»¶
function formatCriteria(criteria) {
    const conditions = [];
    
    // åŸºæœ¬æ¡ä»¶
    if (criteria.industry) conditions.push(`è¡Œä¸š=${criteria.industry}`);
    if (criteria.area) conditions.push(`åœ°åŸŸ=${criteria.area}`);
    if (criteria.market) {
        const marketName = criteria.market === 'SZ' ? 'æ·±åœ³' : criteria.market === 'SH' ? 'ä¸Šæµ·' : criteria.market;
        conditions.push(`å¸‚åœº=${marketName}`);
    }
    if (criteria.trade_date) conditions.push(`æ•°æ®æ—¥æœŸ=${criteria.trade_date}`);
    
    // æ•°å€¼èŒƒå›´æ¡ä»¶
    const rangeFields = [
        ['pe_min', 'pe_max', 'PE'],
        ['pb_min', 'pb_max', 'PB'],
        ['ps_min', 'ps_max', 'PS'],
        ['mv_min', 'mv_max', 'æ€»å¸‚å€¼'],
        ['turnover_min', 'turnover_max', 'æ¢æ‰‹ç‡']
    ];
    
    rangeFields.forEach(([minKey, maxKey, label]) => {
        if (criteria[minKey] || criteria[maxKey]) {
            conditions.push(`${label}=${criteria[minKey] || 'ä¸é™'}-${criteria[maxKey] || 'ä¸é™'}`);
        }
    });
    
    // åŠ¨æ€æ¡ä»¶
    if (criteria.dynamic_conditions && criteria.dynamic_conditions.length > 0) {
        criteria.dynamic_conditions.forEach(condition => {
            const fieldALabel = getFieldLabel(condition.field_a);
            const operatorLabel = OPERATORS[condition.operator];
            const fieldBLabel = condition.field_b ? getFieldLabel(condition.field_b) : condition.value;
            conditions.push(`${fieldALabel} ${operatorLabel} ${fieldBLabel}`);
        });
    }
    
    return conditions.length > 0 ? conditions.join(', ') : 'æ— ç‰¹å®šæ¡ä»¶';
}

// è·å–å­—æ®µæ ‡ç­¾
function getFieldLabel(fieldKey) {
    for (const category of Object.values(AVAILABLE_FIELDS)) {
        if (category[fieldKey]) {
            return category[fieldKey];
        }
    }
    return fieldKey;
}

// é‡ç½®ç­›é€‰
function resetScreen() {
    document.getElementById('screen-form').reset();
    
    // æ¸…é™¤åŠ¨æ€æ¡ä»¶
    document.getElementById('dynamic-conditions').innerHTML = '';
    dynamicConditionCount = 0;
    
    // é‡ç½®ç»“æœ
    document.getElementById('screen-results').innerHTML = `
        <div class="text-center py-5">
            <p class="text-muted">è¯·è®¾ç½®ç­›é€‰æ¡ä»¶å¹¶ç‚¹å‡»"å¼€å§‹ç­›é€‰"</p>
        </div>
    `;
    document.getElementById('result-count').textContent = '0';
    document.getElementById('export-results').style.display = 'none';
    currentResults = [];
}

// ä¿å­˜ç­›é€‰æ¨¡æ¿
function saveTemplate() {
    // æ”¶é›†å½“å‰ç­›é€‰æ¡ä»¶
    const template = {
        name: prompt('è¯·è¾“å…¥æ¨¡æ¿åç§°:'),
        conditions: getCurrentCriteria(),
        created_at: new Date().toISOString()
    };
    
    if (template.name) {
        // ä¿å­˜åˆ°localStorage
        const templates = JSON.parse(localStorage.getItem('screenTemplates') || '[]');
        templates.push(template);
        localStorage.setItem('screenTemplates', JSON.stringify(templates));
        
        alert('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼');
    }
}

// åŠ è½½ç­›é€‰æ¨¡æ¿
function loadTemplate() {
    const templates = JSON.parse(localStorage.getItem('screenTemplates') || '[]');
    
    if (templates.length === 0) {
        alert('æ²¡æœ‰ä¿å­˜çš„æ¨¡æ¿');
        return;
    }
    
    // åˆ›å»ºæ¨¡æ¿é€‰æ‹©å¯¹è¯æ¡†
    let templateOptions = templates.map((template, index) => 
        `${index + 1}. ${template.name} (${new Date(template.created_at).toLocaleDateString()})`
    ).join('\n');
    
    const choice = prompt(`è¯·é€‰æ‹©è¦åŠ è½½çš„æ¨¡æ¿:\n${templateOptions}\n\nè¯·è¾“å…¥åºå·:`);
    
    if (choice) {
        const index = parseInt(choice) - 1;
        if (index >= 0 && index < templates.length) {
            const template = templates[index];
            applyTemplate(template.conditions);
            alert(`æ¨¡æ¿ "${template.name}" åŠ è½½æˆåŠŸï¼`);
        } else {
            alert('æ— æ•ˆçš„é€‰æ‹©');
        }
    }
}

// åº”ç”¨æ¨¡æ¿æ¡ä»¶
function applyTemplate(conditions) {
    // é‡ç½®è¡¨å•
    resetScreen();
    
    // åº”ç”¨åŸºæœ¬æ¡ä»¶
    if (conditions.industry) document.getElementById('industry-filter').value = conditions.industry;
    if (conditions.area) document.getElementById('area-filter').value = conditions.area;
    if (conditions.market) document.getElementById('market-filter').value = conditions.market;
    if (conditions.trade_date) document.getElementById('date-filter').value = conditions.trade_date;
    
    // åº”ç”¨ä¼°å€¼æŒ‡æ ‡
    if (conditions.pe_min) document.getElementById('pe-min').value = conditions.pe_min;
    if (conditions.pe_max) document.getElementById('pe-max').value = conditions.pe_max;
    if (conditions.pb_min) document.getElementById('pb-min').value = conditions.pb_min;
    if (conditions.pb_max) document.getElementById('pb-max').value = conditions.pb_max;
    if (conditions.ps_min) document.getElementById('ps-min').value = conditions.ps_min;
    if (conditions.ps_max) document.getElementById('ps-max').value = conditions.ps_max;
    if (conditions.dv_min) document.getElementById('dv-min').value = conditions.dv_min;
    if (conditions.dv_max) document.getElementById('dv-max').value = conditions.dv_max;
    
    // åº”ç”¨å¸‚å€¼å’Œäº¤æ˜“æŒ‡æ ‡
    if (conditions.mv_min) document.getElementById('mv-min').value = conditions.mv_min;
    if (conditions.mv_max) document.getElementById('mv-max').value = conditions.mv_max;
    if (conditions.circ_mv_min) document.getElementById('circ-mv-min').value = conditions.circ_mv_min;
    if (conditions.circ_mv_max) document.getElementById('circ-mv-max').value = conditions.circ_mv_max;
    if (conditions.turnover_min) document.getElementById('turnover-min').value = conditions.turnover_min;
    if (conditions.turnover_max) document.getElementById('turnover-max').value = conditions.turnover_max;
    if (conditions.volume_ratio_min) document.getElementById('volume-ratio-min').value = conditions.volume_ratio_min;
    if (conditions.volume_ratio_max) document.getElementById('volume-ratio-max').value = conditions.volume_ratio_max;
    
    // åº”ç”¨æŠ€æœ¯æŒ‡æ ‡
    if (conditions.rsi6_min) document.getElementById('rsi6-min').value = conditions.rsi6_min;
    if (conditions.rsi6_max) document.getElementById('rsi6-max').value = conditions.rsi6_max;
    if (conditions.kdj_k_min) document.getElementById('kdj-k-min').value = conditions.kdj_k_min;
    if (conditions.kdj_k_max) document.getElementById('kdj-k-max').value = conditions.kdj_k_max;
    if (conditions.macd_min) document.getElementById('macd-min').value = conditions.macd_min;
    if (conditions.macd_max) document.getElementById('macd-max').value = conditions.macd_max;
    if (conditions.cci_min) document.getElementById('cci-min').value = conditions.cci_min;
    if (conditions.cci_max) document.getElementById('cci-max').value = conditions.cci_max;
    
    // åº”ç”¨èµ„é‡‘æµå‘
    if (conditions.net_amount_min) document.getElementById('net-amount-min').value = conditions.net_amount_min;
    if (conditions.net_amount_max) document.getElementById('net-amount-max').value = conditions.net_amount_max;
    if (conditions.lg_buy_rate_min) document.getElementById('lg-buy-rate-min').value = conditions.lg_buy_rate_min;
    if (conditions.lg_buy_rate_max) document.getElementById('lg-buy-rate-max').value = conditions.lg_buy_rate_max;
    if (conditions.net_d5_amount_min) document.getElementById('net-d5-amount-min').value = conditions.net_d5_amount_min;
    if (conditions.net_d5_amount_max) document.getElementById('net-d5-amount-max').value = conditions.net_d5_amount_max;
    
    // åº”ç”¨åŠ¨æ€æ¡ä»¶
    if (conditions.dynamic_conditions && conditions.dynamic_conditions.length > 0) {
        conditions.dynamic_conditions.forEach(condition => {
            addDynamicCondition();
            const currentId = dynamicConditionCount;
            
            document.getElementById(`field-a-${currentId}`).value = condition.field_a;
            document.getElementById(`operator-${currentId}`).value = condition.operator;
            
            if (condition.field_b) {
                document.getElementById(`field-b-${currentId}`).value = condition.field_b;
            } else if (condition.value !== null) {
                document.getElementById(`field-b-${currentId}`).value = '__value__';
                document.getElementById(`value-${currentId}`).style.display = 'block';
                document.getElementById(`value-${currentId}`).value = condition.value;
            }
        });
    }
}

// å¯¼å‡ºç»“æœ
function exportResults() {
    if (currentResults.length === 0) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
        return;
    }
    
    // è½¬æ¢ä¸ºCSVæ ¼å¼
    const headers = ['è‚¡ç¥¨ä»£ç ', 'è‚¡ç¥¨åç§°', 'è¡Œä¸š', 'åœ°åŸŸ', 'æ”¶ç›˜ä»·', 'æ¶¨è·Œå¹…(%)', 'PE', 'PB', 'æ€»å¸‚å€¼(ä¸‡)', 'æ¢æ‰‹ç‡(%)', 'å‡€æµå…¥(ä¸‡)', 'æ•°æ®æ—¥æœŸ'];
    const csvContent = [
        headers.join(','),
        ...currentResults.map(stock => [
            stock.symbol || stock.ts_code,
            stock.stock_name || stock.name,
            stock.industry || '',
            stock.area || '',
            stock.daily_close || '',
            stock.factor_pct_change || '',
            stock.pe || '',
            stock.pb || '',
            stock.total_mv || '',
            stock.turnover_rate || '',
            stock.moneyflow_net_amount || '',
            stock.trade_date || ''
        ].join(','))
    ].join('\n');
    
    // ä¸‹è½½æ–‡ä»¶
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `è‚¡ç¥¨ç­›é€‰ç»“æœ_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// è·å–å½“å‰ç­›é€‰æ¡ä»¶
function getCurrentCriteria() {
    const criteria = {
        // åŸºæœ¬æ¡ä»¶
        industry: document.getElementById('industry-filter').value,
        area: document.getElementById('area-filter').value,
        market: document.getElementById('market-filter').value,
        trade_date: document.getElementById('date-filter').value,
        
        // ä¼°å€¼æŒ‡æ ‡
        pe_min: document.getElementById('pe-min').value,
        pe_max: document.getElementById('pe-max').value,
        pb_min: document.getElementById('pb-min').value,
        pb_max: document.getElementById('pb-max').value,
        ps_min: document.getElementById('ps-min').value,
        ps_max: document.getElementById('ps-max').value,
        dv_min: document.getElementById('dv-min').value,
        dv_max: document.getElementById('dv-max').value,
        
        // å¸‚å€¼å’Œäº¤æ˜“
        mv_min: document.getElementById('mv-min').value,
        mv_max: document.getElementById('mv-max').value,
        circ_mv_min: document.getElementById('circ-mv-min').value,
        circ_mv_max: document.getElementById('circ-mv-max').value,
        turnover_min: document.getElementById('turnover-min').value,
        turnover_max: document.getElementById('turnover-max').value,
        volume_ratio_min: document.getElementById('volume-ratio-min').value,
        volume_ratio_max: document.getElementById('volume-ratio-max').value,
        
        // æŠ€æœ¯æŒ‡æ ‡
        rsi6_min: document.getElementById('rsi6-min').value,
        rsi6_max: document.getElementById('rsi6-max').value,
        kdj_k_min: document.getElementById('kdj-k-min').value,
        kdj_k_max: document.getElementById('kdj-k-max').value,
        macd_min: document.getElementById('macd-min').value,
        macd_max: document.getElementById('macd-max').value,
        cci_min: document.getElementById('cci-min').value,
        cci_max: document.getElementById('cci-max').value,
        
        // èµ„é‡‘æµå‘
        net_amount_min: document.getElementById('net-amount-min').value,
        net_amount_max: document.getElementById('net-amount-max').value,
        lg_buy_rate_min: document.getElementById('lg-buy-rate-min').value,
        lg_buy_rate_max: document.getElementById('lg-buy-rate-max').value,
        net_d5_amount_min: document.getElementById('net-d5-amount-min').value,
        net_d5_amount_max: document.getElementById('net-d5-amount-max').value
    };
    
    // æ”¶é›†åŠ¨æ€æŸ¥è¯¢æ¡ä»¶
    const dynamicConditions = [];
    for (let i = 1; i <= dynamicConditionCount; i++) {
        const fieldA = document.getElementById(`field-a-${i}`);
        const operator = document.getElementById(`operator-${i}`);
        const fieldB = document.getElementById(`field-b-${i}`);
        const value = document.getElementById(`value-${i}`);
        
        if (fieldA && fieldA.value && operator && operator.value && fieldB && fieldB.value) {
            const condition = {
                field_a: fieldA.value,
                operator: operator.value,
                field_b: fieldB.value === '__value__' ? null : fieldB.value,
                value: fieldB.value === '__value__' ? value.value : null
            };
            
            // éªŒè¯æ¡ä»¶å®Œæ•´æ€§
            if (condition.field_b || condition.value) {
                dynamicConditions.push(condition);
            }
        }
    }
    
    criteria.dynamic_conditions = dynamicConditions;
    return criteria;
}

// æ˜¾ç¤ºæ›´å¤šç»“æœæç¤º
function showMoreResultsHint() {
    const container = document.getElementById('screen-results');
    const hint = document.createElement('div');
    hint.className = 'alert alert-info mt-3';
    hint.innerHTML = '<i class="fas fa-info-circle"></i> ç»“æœå·²é™åˆ¶åœ¨200æ¡ä»¥å†…ï¼Œè¯·ä½¿ç”¨æ›´ç²¾ç¡®çš„ç­›é€‰æ¡ä»¶è·å¾—æ›´å¥½çš„ç»“æœã€‚';
    container.appendChild(hint);
}

// æ·»åŠ åˆ°æŠ€æœ¯åˆ†æ
function addToAnalysis(tsCode) {
    window.open(`/analysis?stock=${tsCode}`, '_blank');
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ç­›é€‰ä¸­...</span>
            </div>
            <p class="mt-3 text-muted">æ­£åœ¨ç­›é€‰è‚¡ç¥¨ï¼Œè¯·ç¨å€™...</p>
        </div>
    `;
}

// æ˜¾ç¤ºé”™è¯¯
function showError(containerId, message) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}

// å·¥å…·å‡½æ•°
function formatNumber(num, decimals = 2) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    return Number(num).toLocaleString('zh-CN', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

function formatPercent(num) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    const sign = num >= 0 ? '+' : '';
    return sign + Number(num).toFixed(2) + '%';
}
</script>
{% endblock %} 