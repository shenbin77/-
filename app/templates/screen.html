{% extends "base.html" %}

{% block title %}ÈÄâËÇ°Á≠õÈÄâ - ËÇ°Á•®ÂàÜÊûêÁ≥ªÁªü{% endblock %}

{% block content %}
<div class="container">
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">üéØ ÈÄâËÇ°Á≠õÈÄâ</h1>
            <p class="text-muted">Âü∫‰∫éËÇ°Á•®‰∏öÂä°Â§ßÂÆΩË°®ÁöÑÂ§öÁª¥Â∫¶Êù°‰ª∂Á≠õÈÄâÔºåÂèëÁé∞ÊäïËµÑÊú∫‰ºö</p>
        </div>
    </div>

    <!-- Á≠õÈÄâÊù°‰ª∂ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Á≠õÈÄâÊù°‰ª∂</h5>
                </div>
                <div class="card-body">
                    <form id="screen-form">
                        <!-- Âü∫Êú¨Êù°‰ª∂ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">üìä Âü∫Êú¨Êù°‰ª∂</h6>
                            </div>
                            <div class="col-md-3">
                                <label for="industry-filter" class="form-label">Ë°å‰∏ö</label>
                                <select class="form-select" id="industry-filter">
                                    <option value="">ÂÖ®ÈÉ®Ë°å‰∏ö</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="area-filter" class="form-label">Âú∞Âüü</label>
                                <select class="form-select" id="area-filter">
                                    <option value="">ÂÖ®ÈÉ®Âú∞Âüü</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="market-filter" class="form-label">Â∏ÇÂú∫</label>
                                <select class="form-select" id="market-filter">
                                    <option value="">ÂÖ®ÈÉ®Â∏ÇÂú∫</option>
                                    <option value="SZ">Ê∑±Âú≥</option>
                                    <option value="SH">‰∏äÊµ∑</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="date-filter" class="form-label">Êï∞ÊçÆÊó•Êúü</label>
                                <input type="date" class="form-control" id="date-filter" title="ÈÄâÊã©ÁâπÂÆöÊó•ÊúüÁöÑÊï∞ÊçÆÔºåÁïôÁ©∫Âàô‰ΩøÁî®ÊúÄÊñ∞Êï∞ÊçÆ">
                            </div>
                        </div>

                        <!-- ‰º∞ÂÄºÊåáÊ†á -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">üí∞ ‰º∞ÂÄºÊåáÊ†á</h6>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Â∏ÇÁõàÁéá(PE)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="pe-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="pe-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Â∏ÇÂáÄÁéá(PB)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="pb-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="pb-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Â∏ÇÈîÄÁéá(PS)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="ps-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="ps-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ËÇ°ÊÅØÁéá(%)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="dv-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="dv-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Â∏ÇÂÄºÂíå‰∫§ÊòìÊåáÊ†á -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">üìà Â∏ÇÂÄº‰∏é‰∫§Êòì</h6>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ÊÄªÂ∏ÇÂÄº(‰∏áÂÖÉ)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="mv-min" placeholder="ÊúÄÂ∞èÂÄº">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="mv-max" placeholder="ÊúÄÂ§ßÂÄº">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ÊµÅÈÄöÂ∏ÇÂÄº(‰∏áÂÖÉ)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="circ-mv-min" placeholder="ÊúÄÂ∞èÂÄº">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="circ-mv-max" placeholder="ÊúÄÂ§ßÂÄº">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Êç¢ÊâãÁéá(%)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="turnover-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="turnover-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ÈáèÊØî</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="volume-ratio-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="volume-ratio-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÊäÄÊúØÊåáÊ†á -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">üìä ÊäÄÊúØÊåáÊ†á</h6>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">RSI(6Êó•)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="rsi6-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="rsi6-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">KDJ-KÂÄº</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="kdj-k-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="kdj-k-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">MACD</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="macd-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.01">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="macd-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">CCIÊåáÊ†á</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="cci-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="cci-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ËµÑÈáëÊµÅÂêë -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">üí∏ ËµÑÈáëÊµÅÂêë</h6>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ÂáÄÊµÅÂÖ•È¢ù(‰∏áÂÖÉ)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="net-amount-min" placeholder="ÊúÄÂ∞èÂÄº">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="net-amount-max" placeholder="ÊúÄÂ§ßÂÄº">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Â§ßÂçï‰π∞ÂÖ•Âç†ÊØî(%)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="lg-buy-rate-min" placeholder="ÊúÄÂ∞èÂÄº" step="0.1">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="lg-buy-rate-max" placeholder="ÊúÄÂ§ßÂÄº" step="0.1">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">5Êó•ÂáÄÊµÅÂÖ•È¢ù(‰∏áÂÖÉ)</label>
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="number" class="form-control" id="net-d5-amount-min" placeholder="ÊúÄÂ∞èÂÄº">
                                    </div>
                                    <div class="col-auto">-</div>
                                    <div class="col">
                                        <input type="number" class="form-control" id="net-d5-amount-max" placeholder="ÊúÄÂ§ßÂÄº">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Âä®ÊÄÅÊü•ËØ¢Êù°‰ª∂ -->
                        <div class="row g-3 mb-4">
                            <div class="col-12">
                                <h6 class="text-primary">üîß Âä®ÊÄÅÊü•ËØ¢Êù°‰ª∂</h6>
                                <p class="text-muted small">ÊîØÊåÅÂ≠óÊÆµÈó¥ÊØîËæÉÔºåÂ¶ÇÔºöMA5 > MA10ÔºåPE < PBÁ≠â</p>
                            </div>
                            <div id="dynamic-conditions">
                                <!-- Âä®ÊÄÅÊù°‰ª∂Â∞ÜÂú®ËøôÈáåÊ∑ªÂä† -->
                            </div>
                            <div class="col-12">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="add-condition">
                                    <i class="fas fa-plus"></i> Ê∑ªÂä†Êù°‰ª∂
                                </button>
                            </div>
                        </div>

                        <!-- Êìç‰ΩúÊåâÈíÆ -->
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search"></i> ÂºÄÂßãÁ≠õÈÄâ
                                </button>
                                <button type="button" class="btn btn-secondary me-2" id="reset-screen">
                                    <i class="fas fa-undo"></i> ÈáçÁΩÆÊù°‰ª∂
                                </button>
                                <button type="button" class="btn btn-info me-2" id="save-template">
                                    <i class="fas fa-save"></i> ‰øùÂ≠òÊ®°Êùø
                                </button>
                                <button type="button" class="btn btn-outline-info" id="load-template">
                                    <i class="fas fa-folder-open"></i> Âä†ËΩΩÊ®°Êùø
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Á≠õÈÄâÁªìÊûú -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Á≠õÈÄâÁªìÊûú</h5>
                    <div>
                        <span class="badge bg-primary me-2" id="result-count">0</span>
                        <button class="btn btn-sm btn-outline-success" id="export-results" style="display: none;">
                            <i class="fas fa-download"></i> ÂØºÂá∫
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="screen-results">
                        <div class="text-center py-5">
                            <p class="text-muted">ËØ∑ËÆæÁΩÆÁ≠õÈÄâÊù°‰ª∂Âπ∂ÁÇπÂáª"ÂºÄÂßãÁ≠õÈÄâ"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ÂÖ®Â±ÄÂèòÈáè
let dynamicConditionCount = 0;
let currentResults = [];

// ÂèØÁî®Â≠óÊÆµÂÆö‰πâ
const AVAILABLE_FIELDS = {
    'Âü∫Êú¨‰ø°ÊÅØ': {
        'daily_close': 'Êî∂Áõò‰ª∑',
        'factor_change': 'Ê∂®Ë∑åÈ¢ù',
        'factor_pct_change': 'Ê∂®Ë∑åÂπÖ(%)'
    },
    '‰º∞ÂÄºÊåáÊ†á': {
        'pe': 'Â∏ÇÁõàÁéá(PE)',
        'pe_ttm': 'Â∏ÇÁõàÁéá(TTM)',
        'pb': 'Â∏ÇÂáÄÁéá(PB)',
        'ps': 'Â∏ÇÈîÄÁéá(PS)',
        'ps_ttm': 'Â∏ÇÈîÄÁéá(TTM)',
        'dv_ratio': 'ËÇ°ÊÅØÁéá(%)',
        'dv_ttm': 'ËÇ°ÊÅØÁéá(TTM)(%)'
    },
    'Â∏ÇÂÄº‰∫§Êòì': {
        'total_mv': 'ÊÄªÂ∏ÇÂÄº(‰∏á)',
        'circ_mv': 'ÊµÅÈÄöÂ∏ÇÂÄº(‰∏á)',
        'turnover_rate': 'Êç¢ÊâãÁéá(%)',
        'turnover_rate_f': 'Êç¢ÊâãÁéá(Ëá™Áî±ÊµÅÈÄö)',
        'volume_ratio': 'ÈáèÊØî',
        'factor_vol': 'Êàê‰∫§Èáè',
        'factor_amount': 'Êàê‰∫§È¢ù'
    },
    'ÊäÄÊúØÊåáÊ†á': {
        'factor_macd_dif': 'MACD DIF',
        'factor_macd_dea': 'MACD DEA',
        'factor_macd': 'MACD',
        'factor_kdj_k': 'KDJ KÂÄº',
        'factor_kdj_d': 'KDJ DÂÄº',
        'factor_kdj_j': 'KDJ JÂÄº',
        'factor_rsi_6': 'RSI(6Êó•)',
        'factor_rsi_12': 'RSI(12Êó•)',
        'factor_rsi_24': 'RSI(24Êó•)',
        'factor_boll_upper': 'Â∏ÉÊûó‰∏äËΩ®',
        'factor_boll_mid': 'Â∏ÉÊûó‰∏≠ËΩ®',
        'factor_boll_lower': 'Â∏ÉÊûó‰∏ãËΩ®',
        'factor_cci': 'CCIÊåáÊ†á'
    },
    'ÂùáÁ∫øÊåáÊ†á': {
        'ma5': 'MA5',
        'ma10': 'MA10',
        'ma20': 'MA20',
        'ma30': 'MA30',
        'ma60': 'MA60',
        'ma120': 'MA120'
    },
    'ËµÑÈáëÊµÅÂêë': {
        'moneyflow_net_amount': 'ÂáÄÊµÅÂÖ•È¢ù',
        'moneyflow_net_d5_amount': '5Êó•ÂáÄÊµÅÂÖ•È¢ù',
        'moneyflow_buy_lg_amount': 'Â§ßÂçï‰π∞ÂÖ•È¢ù',
        'moneyflow_buy_lg_amount_rate': 'Â§ßÂçï‰π∞ÂÖ•Âç†ÊØî(%)',
        'moneyflow_buy_md_amount': '‰∏≠Âçï‰π∞ÂÖ•È¢ù',
        'moneyflow_buy_md_amount_rate': '‰∏≠Âçï‰π∞ÂÖ•Âç†ÊØî(%)',
        'moneyflow_buy_sm_amount': 'Â∞èÂçï‰π∞ÂÖ•È¢ù',
        'moneyflow_buy_sm_amount_rate': 'Â∞èÂçï‰π∞ÂÖ•Âç†ÊØî(%)'
    }
};

// Êìç‰ΩúÁ¨¶ÂÆö‰πâ
const OPERATORS = {
    '>': 'Â§ß‰∫é',
    '>=': 'Â§ß‰∫éÁ≠â‰∫é',
    '<': 'Â∞è‰∫é',
    '<=': 'Â∞è‰∫éÁ≠â‰∫é',
    '=': 'Á≠â‰∫é',
    '!=': '‰∏çÁ≠â‰∫é'
};

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    loadFilterOptions();
    
    // ÁªëÂÆö‰∫ã‰ª∂
    document.getElementById('screen-form').addEventListener('submit', handleScreen);
    document.getElementById('reset-screen').addEventListener('click', resetScreen);
    document.getElementById('add-condition').addEventListener('click', addDynamicCondition);
    document.getElementById('save-template').addEventListener('click', saveTemplate);
    document.getElementById('load-template').addEventListener('click', loadTemplate);
    document.getElementById('export-results').addEventListener('click', exportResults);
});

// Âä†ËΩΩÁ≠õÈÄâÈÄâÈ°π
async function loadFilterOptions() {
    try {
        // Âä†ËΩΩË°å‰∏öÂàóË°®
        const industriesResponse = await apiRequest('/industries');
        if (industriesResponse.code === 200) {
            const select = document.getElementById('industry-filter');
            industriesResponse.data.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                select.appendChild(option);
            });
        }

        // Âä†ËΩΩÂú∞ÂüüÂàóË°®
        const areasResponse = await apiRequest('/areas');
        if (areasResponse.code === 200) {
            const select = document.getElementById('area-filter');
            areasResponse.data.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Âä†ËΩΩÁ≠õÈÄâÈÄâÈ°πÂ§±Ë¥•:', error);
    }
}

// Ê∑ªÂä†Âä®ÊÄÅÊü•ËØ¢Êù°‰ª∂
function addDynamicCondition() {
    dynamicConditionCount++;
    const container = document.getElementById('dynamic-conditions');
    
    const conditionDiv = document.createElement('div');
    conditionDiv.className = 'col-12 mb-3';
    conditionDiv.id = `condition-${dynamicConditionCount}`;
    
    conditionDiv.innerHTML = `
        <div class="card border-light">
            <div class="card-body py-2">
                <div class="row g-2 align-items-center">
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="field-a-${dynamicConditionCount}">
                            <option value="">ÈÄâÊã©Â≠óÊÆµA</option>
                            ${generateFieldOptions()}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="operator-${dynamicConditionCount}">
                            ${Object.entries(OPERATORS).map(([key, value]) => 
                                `<option value="${key}">${value}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="field-b-${dynamicConditionCount}">
                            <option value="">ÈÄâÊã©Â≠óÊÆµB</option>
                            <option value="__value__">Âõ∫ÂÆöÊï∞ÂÄº</option>
                            ${generateFieldOptions()}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control form-control-sm" id="value-${dynamicConditionCount}" 
                               placeholder="Êï∞ÂÄº" step="0.01" style="display: none;">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                onclick="removeDynamicCondition(${dynamicConditionCount})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(conditionDiv);
    
    // ÁªëÂÆöÂ≠óÊÆµBÂèòÂåñ‰∫ã‰ª∂
    document.getElementById(`field-b-${dynamicConditionCount}`).addEventListener('change', function() {
        const valueInput = document.getElementById(`value-${dynamicConditionCount}`);
        if (this.value === '__value__') {
            valueInput.style.display = 'block';
            valueInput.required = true;
        } else {
            valueInput.style.display = 'none';
            valueInput.required = false;
            valueInput.value = '';
        }
    });
}

// ÁîüÊàêÂ≠óÊÆµÈÄâÈ°πHTML
function generateFieldOptions() {
    let html = '';
    for (const [category, fields] of Object.entries(AVAILABLE_FIELDS)) {
        html += `<optgroup label="${category}">`;
        for (const [key, label] of Object.entries(fields)) {
            html += `<option value="${key}">${label}</option>`;
        }
        html += '</optgroup>';
    }
    return html;
}

// ÁßªÈô§Âä®ÊÄÅÊü•ËØ¢Êù°‰ª∂
function removeDynamicCondition(id) {
    const element = document.getElementById(`condition-${id}`);
    if (element) {
        element.remove();
    }
}

// Â§ÑÁêÜÁ≠õÈÄâ
function handleScreen(event) {
    event.preventDefault();
    
    // Êî∂ÈõÜÂü∫Á°ÄÁ≠õÈÄâÊù°‰ª∂
    const criteria = {
        // Âü∫Êú¨Êù°‰ª∂
        industry: document.getElementById('industry-filter').value,
        area: document.getElementById('area-filter').value,
        market: document.getElementById('market-filter').value,
        trade_date: document.getElementById('date-filter').value,
        
        // ‰º∞ÂÄºÊåáÊ†á
        pe_min: document.getElementById('pe-min').value,
        pe_max: document.getElementById('pe-max').value,
        pb_min: document.getElementById('pb-min').value,
        pb_max: document.getElementById('pb-max').value,
        ps_min: document.getElementById('ps-min').value,
        ps_max: document.getElementById('ps-max').value,
        dv_min: document.getElementById('dv-min').value,
        dv_max: document.getElementById('dv-max').value,
        
        // Â∏ÇÂÄºÂíå‰∫§Êòì
        mv_min: document.getElementById('mv-min').value,
        mv_max: document.getElementById('mv-max').value,
        circ_mv_min: document.getElementById('circ-mv-min').value,
        circ_mv_max: document.getElementById('circ-mv-max').value,
        turnover_min: document.getElementById('turnover-min').value,
        turnover_max: document.getElementById('turnover-max').value,
        volume_ratio_min: document.getElementById('volume-ratio-min').value,
        volume_ratio_max: document.getElementById('volume-ratio-max').value,
        
        // ÊäÄÊúØÊåáÊ†á
        rsi6_min: document.getElementById('rsi6-min').value,
        rsi6_max: document.getElementById('rsi6-max').value,
        kdj_k_min: document.getElementById('kdj-k-min').value,
        kdj_k_max: document.getElementById('kdj-k-max').value,
        macd_min: document.getElementById('macd-min').value,
        macd_max: document.getElementById('macd-max').value,
        cci_min: document.getElementById('cci-min').value,
        cci_max: document.getElementById('cci-max').value,
        
        // ËµÑÈáëÊµÅÂêë
        net_amount_min: document.getElementById('net-amount-min').value,
        net_amount_max: document.getElementById('net-amount-max').value,
        lg_buy_rate_min: document.getElementById('lg-buy-rate-min').value,
        lg_buy_rate_max: document.getElementById('lg-buy-rate-max').value,
        net_d5_amount_min: document.getElementById('net-d5-amount-min').value,
        net_d5_amount_max: document.getElementById('net-d5-amount-max').value
    };
    
    // Êî∂ÈõÜÂä®ÊÄÅÊü•ËØ¢Êù°‰ª∂
    const dynamicConditions = [];
    for (let i = 1; i <= dynamicConditionCount; i++) {
        const fieldA = document.getElementById(`field-a-${i}`);
        const operator = document.getElementById(`operator-${i}`);
        const fieldB = document.getElementById(`field-b-${i}`);
        const value = document.getElementById(`value-${i}`);
        
        if (fieldA && fieldA.value && operator && operator.value && fieldB && fieldB.value) {
            const condition = {
                field_a: fieldA.value,
                operator: operator.value,
                field_b: fieldB.value === '__value__' ? null : fieldB.value,
                value: fieldB.value === '__value__' ? value.value : null
            };
            
            // È™åËØÅÊù°‰ª∂ÂÆåÊï¥ÊÄß
            if (condition.field_b || condition.value) {
                dynamicConditions.push(condition);
            }
        }
    }
    
    criteria.dynamic_conditions = dynamicConditions;
    
    performScreen(criteria);
}

// ÊâßË°åÁ≠õÈÄâ
async function performScreen(criteria) {
    showLoading('screen-results');
    
    try {
        console.log('ÂèëÈÄÅÁ≠õÈÄâËØ∑Ê±Ç:', criteria);
        
        // Ë∞ÉÁî®Â¢ûÂº∫ÁöÑÁ≠õÈÄâAPI
        const response = await apiRequest('/analysis/screen', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            data: criteria
        });
        
        console.log('Á≠õÈÄâÂìçÂ∫î:', response);
        
        if (response.code === 200) {
            currentResults = response.data.stocks;
            renderScreenResults(response.data.stocks, criteria);
            document.getElementById('result-count').textContent = response.data.total;
            
            // ÊòæÁ§∫ÂØºÂá∫ÊåâÈíÆ
            if (response.data.stocks.length > 0) {
                document.getElementById('export-results').style.display = 'inline-block';
            }
            
            // ÊòæÁ§∫ÊòØÂê¶ÊúâÊõ¥Â§öÁªìÊûú
            if (response.data.has_more) {
                showMoreResultsHint();
            }
        } else {
            showError('screen-results', response.message || 'Á≠õÈÄâÂ§±Ë¥•');
        }
    } catch (error) {
        showError('screen-results', 'Á≠õÈÄâÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
        console.error('Á≠õÈÄâÂ§±Ë¥•:', error);
    }
}

// Ê∏≤ÊüìÁ≠õÈÄâÁªìÊûú
function renderScreenResults(stocks, criteria) {
    const container = document.getElementById('screen-results');
    
    if (stocks.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">Êú™ÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑËÇ°Á•®</p></div>';
        return;
    }
    
    const html = `
        <div class="mb-3">
            <small class="text-muted">Á≠õÈÄâÊù°‰ª∂Ôºö${formatCriteria(criteria)}</small>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-sm">
                <thead class="table-light">
                    <tr>
                        <th>ËÇ°Á•®‰ª£Á†Å</th>
                        <th>ËÇ°Á•®ÂêçÁß∞</th>
                        <th>Ë°å‰∏ö</th>
                        <th>Âú∞Âüü</th>
                        <th>Êî∂Áõò‰ª∑</th>
                        <th>Ê∂®Ë∑åÂπÖ(%)</th>
                        <th>PE</th>
                        <th>PB</th>
                        <th>ÊÄªÂ∏ÇÂÄº(‰∏á)</th>
                        <th>Êç¢ÊâãÁéá(%)</th>
                        <th>ÂáÄÊµÅÂÖ•(‰∏á)</th>
                        <th>Êï∞ÊçÆÊó•Êúü</th>
                        <th>Êìç‰Ωú</th>
                    </tr>
                </thead>
                <tbody>
                    ${stocks.map(stock => `
                        <tr>
                            <td><code>${stock.symbol || stock.ts_code}</code></td>
                            <td><strong>${stock.stock_name || stock.name}</strong></td>
                            <td><span class="badge bg-secondary">${stock.industry || '--'}</span></td>
                            <td>${stock.area || '--'}</td>
                            <td class="text-end">${stock.daily_close ? formatNumber(stock.daily_close, 2) : '--'}</td>
                            <td class="text-end ${getChangeClass(stock.factor_pct_change)}">
                                ${stock.factor_pct_change ? formatNumber(stock.factor_pct_change, 2) + '%' : '--'}
                            </td>
                            <td class="text-end">${stock.pe ? formatNumber(stock.pe, 2) : '--'}</td>
                            <td class="text-end">${stock.pb ? formatNumber(stock.pb, 2) : '--'}</td>
                            <td class="text-end">${stock.total_mv ? formatNumber(stock.total_mv, 0) : '--'}</td>
                            <td class="text-end">${stock.turnover_rate ? formatNumber(stock.turnover_rate, 2) : '--'}</td>
                            <td class="text-end ${getChangeClass(stock.moneyflow_net_amount)}">
                                ${stock.moneyflow_net_amount ? formatNumber(stock.moneyflow_net_amount, 0) : '--'}
                            </td>
                            <td>${stock.trade_date || '--'}</td>
                            <td>
                                <a href="/stock/${stock.ts_code}" class="btn btn-sm btn-primary" target="_blank">ËØ¶ÊÉÖ</a>
                                <button class="btn btn-sm btn-outline-success ms-1" onclick="addToAnalysis('${stock.ts_code}')">ÂàÜÊûê</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// Ëé∑ÂèñÊ∂®Ë∑åÈ¢úËâ≤Á±ª
function getChangeClass(value) {
    if (!value) return '';
    return parseFloat(value) >= 0 ? 'text-success' : 'text-danger';
}

// Ê†ºÂºèÂåñÁ≠õÈÄâÊù°‰ª∂
function formatCriteria(criteria) {
    const conditions = [];
    
    // Âü∫Êú¨Êù°‰ª∂
    if (criteria.industry) conditions.push(`Ë°å‰∏ö=${criteria.industry}`);
    if (criteria.area) conditions.push(`Âú∞Âüü=${criteria.area}`);
    if (criteria.market) {
        const marketName = criteria.market === 'SZ' ? 'Ê∑±Âú≥' : criteria.market === 'SH' ? '‰∏äÊµ∑' : criteria.market;
        conditions.push(`Â∏ÇÂú∫=${marketName}`);
    }
    if (criteria.trade_date) conditions.push(`Êï∞ÊçÆÊó•Êúü=${criteria.trade_date}`);
    
    // Êï∞ÂÄºËåÉÂõ¥Êù°‰ª∂
    const rangeFields = [
        ['pe_min', 'pe_max', 'PE'],
        ['pb_min', 'pb_max', 'PB'],
        ['ps_min', 'ps_max', 'PS'],
        ['mv_min', 'mv_max', 'ÊÄªÂ∏ÇÂÄº'],
        ['turnover_min', 'turnover_max', 'Êç¢ÊâãÁéá']
    ];
    
    rangeFields.forEach(([minKey, maxKey, label]) => {
        if (criteria[minKey] || criteria[maxKey]) {
            conditions.push(`${label}=${criteria[minKey] || '‰∏çÈôê'}-${criteria[maxKey] || '‰∏çÈôê'}`);
        }
    });
    
    // Âä®ÊÄÅÊù°‰ª∂
    if (criteria.dynamic_conditions && criteria.dynamic_conditions.length > 0) {
        criteria.dynamic_conditions.forEach(condition => {
            const fieldALabel = getFieldLabel(condition.field_a);
            const operatorLabel = OPERATORS[condition.operator];
            const fieldBLabel = condition.field_b ? getFieldLabel(condition.field_b) : condition.value;
            conditions.push(`${fieldALabel} ${operatorLabel} ${fieldBLabel}`);
        });
    }
    
    return conditions.length > 0 ? conditions.join(', ') : 'Êó†ÁâπÂÆöÊù°‰ª∂';
}

// Ëé∑ÂèñÂ≠óÊÆµÊ†áÁ≠æ
function getFieldLabel(fieldKey) {
    for (const category of Object.values(AVAILABLE_FIELDS)) {
        if (category[fieldKey]) {
            return category[fieldKey];
        }
    }
    return fieldKey;
}

// ÈáçÁΩÆÁ≠õÈÄâ
function resetScreen() {
    document.getElementById('screen-form').reset();
    
    // Ê∏ÖÈô§Âä®ÊÄÅÊù°‰ª∂
    document.getElementById('dynamic-conditions').innerHTML = '';
    dynamicConditionCount = 0;
    
    // ÈáçÁΩÆÁªìÊûú
    document.getElementById('screen-results').innerHTML = `
        <div class="text-center py-5">
            <p class="text-muted">ËØ∑ËÆæÁΩÆÁ≠õÈÄâÊù°‰ª∂Âπ∂ÁÇπÂáª"ÂºÄÂßãÁ≠õÈÄâ"</p>
        </div>
    `;
    document.getElementById('result-count').textContent = '0';
    document.getElementById('export-results').style.display = 'none';
    currentResults = [];
}

// ‰øùÂ≠òÁ≠õÈÄâÊ®°Êùø
function saveTemplate() {
    // Êî∂ÈõÜÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂
    const template = {
        name: prompt('ËØ∑ËæìÂÖ•Ê®°ÊùøÂêçÁß∞:'),
        conditions: getCurrentCriteria(),
        created_at: new Date().toISOString()
    };
    
    if (template.name) {
        // ‰øùÂ≠òÂà∞localStorage
        const templates = JSON.parse(localStorage.getItem('screenTemplates') || '[]');
        templates.push(template);
        localStorage.setItem('screenTemplates', JSON.stringify(templates));
        
        alert('Ê®°Êùø‰øùÂ≠òÊàêÂäüÔºÅ');
    }
}

// Âä†ËΩΩÁ≠õÈÄâÊ®°Êùø
function loadTemplate() {
    const templates = JSON.parse(localStorage.getItem('screenTemplates') || '[]');
    
    if (templates.length === 0) {
        alert('Ê≤°Êúâ‰øùÂ≠òÁöÑÊ®°Êùø');
        return;
    }
    
    // ÂàõÂª∫Ê®°ÊùøÈÄâÊã©ÂØπËØùÊ°Ü
    let templateOptions = templates.map((template, index) => 
        `${index + 1}. ${template.name} (${new Date(template.created_at).toLocaleDateString()})`
    ).join('\n');
    
    const choice = prompt(`ËØ∑ÈÄâÊã©Ë¶ÅÂä†ËΩΩÁöÑÊ®°Êùø:\n${templateOptions}\n\nËØ∑ËæìÂÖ•Â∫èÂè∑:`);
    
    if (choice) {
        const index = parseInt(choice) - 1;
        if (index >= 0 && index < templates.length) {
            const template = templates[index];
            applyTemplate(template.conditions);
            alert(`Ê®°Êùø "${template.name}" Âä†ËΩΩÊàêÂäüÔºÅ`);
        } else {
            alert('Êó†ÊïàÁöÑÈÄâÊã©');
        }
    }
}

// Â∫îÁî®Ê®°ÊùøÊù°‰ª∂
function applyTemplate(conditions) {
    // ÈáçÁΩÆË°®Âçï
    resetScreen();
    
    // Â∫îÁî®Âü∫Êú¨Êù°‰ª∂
    if (conditions.industry) document.getElementById('industry-filter').value = conditions.industry;
    if (conditions.area) document.getElementById('area-filter').value = conditions.area;
    if (conditions.market) document.getElementById('market-filter').value = conditions.market;
    if (conditions.trade_date) document.getElementById('date-filter').value = conditions.trade_date;
    
    // Â∫îÁî®‰º∞ÂÄºÊåáÊ†á
    if (conditions.pe_min) document.getElementById('pe-min').value = conditions.pe_min;
    if (conditions.pe_max) document.getElementById('pe-max').value = conditions.pe_max;
    if (conditions.pb_min) document.getElementById('pb-min').value = conditions.pb_min;
    if (conditions.pb_max) document.getElementById('pb-max').value = conditions.pb_max;
    if (conditions.ps_min) document.getElementById('ps-min').value = conditions.ps_min;
    if (conditions.ps_max) document.getElementById('ps-max').value = conditions.ps_max;
    if (conditions.dv_min) document.getElementById('dv-min').value = conditions.dv_min;
    if (conditions.dv_max) document.getElementById('dv-max').value = conditions.dv_max;
    
    // Â∫îÁî®Â∏ÇÂÄºÂíå‰∫§ÊòìÊåáÊ†á
    if (conditions.mv_min) document.getElementById('mv-min').value = conditions.mv_min;
    if (conditions.mv_max) document.getElementById('mv-max').value = conditions.mv_max;
    if (conditions.circ_mv_min) document.getElementById('circ-mv-min').value = conditions.circ_mv_min;
    if (conditions.circ_mv_max) document.getElementById('circ-mv-max').value = conditions.circ_mv_max;
    if (conditions.turnover_min) document.getElementById('turnover-min').value = conditions.turnover_min;
    if (conditions.turnover_max) document.getElementById('turnover-max').value = conditions.turnover_max;
    if (conditions.volume_ratio_min) document.getElementById('volume-ratio-min').value = conditions.volume_ratio_min;
    if (conditions.volume_ratio_max) document.getElementById('volume-ratio-max').value = conditions.volume_ratio_max;
    
    // Â∫îÁî®ÊäÄÊúØÊåáÊ†á
    if (conditions.rsi6_min) document.getElementById('rsi6-min').value = conditions.rsi6_min;
    if (conditions.rsi6_max) document.getElementById('rsi6-max').value = conditions.rsi6_max;
    if (conditions.kdj_k_min) document.getElementById('kdj-k-min').value = conditions.kdj_k_min;
    if (conditions.kdj_k_max) document.getElementById('kdj-k-max').value = conditions.kdj_k_max;
    if (conditions.macd_min) document.getElementById('macd-min').value = conditions.macd_min;
    if (conditions.macd_max) document.getElementById('macd-max').value = conditions.macd_max;
    if (conditions.cci_min) document.getElementById('cci-min').value = conditions.cci_min;
    if (conditions.cci_max) document.getElementById('cci-max').value = conditions.cci_max;
    
    // Â∫îÁî®ËµÑÈáëÊµÅÂêë
    if (conditions.net_amount_min) document.getElementById('net-amount-min').value = conditions.net_amount_min;
    if (conditions.net_amount_max) document.getElementById('net-amount-max').value = conditions.net_amount_max;
    if (conditions.lg_buy_rate_min) document.getElementById('lg-buy-rate-min').value = conditions.lg_buy_rate_min;
    if (conditions.lg_buy_rate_max) document.getElementById('lg-buy-rate-max').value = conditions.lg_buy_rate_max;
    if (conditions.net_d5_amount_min) document.getElementById('net-d5-amount-min').value = conditions.net_d5_amount_min;
    if (conditions.net_d5_amount_max) document.getElementById('net-d5-amount-max').value = conditions.net_d5_amount_max;
    
    // Â∫îÁî®Âä®ÊÄÅÊù°‰ª∂
    if (conditions.dynamic_conditions && conditions.dynamic_conditions.length > 0) {
        conditions.dynamic_conditions.forEach(condition => {
            addDynamicCondition();
            const currentId = dynamicConditionCount;
            
            document.getElementById(`field-a-${currentId}`).value = condition.field_a;
            document.getElementById(`operator-${currentId}`).value = condition.operator;
            
            if (condition.field_b) {
                document.getElementById(`field-b-${currentId}`).value = condition.field_b;
            } else if (condition.value !== null) {
                document.getElementById(`field-b-${currentId}`).value = '__value__';
                document.getElementById(`value-${currentId}`).style.display = 'block';
                document.getElementById(`value-${currentId}`).value = condition.value;
            }
        });
    }
}

// ÂØºÂá∫ÁªìÊûú
function exportResults() {
    if (currentResults.length === 0) {
        alert('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÊï∞ÊçÆ');
        return;
    }
    
    // ËΩ¨Êç¢‰∏∫CSVÊ†ºÂºè
    const headers = ['ËÇ°Á•®‰ª£Á†Å', 'ËÇ°Á•®ÂêçÁß∞', 'Ë°å‰∏ö', 'Âú∞Âüü', 'Êî∂Áõò‰ª∑', 'Ê∂®Ë∑åÂπÖ(%)', 'PE', 'PB', 'ÊÄªÂ∏ÇÂÄº(‰∏á)', 'Êç¢ÊâãÁéá(%)', 'ÂáÄÊµÅÂÖ•(‰∏á)', 'Êï∞ÊçÆÊó•Êúü'];
    const csvContent = [
        headers.join(','),
        ...currentResults.map(stock => [
            stock.symbol || stock.ts_code,
            stock.stock_name || stock.name,
            stock.industry || '',
            stock.area || '',
            stock.daily_close || '',
            stock.factor_pct_change || '',
            stock.pe || '',
            stock.pb || '',
            stock.total_mv || '',
            stock.turnover_rate || '',
            stock.moneyflow_net_amount || '',
            stock.trade_date || ''
        ].join(','))
    ].join('\n');
    
    // ‰∏ãËΩΩÊñá‰ª∂
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ËÇ°Á•®Á≠õÈÄâÁªìÊûú_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// Ëé∑ÂèñÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂
function getCurrentCriteria() {
    const criteria = {
        // Âü∫Êú¨Êù°‰ª∂
        industry: document.getElementById('industry-filter').value,
        area: document.getElementById('area-filter').value,
        market: document.getElementById('market-filter').value,
        trade_date: document.getElementById('date-filter').value,
        
        // ‰º∞ÂÄºÊåáÊ†á
        pe_min: document.getElementById('pe-min').value,
        pe_max: document.getElementById('pe-max').value,
        pb_min: document.getElementById('pb-min').value,
        pb_max: document.getElementById('pb-max').value,
        ps_min: document.getElementById('ps-min').value,
        ps_max: document.getElementById('ps-max').value,
        dv_min: document.getElementById('dv-min').value,
        dv_max: document.getElementById('dv-max').value,
        
        // Â∏ÇÂÄºÂíå‰∫§Êòì
        mv_min: document.getElementById('mv-min').value,
        mv_max: document.getElementById('mv-max').value,
        circ_mv_min: document.getElementById('circ-mv-min').value,
        circ_mv_max: document.getElementById('circ-mv-max').value,
        turnover_min: document.getElementById('turnover-min').value,
        turnover_max: document.getElementById('turnover-max').value,
        volume_ratio_min: document.getElementById('volume-ratio-min').value,
        volume_ratio_max: document.getElementById('volume-ratio-max').value,
        
        // ÊäÄÊúØÊåáÊ†á
        rsi6_min: document.getElementById('rsi6-min').value,
        rsi6_max: document.getElementById('rsi6-max').value,
        kdj_k_min: document.getElementById('kdj-k-min').value,
        kdj_k_max: document.getElementById('kdj-k-max').value,
        macd_min: document.getElementById('macd-min').value,
        macd_max: document.getElementById('macd-max').value,
        cci_min: document.getElementById('cci-min').value,
        cci_max: document.getElementById('cci-max').value,
        
        // ËµÑÈáëÊµÅÂêë
        net_amount_min: document.getElementById('net-amount-min').value,
        net_amount_max: document.getElementById('net-amount-max').value,
        lg_buy_rate_min: document.getElementById('lg-buy-rate-min').value,
        lg_buy_rate_max: document.getElementById('lg-buy-rate-max').value,
        net_d5_amount_min: document.getElementById('net-d5-amount-min').value,
        net_d5_amount_max: document.getElementById('net-d5-amount-max').value
    };
    
    // Êî∂ÈõÜÂä®ÊÄÅÊü•ËØ¢Êù°‰ª∂
    const dynamicConditions = [];
    for (let i = 1; i <= dynamicConditionCount; i++) {
        const fieldA = document.getElementById(`field-a-${i}`);
        const operator = document.getElementById(`operator-${i}`);
        const fieldB = document.getElementById(`field-b-${i}`);
        const value = document.getElementById(`value-${i}`);
        
        if (fieldA && fieldA.value && operator && operator.value && fieldB && fieldB.value) {
            const condition = {
                field_a: fieldA.value,
                operator: operator.value,
                field_b: fieldB.value === '__value__' ? null : fieldB.value,
                value: fieldB.value === '__value__' ? value.value : null
            };
            
            // È™åËØÅÊù°‰ª∂ÂÆåÊï¥ÊÄß
            if (condition.field_b || condition.value) {
                dynamicConditions.push(condition);
            }
        }
    }
    
    criteria.dynamic_conditions = dynamicConditions;
    return criteria;
}

// ÊòæÁ§∫Êõ¥Â§öÁªìÊûúÊèêÁ§∫
function showMoreResultsHint() {
    const container = document.getElementById('screen-results');
    const hint = document.createElement('div');
    hint.className = 'alert alert-info mt-3';
    hint.innerHTML = '<i class="fas fa-info-circle"></i> ÁªìÊûúÂ∑≤ÈôêÂà∂Âú®200Êù°‰ª•ÂÜÖÔºåËØ∑‰ΩøÁî®Êõ¥Á≤æÁ°ÆÁöÑÁ≠õÈÄâÊù°‰ª∂Ëé∑ÂæóÊõ¥Â•ΩÁöÑÁªìÊûú„ÄÇ';
    container.appendChild(hint);
}

// Ê∑ªÂä†Âà∞ÊäÄÊúØÂàÜÊûê
function addToAnalysis(tsCode) {
    window.open(`/analysis?stock=${tsCode}`, '_blank');
}

// ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
function showLoading(containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Á≠õÈÄâ‰∏≠...</span>
            </div>
            <p class="mt-3 text-muted">Ê≠£Âú®Á≠õÈÄâËÇ°Á•®ÔºåËØ∑Á®çÂÄô...</p>
        </div>
    `;
}

// ÊòæÁ§∫ÈîôËØØ
function showError(containerId, message) {
    const container = document.getElementById(containerId);
    container.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}

// Â∑•ÂÖ∑ÂáΩÊï∞
function formatNumber(num, decimals = 2) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    return Number(num).toLocaleString('zh-CN', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

function formatPercent(num) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    const sign = num >= 0 ? '+' : '';
    return sign + Number(num).toFixed(2) + '%';
}
</script>
{% endblock %} 