{% extends "base.html" %}

{% block title %}{{ ts_code }} - è‚¡ç¥¨è¯¦æƒ… - è‚¡ç¥¨åˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ“Š è‚¡ç¥¨è¯¦æƒ…</h5>
                        <span class="badge bg-primary" id="stock-code">{{ ts_code }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="stock-info" class="row">
                        <div class="col-12 text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½è‚¡ç¥¨ä¿¡æ¯...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠŸèƒ½é€‰é¡¹å¡ -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="stockTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                        ğŸ“ˆ å†å²æ•°æ®
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="factors-tab" data-bs-toggle="tab" data-bs-target="#factors" type="button" role="tab">
                        ğŸ”¢ æŠ€æœ¯å› å­
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="moneyflow-tab" data-bs-toggle="tab" data-bs-target="#moneyflow" type="button" role="tab">
                        ğŸ’° èµ„é‡‘æµå‘
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cyq-tab" data-bs-toggle="tab" data-bs-target="#cyq" type="button" role="tab">
                        ğŸ¯ ç­¹ç åˆ†å¸ƒ
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="stockTabsContent">
                <!-- å†å²æ•°æ® -->
                <div class="tab-pane fade show active" id="history" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">å†å²ä»·æ ¼æ•°æ®</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="loadHistoryData(30)">30å¤©</button>
                                    <button type="button" class="btn btn-outline-primary active" onclick="loadHistoryData(60)">60å¤©</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="loadHistoryData(120)">120å¤©</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="history-content">
                                <div class="text-center py-4">
                                    <p class="text-muted">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½å†å²æ•°æ®</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æŠ€æœ¯å› å­ -->
                <div class="tab-pane fade" id="factors" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">æŠ€æœ¯å› å­æ•°æ®</h6>
                        </div>
                        <div class="card-body">
                            <div id="factors-content">
                                <div class="text-center py-4">
                                    <p class="text-muted">åˆ‡æ¢åˆ°æ­¤æ ‡ç­¾é¡µæ—¶è‡ªåŠ¨åŠ è½½</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- èµ„é‡‘æµå‘ -->
                <div class="tab-pane fade" id="moneyflow" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">èµ„é‡‘æµå‘æ•°æ®</h6>
                        </div>
                        <div class="card-body">
                            <div id="moneyflow-content">
                                <div class="text-center py-4">
                                    <p class="text-muted">åˆ‡æ¢åˆ°æ­¤æ ‡ç­¾é¡µæ—¶è‡ªåŠ¨åŠ è½½</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç­¹ç åˆ†å¸ƒ -->
                <div class="tab-pane fade" id="cyq" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">ç­¹ç åˆ†å¸ƒæ•°æ®</h6>
                        </div>
                        <div class="card-body">
                            <div id="cyq-content">
                                <div class="text-center py-4">
                                    <p class="text-muted">åˆ‡æ¢åˆ°æ­¤æ ‡ç­¾é¡µæ—¶è‡ªåŠ¨åŠ è½½</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const tsCode = '{{ ts_code }}';
let stockInfo = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadStockInfo();
    loadHistoryData(60); // é»˜è®¤åŠ è½½60å¤©æ•°æ®
    
    // ç»‘å®šæ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
    document.querySelectorAll('#stockTabs button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const target = event.target.getAttribute('data-bs-target');
            switch(target) {
                case '#factors':
                    loadFactorsData();
                    break;
                case '#moneyflow':
                    loadMoneyflowData();
                    break;
                case '#cyq':
                    loadCyqData();
                    break;
            }
        });
    });
});

// åŠ è½½è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
async function loadStockInfo() {
    try {
        const response = await apiRequest(`/stocks/${tsCode}`);
        if (response.code === 200) {
            stockInfo = response.data;
            renderStockInfo(stockInfo);
        } else {
            showError('stock-info', 'è‚¡ç¥¨ä¿¡æ¯åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        showError('stock-info', 'è‚¡ç¥¨ä¿¡æ¯åŠ è½½å¤±è´¥');
        console.error('åŠ è½½è‚¡ç¥¨ä¿¡æ¯å¤±è´¥:', error);
    }
}

// æ¸²æŸ“è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
function renderStockInfo(stock) {
    const container = document.getElementById('stock-info');
    
    const html = `
        <div class="col-md-8">
            <h3 class="mb-3">${stock.name} <small class="text-muted">(${stock.symbol})</small></h3>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">è‚¡ç¥¨ä»£ç :</span>
                        <strong>${stock.ts_code}</strong>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">è‚¡ç¥¨ç®€ç§°:</span>
                        <strong>${stock.symbol}</strong>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">æ‰€å±è¡Œä¸š:</span>
                        <span class="badge bg-secondary">${stock.industry || '--'}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">æ‰€å±åœ°åŸŸ:</span>
                        <span class="badge bg-info">${stock.area || '--'}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">ä¸Šå¸‚æ—¥æœŸ:</span>
                        <strong>${stock.list_date || '--'}</strong>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">å¸‚åœº:</span>
                        <span class="badge ${stock.ts_code.includes('SH') ? 'bg-danger' : 'bg-success'}">
                            ${stock.ts_code.includes('SH') ? 'ä¸Šæµ·' : 'æ·±åœ³'}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="text-center">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title">å¿«é€Ÿæ“ä½œ</h5>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="addToWatchlist()">
                                â­ åŠ å…¥è‡ªé€‰
                            </button>
                            <button class="btn btn-success btn-sm" onclick="openAnalysis()">
                                ğŸ“ˆ æŠ€æœ¯åˆ†æ
                            </button>
                            <button class="btn btn-info btn-sm" onclick="openBacktest()">
                                ğŸ“Š ç­–ç•¥å›æµ‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// åŠ è½½å†å²æ•°æ®
async function loadHistoryData(days = 60) {
    showLoading('history-content');
    
    try {
        const response = await apiRequest(`/stocks/${tsCode}/history?limit=${days}`);
        if (response.code === 200) {
            renderHistoryData(response.data, days);
        } else {
            showError('history-content', 'å†å²æ•°æ®åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        showError('history-content', 'å†å²æ•°æ®åŠ è½½å¤±è´¥');
        console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', error);
    }
}

// æ¸²æŸ“å†å²æ•°æ®
function renderHistoryData(data, days) {
    const container = document.getElementById('history-content');
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">æš‚æ— å†å²æ•°æ®</p></div>';
        return;
    }
    
    const html = `
        <div class="mb-3">
            <small class="text-muted">æœ€è¿‘ ${days} å¤©çš„å†å²æ•°æ®ï¼Œå…± ${data.length} æ¡è®°å½•ï¼ˆæŒ‰æ—¶é—´å€’åºï¼Œæœ€æ–°æ•°æ®åœ¨å‰ï¼‰</small>
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>å¼€ç›˜ä»·</th>
                        <th>æœ€é«˜ä»·</th>
                        <th>æœ€ä½ä»·</th>
                        <th>æ”¶ç›˜ä»·</th>
                        <th>æˆäº¤é‡(ä¸‡æ‰‹)</th>
                        <th>æˆäº¤é¢(ä¸‡å…ƒ)</th>
                        <th>æ¶¨è·Œå¹…</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.slice(0, 20).map(item => `
                        <tr>
                            <td><strong>${item.trade_date || '--'}</strong></td>
                            <td>${formatNumber(item.open, 2)}</td>
                            <td class="text-danger">${formatNumber(item.high, 2)}</td>
                            <td class="text-success">${formatNumber(item.low, 2)}</td>
                            <td class="text-primary"><strong>${formatNumber(item.close, 2)}</strong></td>
                            <td>${formatNumber((item.vol || 0) / 10000, 1)}</td>
                            <td>${formatNumber((item.amount || 0) / 10000, 0)}</td>
                            <td class="${(item.pct_chg || 0) >= 0 ? 'text-danger' : 'text-success'}">
                                <strong>${formatPercent(item.pct_chg || 0)}</strong>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        ${data.length > 20 ? `<div class="text-center"><small class="text-muted">ä»…æ˜¾ç¤ºå‰20æ¡è®°å½•</small></div>` : ''}
    `;
    
    container.innerHTML = html;
}

// åŠ è½½æŠ€æœ¯å› å­æ•°æ®
async function loadFactorsData() {
    if (document.getElementById('factors-content').innerHTML.includes('åŠ è½½ä¸­')) return;
    
    showLoading('factors-content');
    
    try {
        const response = await apiRequest(`/stocks/${tsCode}/factors?limit=20`);
        if (response.code === 200) {
            renderFactorsData(response.data);
        } else {
            showError('factors-content', 'æŠ€æœ¯å› å­æ•°æ®åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        showError('factors-content', 'æŠ€æœ¯å› å­æ•°æ®åŠ è½½å¤±è´¥');
        console.error('åŠ è½½æŠ€æœ¯å› å­æ•°æ®å¤±è´¥:', error);
    }
}

// æ¸²æŸ“æŠ€æœ¯å› å­æ•°æ®
function renderFactorsData(data) {
    const container = document.getElementById('factors-content');
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">æš‚æ— æŠ€æœ¯å› å­æ•°æ®</p></div>';
        return;
    }
    
    const html = `
        <div class="mb-3">
            <small class="text-muted">æŠ€æœ¯å› å­æ•°æ®ï¼Œå…± ${data.length} æ¡è®°å½•ï¼ˆæŒ‰æ—¶é—´å€’åºï¼Œæœ€æ–°æ•°æ®åœ¨å‰ï¼‰</small>
        </div>
        
        <!-- æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ“Š æŠ€æœ¯æŒ‡æ ‡è¶‹åŠ¿</h6>
                    </div>
                    <div class="card-body">
                        <div id="factors-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ“‹ è¯¦ç»†æ•°æ®</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ”¶ç›˜ä»·</th>
                                <th>MACD DIF</th>
                                <th>MACD DEA</th>
                                <th>MACD</th>
                                <th>KDJ K</th>
                                <th>KDJ D</th>
                                <th>KDJ J</th>
                                <th>RSI(6)</th>
                                <th>RSI(12)</th>
                                <th>RSI(24)</th>
                                <th>å¸ƒæ—ä¸Šè½¨</th>
                                <th>å¸ƒæ—ä¸­è½¨</th>
                                <th>å¸ƒæ—ä¸‹è½¨</th>
                                <th>CCI</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.slice(0, 20).map(item => `
                                <tr>
                                    <td><strong>${item.trade_date || '--'}</strong></td>
                                    <td class="text-primary"><strong>${formatNumber(item.close, 2)}</strong></td>
                                    <td class="${(item.macd_dif || 0) >= 0 ? 'text-danger' : 'text-success'}">${formatNumber(item.macd_dif, 4)}</td>
                                    <td class="${(item.macd_dea || 0) >= 0 ? 'text-danger' : 'text-success'}">${formatNumber(item.macd_dea, 4)}</td>
                                    <td class="${(item.macd || 0) >= 0 ? 'text-danger' : 'text-success'}">${formatNumber(item.macd, 4)}</td>
                                    <td>${formatNumber(item.kdj_k, 2)}</td>
                                    <td>${formatNumber(item.kdj_d, 2)}</td>
                                    <td class="${(item.kdj_j || 0) > 80 ? 'text-danger' : (item.kdj_j || 0) < 20 ? 'text-success' : ''}">${formatNumber(item.kdj_j, 2)}</td>
                                    <td class="${(item.rsi_6 || 0) > 70 ? 'text-danger' : (item.rsi_6 || 0) < 30 ? 'text-success' : ''}">${formatNumber(item.rsi_6, 2)}</td>
                                    <td class="${(item.rsi_12 || 0) > 70 ? 'text-danger' : (item.rsi_12 || 0) < 30 ? 'text-success' : ''}">${formatNumber(item.rsi_12, 2)}</td>
                                    <td class="${(item.rsi_24 || 0) > 70 ? 'text-danger' : (item.rsi_24 || 0) < 30 ? 'text-success' : ''}">${formatNumber(item.rsi_24, 2)}</td>
                                    <td class="text-danger">${formatNumber(item.boll_upper, 2)}</td>
                                    <td class="text-warning">${formatNumber(item.boll_mid, 2)}</td>
                                    <td class="text-success">${formatNumber(item.boll_lower, 2)}</td>
                                    <td class="${(item.cci || 0) > 100 ? 'text-danger' : (item.cci || 0) < -100 ? 'text-success' : ''}">${formatNumber(item.cci, 2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${data.length > 20 ? `<div class="text-center mt-3"><small class="text-muted">ä»…æ˜¾ç¤ºå‰20æ¡è®°å½•</small></div>` : ''}
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // æ¸²æŸ“æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
    renderFactorsChart(data);
}

// æ¸²æŸ“æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨
function renderFactorsChart(data) {
    const factorsChart = echarts.init(document.getElementById('factors-chart'));
    
    // æ•°æ®éœ€è¦åè½¬ï¼Œå› ä¸ºEChartsæœŸæœ›æ—¶é—´æ­£åº
    const reversedData = [...data].reverse();
    const dates = reversedData.map(item => item.trade_date);
    
    const factorsOption = {
        title: {
            text: 'æŠ€æœ¯æŒ‡æ ‡è¶‹åŠ¿',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                let result = params[0].name + '<br/>';
                params.forEach(param => {
                    result += param.marker + param.seriesName + ': ' + formatNumber(param.value, 4) + '<br/>';
                });
                return result;
            }
        },
        legend: {
            data: ['MACD DIF', 'MACD DEA', 'MACD', 'RSI(6)', 'RSI(12)', 'KDJ K', 'KDJ D'],
            top: 30,
            type: 'scroll'
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates,
            axisLabel: {
                rotate: 45
            }
        },
        yAxis: [
            {
                type: 'value',
                name: 'MACD',
                position: 'left',
                axisLabel: {
                    formatter: function(value) {
                        return formatNumber(value, 4);
                    }
                }
            },
            {
                type: 'value',
                name: 'RSI/KDJ',
                position: 'right',
                min: 0,
                max: 100,
                axisLabel: {
                    formatter: function(value) {
                        return value + '';
                    }
                }
            }
        ],
        dataZoom: [
            {
                type: 'inside',
                start: 70,
                end: 100
            },
            {
                show: true,
                type: 'slider',
                top: '90%',
                start: 70,
                end: 100
            }
        ],
        series: [
            {
                name: 'MACD DIF',
                type: 'line',
                yAxisIndex: 0,
                data: reversedData.map(item => item.macd_dif || 0),
                itemStyle: { color: '#ff4d4f' },
                lineStyle: { width: 2 }
            },
            {
                name: 'MACD DEA',
                type: 'line',
                yAxisIndex: 0,
                data: reversedData.map(item => item.macd_dea || 0),
                itemStyle: { color: '#52c41a' },
                lineStyle: { width: 2 }
            },
            {
                name: 'MACD',
                type: 'bar',
                yAxisIndex: 0,
                data: reversedData.map(item => item.macd || 0),
                itemStyle: {
                    color: function(params) {
                        return params.value >= 0 ? '#ff4d4f' : '#52c41a';
                    }
                }
            },
            {
                name: 'RSI(6)',
                type: 'line',
                yAxisIndex: 1,
                data: reversedData.map(item => item.rsi_6 || 0),
                itemStyle: { color: '#1890ff' }
            },
            {
                name: 'RSI(12)',
                type: 'line',
                yAxisIndex: 1,
                data: reversedData.map(item => item.rsi_12 || 0),
                itemStyle: { color: '#722ed1' }
            },
            {
                name: 'KDJ K',
                type: 'line',
                yAxisIndex: 1,
                data: reversedData.map(item => item.kdj_k || 0),
                itemStyle: { color: '#fa8c16' }
            },
            {
                name: 'KDJ D',
                type: 'line',
                yAxisIndex: 1,
                data: reversedData.map(item => item.kdj_d || 0),
                itemStyle: { color: '#13c2c2' }
            }
        ]
    };
    
    factorsChart.setOption(factorsOption);
    
    // å“åº”å¼è°ƒæ•´
    window.addEventListener('resize', function() {
        factorsChart.resize();
    });
}

// åŠ è½½èµ„é‡‘æµå‘æ•°æ®
async function loadMoneyflowData() {
    if (document.getElementById('moneyflow-content').innerHTML.includes('åŠ è½½ä¸­')) return;
    
    showLoading('moneyflow-content');
    
    try {
        const response = await apiRequest(`/stocks/${tsCode}/moneyflow?limit=20`);
        if (response.code === 200) {
            renderMoneyflowData(response.data);
        } else {
            showError('moneyflow-content', 'èµ„é‡‘æµå‘æ•°æ®åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        showError('moneyflow-content', 'èµ„é‡‘æµå‘æ•°æ®åŠ è½½å¤±è´¥');
        console.error('åŠ è½½èµ„é‡‘æµå‘æ•°æ®å¤±è´¥:', error);
    }
}

// æ¸²æŸ“èµ„é‡‘æµå‘æ•°æ®
function renderMoneyflowData(data) {
    const container = document.getElementById('moneyflow-content');
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">æš‚æ— èµ„é‡‘æµå‘æ•°æ®</p></div>';
        return;
    }
    
    const html = `
        <div class="mb-3">
            <small class="text-muted">èµ„é‡‘æµå‘æ•°æ®ï¼Œå…± ${data.length} æ¡è®°å½•</small>
        </div>
        
        <!-- èµ„é‡‘æµå‘å›¾è¡¨ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ“Š åˆ†å•èµ„é‡‘ä¹°å–å¯¹æ¯”</h6>
                    </div>
                    <div class="card-body">
                        <div id="moneyflow-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ“ˆ å‡€æµå…¥è¶‹åŠ¿</h6>
                    </div>
                    <div class="card-body">
                        <div id="netflow-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- èµ„é‡‘å½¢æ€æŒ‡æ ‡ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ’° èµ„é‡‘å½¢æ€æŒ‡æ ‡</h6>
                    </div>
                    <div class="card-body">
                        <div class="row" id="money-indicators">
                            <!-- åŠ¨æ€ç”ŸæˆæŒ‡æ ‡å¡ç‰‡ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ“‹ è¯¦ç»†æ•°æ®</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>å‡€æµå…¥é¢</th>
                                <th>ç‰¹å¤§å•ä¹°å…¥</th>
                                <th>ç‰¹å¤§å•å–å‡º</th>
                                <th>å¤§å•ä¹°å…¥</th>
                                <th>å¤§å•å–å‡º</th>
                                <th>ä¸­å•ä¹°å…¥</th>
                                <th>ä¸­å•å–å‡º</th>
                                <th>å°å•ä¹°å…¥</th>
                                <th>å°å•å–å‡º</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.slice(0, 10).map(item => `
                                <tr>
                                    <td>${item.trade_date || '--'}</td>
                                    <td class="${(item.net_mf_amount || 0) >= 0 ? 'text-danger' : 'text-success'}">
                                        <strong>${formatNumber(item.net_mf_amount, 0)}</strong>
                                    </td>
                                    <td class="text-danger">${formatNumber(item.buy_elg_amount, 0)}</td>
                                    <td class="text-success">${formatNumber(item.sell_elg_amount, 0)}</td>
                                    <td class="text-danger">${formatNumber(item.buy_lg_amount, 0)}</td>
                                    <td class="text-success">${formatNumber(item.sell_lg_amount, 0)}</td>
                                    <td class="text-danger">${formatNumber(item.buy_md_amount, 0)}</td>
                                    <td class="text-success">${formatNumber(item.sell_md_amount, 0)}</td>
                                    <td class="text-danger">${formatNumber(item.buy_sm_amount, 0)}</td>
                                    <td class="text-success">${formatNumber(item.sell_sm_amount, 0)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // æ¸²æŸ“å›¾è¡¨
    renderMoneyflowCharts(data);
}

// æ¸²æŸ“èµ„é‡‘æµå‘å›¾è¡¨
function renderMoneyflowCharts(data) {
    // åˆ†å•èµ„é‡‘ä¹°å–å¯¹æ¯”å›¾
    const moneyflowChart = echarts.init(document.getElementById('moneyflow-chart'));
    
    const dates = data.map(item => item.trade_date).reverse();
    const latestData = data[0]; // æœ€æ–°ä¸€å¤©çš„æ•°æ®
    
    // åˆ†å•ä¹°å–å¯¹æ¯”ï¼ˆæœ€æ–°ä¸€å¤©ï¼‰
    const moneyflowOption = {
        title: {
            text: 'åˆ†å•èµ„é‡‘ä¹°å–å¯¹æ¯”',
            subtext: `${latestData.trade_date}`,
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: function(params) {
                let result = params[0].name + '<br/>';
                params.forEach(param => {
                    const value = Math.abs(param.value);
                    result += param.marker + param.seriesName + ': ' + formatNumber(value, 0) + 'ä¸‡<br/>';
                });
                return result;
            }
        },
        legend: {
            data: ['ä¹°å…¥', 'å–å‡º'],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: ['ç‰¹å¤§å•', 'å¤§å•', 'ä¸­å•', 'å°å•']
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: function(value) {
                    return formatNumber(Math.abs(value), 0) + 'ä¸‡';
                }
            }
        },
        series: [
            {
                name: 'ä¹°å…¥',
                type: 'bar',
                data: [
                    latestData.buy_elg_amount || 0,
                    latestData.buy_lg_amount || 0,
                    latestData.buy_md_amount || 0,
                    latestData.buy_sm_amount || 0
                ],
                itemStyle: {
                    color: '#ff4d4f'
                }
            },
            {
                name: 'å–å‡º',
                type: 'bar',
                data: [
                    -(latestData.sell_elg_amount || 0),
                    -(latestData.sell_lg_amount || 0),
                    -(latestData.sell_md_amount || 0),
                    -(latestData.sell_sm_amount || 0)
                ],
                itemStyle: {
                    color: '#52c41a'
                }
            }
        ]
    };
    
    moneyflowChart.setOption(moneyflowOption);
    
    // å‡€æµå…¥è¶‹åŠ¿å›¾
    const netflowChart = echarts.init(document.getElementById('netflow-chart'));
    
    const netflowOption = {
        title: {
            text: 'å‡€æµå…¥è¶‹åŠ¿',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                const data = params[0];
                return `${data.name}<br/>å‡€æµå…¥: ${formatNumber(data.value, 0)}ä¸‡`;
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates,
            axisLabel: {
                rotate: 45
            }
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: function(value) {
                    return formatNumber(value, 0) + 'ä¸‡';
                }
            }
        },
        series: [{
            name: 'å‡€æµå…¥',
            type: 'line',
            data: data.map(item => item.net_mf_amount || 0).reverse(),
            itemStyle: {
                color: '#1890ff'
            },
            areaStyle: {
                color: {
                    type: 'linear',
                    x: 0,
                    y: 0,
                    x2: 0,
                    y2: 1,
                    colorStops: [{
                        offset: 0, color: 'rgba(24, 144, 255, 0.3)'
                    }, {
                        offset: 1, color: 'rgba(24, 144, 255, 0.1)'
                    }]
                }
            }
        }]
    };
    
    netflowChart.setOption(netflowOption);
    
    // æ¸²æŸ“èµ„é‡‘å½¢æ€æŒ‡æ ‡
    renderMoneyIndicators(latestData);
    
    // å“åº”å¼è°ƒæ•´
    window.addEventListener('resize', function() {
        moneyflowChart.resize();
        netflowChart.resize();
    });
}

// æ¸²æŸ“èµ„é‡‘å½¢æ€æŒ‡æ ‡
function renderMoneyIndicators(data) {
    const container = document.getElementById('money-indicators');
    
    // è®¡ç®—å„ç§æŒ‡æ ‡
    const totalBuy = (data.buy_elg_amount || 0) + (data.buy_lg_amount || 0) + (data.buy_md_amount || 0) + (data.buy_sm_amount || 0);
    const totalSell = (data.sell_elg_amount || 0) + (data.sell_lg_amount || 0) + (data.sell_md_amount || 0) + (data.sell_sm_amount || 0);
    const mainBuy = (data.buy_elg_amount || 0) + (data.buy_lg_amount || 0); // ä¸»åŠ›ä¹°å…¥ï¼ˆç‰¹å¤§å•+å¤§å•ï¼‰
    const mainSell = (data.sell_elg_amount || 0) + (data.sell_lg_amount || 0); // ä¸»åŠ›å–å‡º
    
    const lgBuyRate = totalBuy > 0 ? ((data.buy_lg_amount || 0) / totalBuy * 100) : 0;
    const elgBuyRate = totalBuy > 0 ? ((data.buy_elg_amount || 0) / totalBuy * 100) : 0;
    const mainNetFlow = mainBuy - mainSell;
    
    const html = `
        <div class="col-md-3">
            <div class="text-center p-3 bg-light rounded">
                <h5 class="text-primary">${formatNumber(data.net_mf_amount || 0, 0)}</h5>
                <small class="text-muted">å‡€æµå…¥é¢(ä¸‡)</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 bg-light rounded">
                <h5 class="text-success">${formatNumber(lgBuyRate, 1)}%</h5>
                <small class="text-muted">å¤§å•ä¹°å…¥å æ¯”</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 bg-light rounded">
                <h5 class="text-warning">${formatNumber(elgBuyRate, 1)}%</h5>
                <small class="text-muted">ç‰¹å¤§å•ä¹°å…¥å æ¯”</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 bg-light rounded">
                <h5 class="${mainNetFlow >= 0 ? 'text-danger' : 'text-success'}">${formatNumber(mainNetFlow, 0)}</h5>
                <small class="text-muted">ä¸»åŠ›å‡€æµå…¥(ä¸‡)</small>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// åŠ è½½ç­¹ç åˆ†å¸ƒæ•°æ®
async function loadCyqData() {
    if (document.getElementById('cyq-content').innerHTML.includes('åŠ è½½ä¸­')) return;
    
    showLoading('cyq-content');
    
    try {
        const response = await apiRequest(`/stocks/${tsCode}/cyq?limit=20`);
        if (response.code === 200) {
            renderCyqData(response.data);
        } else {
            showError('cyq-content', 'ç­¹ç åˆ†å¸ƒæ•°æ®åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        showError('cyq-content', 'ç­¹ç åˆ†å¸ƒæ•°æ®åŠ è½½å¤±è´¥');
        console.error('åŠ è½½ç­¹ç åˆ†å¸ƒæ•°æ®å¤±è´¥:', error);
    }
}

// æ¸²æŸ“ç­¹ç åˆ†å¸ƒæ•°æ®
function renderCyqData(data) {
    const container = document.getElementById('cyq-content');
    
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">æš‚æ— ç­¹ç åˆ†å¸ƒæ•°æ®</p></div>';
        return;
    }
    
    const html = `
        <div class="mb-3">
            <small class="text-muted">ç­¹ç åˆ†å¸ƒæ•°æ®ï¼Œå…± ${data.length} æ¡è®°å½•</small>
        </div>
        
        <!-- ç­¹ç åˆ†å¸ƒå›¾è¡¨ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ“Š æˆæœ¬åˆ†ä½æ›²çº¿</h6>
                    </div>
                    <div class="card-body">
                        <div id="cost-distribution-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ“ˆ èƒœç‡å˜åŒ–</h6>
                    </div>
                    <div class="card-body">
                        <div id="winner-rate-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç­¹ç åˆ†ææŒ‡æ ‡ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">ğŸ¯ ç­¹ç åˆ†ææŒ‡æ ‡</h6>
                    </div>
                    <div class="card-body">
                        <div class="row" id="cyq-indicators">
                            <!-- åŠ¨æ€ç”ŸæˆæŒ‡æ ‡å¡ç‰‡ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ“‹ è¯¦ç»†æ•°æ®</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>å†å²æœ€ä½</th>
                                <th>å†å²æœ€é«˜</th>
                                <th>5%æˆæœ¬</th>
                                <th>15%æˆæœ¬</th>
                                <th>50%æˆæœ¬</th>
                                <th>85%æˆæœ¬</th>
                                <th>95%æˆæœ¬</th>
                                <th>åŠ æƒå¹³å‡</th>
                                <th>èƒœç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.slice(0, 10).map(item => `
                                <tr>
                                    <td>${item.trade_date || '--'}</td>
                                    <td class="text-success">${formatNumber(item.his_low, 2)}</td>
                                    <td class="text-danger">${formatNumber(item.his_high, 2)}</td>
                                    <td>${formatNumber(item.cost_5pct, 2)}</td>
                                    <td>${formatNumber(item.cost_15pct, 2)}</td>
                                    <td><strong>${formatNumber(item.cost_50pct, 2)}</strong></td>
                                    <td>${formatNumber(item.cost_85pct, 2)}</td>
                                    <td>${formatNumber(item.cost_95pct, 2)}</td>
                                    <td class="text-primary"><strong>${formatNumber(item.weight_avg, 2)}</strong></td>
                                    <td class="${(item.winner_rate || 0) >= 50 ? 'text-success' : 'text-danger'}">
                                        <strong>${formatPercent(item.winner_rate || 0)}</strong>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // æ¸²æŸ“å›¾è¡¨
    renderCyqCharts(data);
}

// æ¸²æŸ“ç­¹ç åˆ†å¸ƒå›¾è¡¨
function renderCyqCharts(data) {
    // æˆæœ¬åˆ†ä½æ›²çº¿å›¾
    const costChart = echarts.init(document.getElementById('cost-distribution-chart'));
    
    const dates = data.map(item => item.trade_date).reverse();
    
    const costOption = {
        title: {
            text: 'æˆæœ¬åˆ†ä½æ›²çº¿',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                let result = params[0].name + '<br/>';
                params.forEach(param => {
                    result += param.marker + param.seriesName + ': ' + formatNumber(param.value, 2) + '<br/>';
                });
                return result;
            }
        },
        legend: {
            data: ['5%æˆæœ¬', '15%æˆæœ¬', '50%æˆæœ¬', '85%æˆæœ¬', '95%æˆæœ¬', 'åŠ æƒå¹³å‡'],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates,
            axisLabel: {
                rotate: 45
            }
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: function(value) {
                    return formatNumber(value, 2);
                }
            }
        },
        series: [
            {
                name: '5%æˆæœ¬',
                type: 'line',
                data: data.map(item => item.cost_5pct || 0).reverse(),
                itemStyle: { color: '#ff7875' }
            },
            {
                name: '15%æˆæœ¬',
                type: 'line',
                data: data.map(item => item.cost_15pct || 0).reverse(),
                itemStyle: { color: '#ffa940' }
            },
            {
                name: '50%æˆæœ¬',
                type: 'line',
                data: data.map(item => item.cost_50pct || 0).reverse(),
                itemStyle: { color: '#1890ff' },
                lineStyle: { width: 3 }
            },
            {
                name: '85%æˆæœ¬',
                type: 'line',
                data: data.map(item => item.cost_85pct || 0).reverse(),
                itemStyle: { color: '#73d13d' }
            },
            {
                name: '95%æˆæœ¬',
                type: 'line',
                data: data.map(item => item.cost_95pct || 0).reverse(),
                itemStyle: { color: '#b37feb' }
            },
            {
                name: 'åŠ æƒå¹³å‡',
                type: 'line',
                data: data.map(item => item.weight_avg || 0).reverse(),
                itemStyle: { color: '#f759ab' },
                lineStyle: { width: 2, type: 'dashed' }
            }
        ]
    };
    
    costChart.setOption(costOption);
    
    // èƒœç‡å˜åŒ–å›¾
    const winnerChart = echarts.init(document.getElementById('winner-rate-chart'));
    
    const winnerOption = {
        title: {
            text: 'èƒœç‡å˜åŒ–',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                const data = params[0];
                return `${data.name}<br/>èƒœç‡: ${formatPercent(data.value)}`;
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates,
            axisLabel: {
                rotate: 45
            }
        },
        yAxis: {
            type: 'value',
            min: 0,
            max: 100,
            axisLabel: {
                formatter: function(value) {
                    return value + '%';
                }
            }
        },
        series: [{
            name: 'èƒœç‡',
            type: 'line',
            data: data.map(item => item.winner_rate || 0).reverse(),
            itemStyle: {
                color: '#52c41a'
            },
            areaStyle: {
                color: {
                    type: 'linear',
                    x: 0,
                    y: 0,
                    x2: 0,
                    y2: 1,
                    colorStops: [{
                        offset: 0, color: 'rgba(82, 196, 26, 0.3)'
                    }, {
                        offset: 1, color: 'rgba(82, 196, 26, 0.1)'
                    }]
                }
            },
            markLine: {
                data: [
                    { yAxis: 50, name: '50%åŸºå‡†çº¿' }
                ],
                lineStyle: {
                    color: '#ff4d4f',
                    type: 'dashed'
                }
            }
        }]
    };
    
    winnerChart.setOption(winnerOption);
    
    // æ¸²æŸ“ç­¹ç åˆ†ææŒ‡æ ‡
    renderCyqIndicators(data[0]); // æœ€æ–°æ•°æ®
    
    // å“åº”å¼è°ƒæ•´
    window.addEventListener('resize', function() {
        costChart.resize();
        winnerChart.resize();
    });
}

// æ¸²æŸ“ç­¹ç åˆ†ææŒ‡æ ‡
function renderCyqIndicators(data) {
    const container = document.getElementById('cyq-indicators');
    
    // è®¡ç®—ç­¹ç é›†ä¸­åº¦ï¼ˆ95%æˆæœ¬ - 5%æˆæœ¬ï¼‰/ 50%æˆæœ¬
    const concentration = data.cost_95pct && data.cost_5pct && data.cost_50pct ? 
        ((data.cost_95pct - data.cost_5pct) / data.cost_50pct * 100) : 0;
    
    // è®¡ç®—å½“å‰ä»·æ ¼ç›¸å¯¹ä½ç½®ï¼ˆéœ€è¦ä»è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯è·å–å½“å‰ä»·æ ¼ï¼‰
    const currentPrice = stockInfo?.latest_daily?.close || 0;
    const pricePosition = data.cost_95pct && data.cost_5pct ? 
        ((currentPrice - data.cost_5pct) / (data.cost_95pct - data.cost_5pct) * 100) : 0;
    
    const html = `
        <div class="col-md-3">
            <div class="text-center p-3 bg-light rounded">
                <h5 class="text-primary">${formatNumber(concentration, 1)}%</h5>
                <small class="text-muted">ç­¹ç é›†ä¸­åº¦</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 bg-light rounded">
                <h5 class="text-success">${formatNumber(data.weight_avg || 0, 2)}</h5>
                <small class="text-muted">åŠ æƒå¹³å‡æˆæœ¬</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 bg-light rounded">
                <h5 class="${(data.winner_rate || 0) >= 50 ? 'text-success' : 'text-danger'}">${formatPercent(data.winner_rate || 0)}</h5>
                <small class="text-muted">å½“å‰èƒœç‡</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 bg-light rounded">
                <h5 class="text-warning">${formatNumber(pricePosition, 1)}%</h5>
                <small class="text-muted">ä»·æ ¼ç›¸å¯¹ä½ç½®</small>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// å¿«é€Ÿæ“ä½œå‡½æ•°
function addToWatchlist() {
    alert(`å·²å°† ${stockInfo?.name || tsCode} åŠ å…¥è‡ªé€‰è‚¡`);
}

function openAnalysis() {
    window.open(`/analysis?stock=${tsCode}`, '_blank');
}

function openBacktest() {
    window.open(`/backtest?stock=${tsCode}`, '_blank');
}

// å·¥å…·å‡½æ•°
function formatNumber(num, decimals = 2) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    return Number(num).toLocaleString('zh-CN', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

function formatPercent(num) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    const sign = num >= 0 ? '+' : '';
    return sign + Number(num).toFixed(2) + '%';
}

// AIåˆ†æç›¸å…³å‡½æ•°
let currentAIAnalysis = null;

// åˆå§‹åŒ–AIåˆ†æTab
function initAIAnalysisTab() {
    // Tabåˆ‡æ¢æ—¶ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œç”¨æˆ·ç‚¹å‡»æŒ‰é’®è§¦å‘åˆ†æ
    console.log('AIåˆ†æTabå·²æ¿€æ´»');
}

// å¼€å§‹AIåˆ†æ
async function startAIAnalysis(depth = 'standard') {
    const container = document.getElementById('ai-summary-content');

    // æ˜¾ç¤ºåˆ†æè¿›è¡Œä¸­çš„ç•Œé¢
    showAIAnalysisLoading(container, depth);

    try {
        // æ„å»ºåˆ†æè¯·æ±‚
        const requestData = {
            stock_code: tsCode,
            config: {
                analysts: ['market', 'fundamentals', 'news'],
                depth: depth,
                llm_provider: 'dashscope',
                model: depth === 'quick' ? 'qwen-turbo' : 'qwen-plus',
                include_quantitative_data: true
            }
        };

        // å‘é€åˆ†æè¯·æ±‚åˆ°TradingAgents-CN API
        const response = await fetch('http://localhost:8000/api/v1/analyze_stock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (result.success) {
            currentAIAnalysis = result.data;
            renderAIAnalysisResult(container, result.data);

            // æ˜¾ç¤ºè¯¦ç»†åˆ†æå’Œå›æµ‹éƒ¨åˆ†
            document.getElementById('multi-agent-details').style.display = 'block';
            document.getElementById('ai-backtest-section').style.display = 'block';

            // æ¸²æŸ“å¤šæ™ºèƒ½ä½“åˆ†æè¯¦æƒ…
            renderMultiAgentDetails(result.data);

            // æ¸²æŸ“AIå†³ç­–å›æµ‹å›¾è¡¨
            renderAIBacktestChart(result.data);
        } else {
            showAIAnalysisError(container, result.error || 'åˆ†æå¤±è´¥');
        }

    } catch (error) {
        console.error('AIåˆ†æå¤±è´¥:', error);
        showAIAnalysisError(container, 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥AIæœåŠ¡æ˜¯å¦å¯åŠ¨');
    }
}

// æ˜¾ç¤ºAIåˆ†æåŠ è½½çŠ¶æ€
function showAIAnalysisLoading(container, depth) {
    const depthText = {
        'quick': 'å¿«é€Ÿåˆ†æ',
        'standard': 'æ ‡å‡†åˆ†æ',
        'deep': 'æ·±åº¦åˆ†æ'
    };

    const estimatedTime = {
        'quick': '1-2åˆ†é’Ÿ',
        'standard': '2-3åˆ†é’Ÿ',
        'deep': '3-5åˆ†é’Ÿ'
    };

    container.innerHTML = `
        <div class="text-center py-5">
            <div class="mb-4">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">åˆ†æä¸­...</span>
                </div>
            </div>
            <h5 class="text-primary">ğŸ¤– AIæ­£åœ¨åˆ†æä¸­...</h5>
            <p class="text-muted">æ­£åœ¨è¿›è¡Œ${depthText[depth]}ï¼Œé¢„è®¡éœ€è¦ ${estimatedTime[depth]}</p>
            <div class="progress mx-auto" style="width: 300px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 100%"></div>
            </div>
            <div class="mt-4">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    AIæ­£åœ¨è°ƒç”¨å¤šä¸ªæ™ºèƒ½ä½“è¿›è¡ŒååŒåˆ†æï¼Œè¯·è€å¿ƒç­‰å¾…...
                </small>
            </div>
        </div>
    `;
}

// æ˜¾ç¤ºAIåˆ†æé”™è¯¯
function showAIAnalysisError(container, message) {
    container.innerHTML = `
        <div class="text-center py-5">
            <div class="mb-3">
                <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
            </div>
            <h5 class="text-warning">åˆ†æå¤±è´¥</h5>
            <p class="text-muted">${message}</p>
            <button class="btn btn-primary" onclick="startAIAnalysis('quick')">
                é‡æ–°åˆ†æ
            </button>
        </div>
    `;
}

// æ¸²æŸ“AIåˆ†æç»“æœæ‘˜è¦
function renderAIAnalysisResult(container, data) {
    const ratingColor = {
        'BUY': 'success',
        'STRONG_BUY': 'success',
        'SELL': 'danger',
        'STRONG_SELL': 'danger',
        'HOLD': 'warning'
    };

    const ratingText = {
        'BUY': 'ä¹°å…¥',
        'STRONG_BUY': 'å¼ºçƒˆä¹°å…¥',
        'SELL': 'å–å‡º',
        'STRONG_SELL': 'å¼ºçƒˆå–å‡º',
        'HOLD': 'æŒæœ‰'
    };

    const color = ratingColor[data.overall_rating] || 'secondary';
    const rating = ratingText[data.overall_rating] || data.overall_rating;

    container.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h3 class="text-${color} mb-2">${rating}</h3>
                            <small class="text-muted">ç»¼åˆè¯„çº§</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h3 class="text-${color} mb-2">${(data.confidence_score * 100).toFixed(0)}%</h3>
                            <small class="text-muted">ä¿¡å¿ƒæŒ‡æ•°</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h3 class="text-primary mb-2">${data.target_price ? 'Â¥' + data.target_price.toFixed(2) : '--'}</h3>
                            <small class="text-muted">AIç›®æ ‡ä»·</small>
                        </div>
                    </div>
                </div>
                <div class="alert alert-${color} border-0">
                    <h6><i class="fas fa-lightbulb me-2"></i>ä¸€å¥è¯æ€»ç»“</h6>
                    <p class="mb-0">${data.summary}</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <canvas id="confidence-gauge" width="200" height="200"></canvas>
                </div>
            </div>
        </div>
    `;

    // æ¸²æŸ“ä¿¡å¿ƒæŒ‡æ•°ä»ªè¡¨ç›˜
    renderConfidenceGauge(data.confidence_score, data.risk_score);
}

// æ¸²æŸ“å¤šæ™ºèƒ½ä½“åˆ†æè¯¦æƒ…
function renderMultiAgentDetails(data) {
    const container = document.getElementById('agentAnalysisAccordion');

    if (!data.agents_opinions || data.agents_opinions.length === 0) {
        container.innerHTML = '<p class="text-muted text-center py-3">æš‚æ— æ™ºèƒ½ä½“åˆ†æè¯¦æƒ…</p>';
        return;
    }

    const agentIcons = {
        'market': 'ğŸ“ˆ',
        'fundamentals': 'ğŸ¢',
        'news': 'ğŸ“°',
        'social': 'ğŸ’¬'
    };

    const agentNames = {
        'market': 'æŠ€æœ¯åˆ†æå¸ˆ',
        'fundamentals': 'åŸºæœ¬é¢åˆ†æå¸ˆ',
        'news': 'æ–°é—»åˆ†æå¸ˆ',
        'social': 'ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ'
    };

    const accordionHTML = data.agents_opinions.map((opinion, index) => {
        const icon = agentIcons[opinion.agent_type] || 'ğŸ¤–';
        const name = agentNames[opinion.agent_type] || opinion.agent_type;
        const isFirst = index === 0;

        return `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${index}">
                    <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                        ${icon} ${name}
                        <span class="badge bg-primary ms-2">è¯„åˆ†: ${opinion.score.toFixed(2)}</span>
                        <span class="badge bg-success ms-1">ç½®ä¿¡åº¦: ${(opinion.confidence * 100).toFixed(0)}%</span>
                    </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}"
                     data-bs-parent="#agentAnalysisAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>åˆ†æè§‚ç‚¹</h6>
                                <p>${opinion.opinion}</p>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center">
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar bg-primary" style="width: ${opinion.score * 20}%">
                                            ${opinion.score.toFixed(2)}
                                        </div>
                                    </div>
                                    <small class="text-muted">è¯„åˆ† (0-5)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = accordionHTML;
}

// æ¸²æŸ“ä¿¡å¿ƒæŒ‡æ•°ä»ªè¡¨ç›˜
function renderConfidenceGauge(confidence, risk) {
    const canvas = document.getElementById('confidence-gauge');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const radius = 80;

    // æ¸…ç©ºç”»å¸ƒ
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // ç»˜åˆ¶èƒŒæ™¯åœ†
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 12;
    ctx.stroke();

    // ç»˜åˆ¶ä¿¡å¿ƒæŒ‡æ•°å¼§
    const confidenceAngle = (confidence * 2 * Math.PI) - Math.PI / 2;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, -Math.PI / 2, confidenceAngle);
    ctx.strokeStyle = confidence > 0.7 ? '#28a745' : confidence > 0.5 ? '#ffc107' : '#dc3545';
    ctx.lineWidth = 12;
    ctx.stroke();

    // ç»˜åˆ¶ä¸­å¿ƒæ–‡å­—
    ctx.fillStyle = '#333';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${(confidence * 100).toFixed(0)}%`, centerX, centerY + 8);

    // ç»˜åˆ¶æ ‡ç­¾
    ctx.font = '14px Arial';
    ctx.fillStyle = '#666';
    ctx.fillText('ä¿¡å¿ƒæŒ‡æ•°', centerX, centerY + 30);
}

// æ¸²æŸ“AIå†³ç­–å›æµ‹å›¾è¡¨
function renderAIBacktestChart(data) {
    const canvas = document.getElementById('aiBacktestChart');
    if (!canvas) return;

    // è¿™é‡Œåº”è¯¥ä½¿ç”¨çœŸå®çš„å›æµ‹æ•°æ®ï¼Œç°åœ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    const mockBacktestData = generateMockBacktestData();

    const ctx = canvas.getContext('2d');

    // ä½¿ç”¨Chart.jsåˆ›å»ºå›¾è¡¨
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: mockBacktestData.dates,
            datasets: [
                {
                    label: 'AIç­–ç•¥æ”¶ç›Š',
                    data: mockBacktestData.aiStrategy,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 3,
                    fill: false
                },
                {
                    label: 'æŒè‚¡ä¸åŠ¨',
                    data: mockBacktestData.buyHold,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: false
                },
                {
                    label: 'åŸºå‡†æŒ‡æ•°',
                    data: mockBacktestData.benchmark,
                    borderColor: '#6c757d',
                    backgroundColor: 'rgba(108, 117, 125, 0.1)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'AIå†³ç­–ç­–ç•¥å›æµ‹å¯¹æ¯”'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'ç´¯è®¡æ”¶ç›Šç‡ (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + '%';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'æ—¥æœŸ'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// ç”Ÿæˆæ¨¡æ‹Ÿå›æµ‹æ•°æ®
function generateMockBacktestData() {
    const dates = [];
    const aiStrategy = [];
    const buyHold = [];
    const benchmark = [];

    const startDate = new Date();
    startDate.setFullYear(startDate.getFullYear() - 1);

    let aiReturn = 0;
    let buyHoldReturn = 0;
    let benchmarkReturn = 0;

    for (let i = 0; i < 252; i++) { // ä¸€å¹´çš„äº¤æ˜“æ—¥
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        dates.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));

        // æ¨¡æ‹ŸAIç­–ç•¥è¡¨ç°æ›´å¥½
        aiReturn += (Math.random() - 0.45) * 2; // ç•¥å¾®æ­£å
        buyHoldReturn += (Math.random() - 0.48) * 1.8;
        benchmarkReturn += (Math.random() - 0.5) * 1.5;

        aiStrategy.push(aiReturn);
        buyHold.push(buyHoldReturn);
        benchmark.push(benchmarkReturn);
    }

    return { dates, aiStrategy, buyHold, benchmark };
}
</script>
{% endblock %}