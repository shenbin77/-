{% extends "base.html" %}

{% block title %}æŠ€æœ¯åˆ†æ - è‚¡ç¥¨åˆ†æç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
.chart-container {
    width: 100%;
    height: 400px;
    position: relative;
}
.indicator-chart {
    width: 100%;
    height: 400px;
    position: relative;
}
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}
.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}
.metric-value {
    font-size: 2rem;
    font-weight: bold;
}
.metric-label {
    font-size: 0.9rem;
    opacity: 0.8;
}
.chart-tabs {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 20px;
}
.chart-tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    display: inline-block;
    margin-right: 10px;
    transition: all 0.3s;
}
.chart-tab.active {
    border-bottom-color: #007bff;
    color: #007bff;
    font-weight: bold;
}
.chart-tab:hover {
    background-color: #f8f9fa;
}
#main-chart, #indicator-chart {
    width: 100%;
    height: 400px;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">ğŸ“ˆ æŠ€æœ¯åˆ†æ</h1>
            <p class="text-muted">ä¸“ä¸šKçº¿å›¾ã€æŠ€æœ¯æŒ‡æ ‡åˆ†æ</p>
        </div>
    </div>

    <!-- è‚¡ç¥¨é€‰æ‹© -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form id="stock-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="stock-input" class="form-label">è‚¡ç¥¨ä»£ç </label>
                            <input type="text" class="form-control" id="stock-input" placeholder="è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œå¦‚ï¼š000001.SZ" maxlength="9" value="000001.SZ">
                            <div class="form-text">æ”¯æŒæ ¼å¼ï¼š000001.SZï¼ˆæ·±åœ³ï¼‰ã€600000.SHï¼ˆä¸Šæµ·ï¼‰</div>
                        </div>
                        <div class="col-md-3">
                            <label for="period-select" class="form-label">æ—¶é—´å‘¨æœŸ</label>
                            <select class="form-select" id="period-select">
                                <option value="30">30å¤©</option>
                                <option value="60" selected>60å¤©</option>
                                <option value="120">120å¤©</option>
                                <option value="250">250å¤©</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="chart-type-select" class="form-label">å›¾è¡¨ç±»å‹</label>
                            <select class="form-select" id="chart-type-select">
                                <option value="candlestick">Kçº¿å›¾</option>
                                <option value="line">çº¿å›¾</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-primary d-block w-100">
                                <i class="fas fa-chart-line"></i> åˆ†æ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- è‚¡ç¥¨ä¿¡æ¯å¡ç‰‡ -->
    <div id="stock-info-section" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div id="stock-info-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…³é”®æŒ‡æ ‡ -->
    <div id="metrics-section" class="row mb-4" style="display: none;">
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value" id="current-price">--</div>
                <div class="metric-label">å½“å‰ä»·æ ¼</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value" id="price-change">--</div>
                <div class="metric-label">æ¶¨è·Œå¹…</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value" id="volume">--</div>
                <div class="metric-label">æˆäº¤é‡</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value" id="turnover">--</div>
                <div class="metric-label">æˆäº¤é¢</div>
            </div>
        </div>
    </div>

    <!-- ä¸»å›¾è¡¨åŒºåŸŸ -->
    <div id="main-chart-section" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ“Š ä»·æ ¼å›¾è¡¨</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" onclick="switchMainChart('price')">ä»·æ ¼</button>
                            <button type="button" class="btn btn-outline-primary" onclick="switchMainChart('volume')">æˆäº¤é‡</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="main-chart" class="chart-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ -->
    <div id="indicators-section" class="row" style="display: none;">
        <!-- å›¾è¡¨é€‰é¡¹å¡ -->
        <div class="col-12 mb-3">
            <div class="chart-tabs">
                <div class="chart-tab active" onclick="switchIndicatorChart('macd')">MACD</div>
                <div class="chart-tab" onclick="switchIndicatorChart('kdj')">KDJ</div>
                <div class="chart-tab" onclick="switchIndicatorChart('rsi')">RSI</div>
                <div class="chart-tab" onclick="switchIndicatorChart('boll')">å¸ƒæ—å¸¦</div>
            </div>
        </div>

        <!-- æŒ‡æ ‡å›¾è¡¨å®¹å™¨ -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0" id="indicator-title">ğŸ“ˆ MACDæŒ‡æ ‡</h6>
                </div>
                <div class="card-body">
                    <div id="indicator-chart" class="indicator-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div id="data-section" class="row mt-4" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ“‹ è¯¦ç»†æ•°æ®</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="data-table">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>å¼€ç›˜</th>
                                    <th>æœ€é«˜</th>
                                    <th>æœ€ä½</th>
                                    <th>æ”¶ç›˜</th>
                                    <th>æˆäº¤é‡</th>
                                    <th>æ¶¨è·Œå¹…</th>
                                    <th>RSI</th>
                                    <th>MACD</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStock = null;
let currentPeriod = 60;
let historyData = [];
let factorsData = [];
let chartType = 'candlestick';
let currentIndicator = 'macd';
let currentMainChart = 'price';

// EChartså®ä¾‹
let mainChart = null;
let indicatorChart = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    console.log('EChartsæ˜¯å¦å¯ç”¨:', typeof echarts !== 'undefined');
    console.log('Axiosæ˜¯å¦å¯ç”¨:', typeof axios !== 'undefined');
    
    // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰è‚¡ç¥¨ä»£ç 
    const urlParams = new URLSearchParams(window.location.search);
    const stockFromUrl = urlParams.get('stock');
    if (stockFromUrl) {
        document.getElementById('stock-input').value = stockFromUrl.toUpperCase();
        currentStock = stockFromUrl.toUpperCase();
        console.log('ä»URLè·å–è‚¡ç¥¨ä»£ç :', currentStock);
    }
    
    // ç»‘å®šäº‹ä»¶
    const stockForm = document.getElementById('stock-form');
    if (stockForm) {
        stockForm.addEventListener('submit', handleAnalysis);
        console.log('è¡¨å•äº‹ä»¶ç»‘å®šæˆåŠŸ');
    } else {
        console.error('è‚¡ç¥¨è¡¨å•æœªæ‰¾åˆ°');
    }
    
    // ç»‘å®šè‚¡ç¥¨ä»£ç è¾“å…¥æ¡†äº‹ä»¶
    const stockInput = document.getElementById('stock-input');
    if (stockInput) {
        stockInput.addEventListener('input', handleStockInputChange);
        stockInput.addEventListener('blur', validateStockCode);
    }
    
    // å»¶è¿Ÿåˆå§‹åŒ–å›¾è¡¨å®¹å™¨ï¼Œç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
    setTimeout(() => {
        initCharts();
    }, 100);
});

// åˆå§‹åŒ–å›¾è¡¨å®¹å™¨
function initCharts() {
    console.log('å¼€å§‹åˆå§‹åŒ–å›¾è¡¨...');
    
    // æ£€æŸ¥EChartsæ˜¯å¦å¯ç”¨
    if (typeof echarts === 'undefined') {
        console.error('EChartsæœªåŠ è½½');
        return;
    }
    
    // åˆå§‹åŒ–ä¸»å›¾è¡¨
    const mainChartDom = document.getElementById('main-chart');
    if (mainChartDom) {
        console.log('æ‰¾åˆ°ä¸»å›¾è¡¨å®¹å™¨ï¼Œå°ºå¯¸:', mainChartDom.offsetWidth, 'x', mainChartDom.offsetHeight);
        
        // ç¡®ä¿å®¹å™¨æœ‰æ˜ç¡®çš„å°ºå¯¸
        mainChartDom.style.width = '100%';
        mainChartDom.style.height = '400px';
        
        try {
            // ç›´æ¥åˆå§‹åŒ–å›¾è¡¨
            mainChart = echarts.init(mainChartDom);
            console.log('ä¸»å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
            
            // æµ‹è¯•æ¸²æŸ“ä¸€ä¸ªç®€å•å›¾è¡¨
            const testOption = {
                title: { text: 'ç­‰å¾…æ•°æ®åŠ è½½...' },
                xAxis: { type: 'category', data: [] },
                yAxis: { type: 'value' },
                series: [{ type: 'line', data: [] }]
            };
            mainChart.setOption(testOption);
            console.log('ä¸»å›¾è¡¨æµ‹è¯•æ¸²æŸ“å®Œæˆ');
        } catch (error) {
            console.error('ä¸»å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
        }
    } else {
        console.error('ä¸»å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
    }
    
    // åˆå§‹åŒ–æŒ‡æ ‡å›¾è¡¨
    const indicatorChartDom = document.getElementById('indicator-chart');
    if (indicatorChartDom) {
        console.log('æ‰¾åˆ°æŒ‡æ ‡å›¾è¡¨å®¹å™¨ï¼Œå°ºå¯¸:', indicatorChartDom.offsetWidth, 'x', indicatorChartDom.offsetHeight);
        
        // ç¡®ä¿å®¹å™¨æœ‰æ˜ç¡®çš„å°ºå¯¸
        indicatorChartDom.style.width = '100%';
        indicatorChartDom.style.height = '400px';
        
        try {
            // ç›´æ¥åˆå§‹åŒ–å›¾è¡¨
            indicatorChart = echarts.init(indicatorChartDom);
            console.log('æŒ‡æ ‡å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
            
            // æµ‹è¯•æ¸²æŸ“ä¸€ä¸ªç®€å•å›¾è¡¨
            const testOption = {
                title: { text: 'ç­‰å¾…æ•°æ®åŠ è½½...' },
                xAxis: { type: 'category', data: [] },
                yAxis: { type: 'value' },
                series: [{ type: 'line', data: [] }]
            };
            indicatorChart.setOption(testOption);
            console.log('æŒ‡æ ‡å›¾è¡¨æµ‹è¯•æ¸²æŸ“å®Œæˆ');
        } catch (error) {
            console.error('æŒ‡æ ‡å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', error);
        }
    } else {
        console.error('æŒ‡æ ‡å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
    }
    
    // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
    window.addEventListener('resize', function() {
        setTimeout(() => {
            if (mainChart) {
                mainChart.resize();
                console.log('ä¸»å›¾è¡¨å·²è°ƒæ•´å°ºå¯¸');
            }
            if (indicatorChart) {
                indicatorChart.resize();
                console.log('æŒ‡æ ‡å›¾è¡¨å·²è°ƒæ•´å°ºå¯¸');
            }
        }, 100);
    });
}

// å¤„ç†è‚¡ç¥¨ä»£ç è¾“å…¥å˜åŒ–
function handleStockInputChange(event) {
    const input = event.target;
    let value = input.value.toUpperCase();
    
    // è‡ªåŠ¨æ ¼å¼åŒ–è‚¡ç¥¨ä»£ç 
    if (value.length === 6 && !value.includes('.')) {
        // æ ¹æ®è‚¡ç¥¨ä»£ç å‰ç¼€è‡ªåŠ¨æ·»åŠ åç¼€
        if (value.startsWith('0') || value.startsWith('3')) {
            value += '.SZ'; // æ·±åœ³
        } else if (value.startsWith('6')) {
            value += '.SH'; // ä¸Šæµ·
        }
        input.value = value;
    }
    
    currentStock = value;
}

// éªŒè¯è‚¡ç¥¨ä»£ç æ ¼å¼
function validateStockCode() {
    const input = document.getElementById('stock-input');
    const value = input.value.trim();
    
    if (value && !isValidStockCode(value)) {
        input.classList.add('is-invalid');
        showTooltip(input, 'è¯·è¾“å…¥æ­£ç¡®çš„è‚¡ç¥¨ä»£ç æ ¼å¼ï¼Œå¦‚ï¼š000001.SZ æˆ– 600000.SH');
    } else {
        input.classList.remove('is-invalid');
        hideTooltip(input);
    }
}

// æ£€æŸ¥è‚¡ç¥¨ä»£ç æ ¼å¼æ˜¯å¦æ­£ç¡®
function isValidStockCode(code) {
    const pattern = /^[0-9]{6}\.(SZ|SH)$/;
    return pattern.test(code);
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showTooltip(element, message) {
    hideTooltip(element); // å…ˆæ¸…é™¤å·²æœ‰çš„æç¤º
    
    const tooltip = document.createElement('div');
    tooltip.className = 'invalid-feedback d-block';
    tooltip.textContent = message;
    tooltip.id = 'stock-code-tooltip';
    
    element.parentNode.appendChild(tooltip);
}

// éšè—æç¤ºä¿¡æ¯
function hideTooltip(element) {
    const existingTooltip = document.getElementById('stock-code-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
}

// å¤„ç†åˆ†æè¯·æ±‚
async function handleAnalysis(event) {
    event.preventDefault();
    
    const tsCode = document.getElementById('stock-input').value.trim().toUpperCase();
    const period = document.getElementById('period-select').value;
    chartType = document.getElementById('chart-type-select').value;
    
    if (!tsCode) {
        alert('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
        return;
    }
    
    if (!isValidStockCode(tsCode)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„è‚¡ç¥¨ä»£ç æ ¼å¼ï¼Œå¦‚ï¼š000001.SZ æˆ– 600000.SH');
        return;
    }
    
    currentStock = tsCode;
    currentPeriod = period;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showAnalysisLoading();
    
    try {
        // å¹¶è¡ŒåŠ è½½æ•°æ®
        const [stockInfoResponse, historyResponse, factorsResponse] = await Promise.all([
            apiRequest(`/stocks/${tsCode}`).catch(() => ({ code: 404, data: null })),
            apiRequest(`/stocks/${tsCode}/history?limit=${period}`),
            apiRequest(`/stocks/${tsCode}/factors?limit=${period}`)
        ]);
        
        // æ£€æŸ¥å†å²æ•°æ®å’ŒæŠ€æœ¯å› å­æ•°æ®æ˜¯å¦æˆåŠŸè·å–ï¼ˆè¿™ä¸¤ä¸ªæ˜¯å¿…éœ€çš„ï¼‰
        if (historyResponse.code === 200 && factorsResponse.code === 200) {
            historyData = historyResponse.data || [];
            factorsData = factorsResponse.data || [];
            
            if (historyData.length === 0) {
                throw new Error('è¯¥è‚¡ç¥¨æš‚æ— å†å²æ•°æ®');
            }
            
            // æ¸²æŸ“æ‰€æœ‰ç»„ä»¶ï¼ˆè‚¡ç¥¨ä¿¡æ¯å¯èƒ½ä¸ºç©ºï¼Œä½†ä¸å½±å“æŠ€æœ¯åˆ†æï¼‰
            renderStockInfo(stockInfoResponse.code === 200 ? stockInfoResponse.data : null);
            renderMetrics(historyData);
            renderMainChart();
            renderIndicatorChart();
            renderDataTable(historyData, factorsData);
            
            // æ˜¾ç¤ºæ‰€æœ‰åŒºåŸŸ
            showAnalysisResults();
        } else {
            if (historyResponse.code !== 200) {
                throw new Error('æ— æ³•è·å–è¯¥è‚¡ç¥¨çš„å†å²æ•°æ®ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®');
            } else {
                throw new Error('æ— æ³•è·å–è¯¥è‚¡ç¥¨çš„æŠ€æœ¯æŒ‡æ ‡æ•°æ®');
            }
        }
    } catch (error) {
        console.error('åˆ†æå¤±è´¥:', error);
        alert(error.message || 'åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®');
        showAnalysisError();
    }
}

// æ˜¾ç¤ºåˆ†æåŠ è½½çŠ¶æ€
function showAnalysisLoading() {
    if (mainChart) {
        mainChart.showLoading('default', {
            text: 'æ­£åœ¨åŠ è½½æ•°æ®...',
            color: '#007bff',
            textColor: '#000',
            maskColor: 'rgba(255, 255, 255, 0.8)',
            zlevel: 0
        });
    }
    if (indicatorChart) {
        indicatorChart.showLoading();
    }
}

// æ˜¾ç¤ºåˆ†æç»“æœ
function showAnalysisResults() {
    document.getElementById('stock-info-section').style.display = 'block';
    document.getElementById('metrics-section').style.display = 'block';
    document.getElementById('main-chart-section').style.display = 'block';
    document.getElementById('indicators-section').style.display = 'block';
    document.getElementById('data-section').style.display = 'block';
    
    if (mainChart) mainChart.hideLoading();
    if (indicatorChart) indicatorChart.hideLoading();
}

// æ˜¾ç¤ºåˆ†æé”™è¯¯
function showAnalysisError() {
    if (mainChart) {
        mainChart.hideLoading();
        mainChart.clear();
        mainChart.setOption({
            title: {
                text: 'æ•°æ®åŠ è½½å¤±è´¥',
                left: 'center',
                top: 'center',
                textStyle: {
                    color: '#999'
                }
            }
        });
    }
}

// æ¸²æŸ“è‚¡ç¥¨ä¿¡æ¯
function renderStockInfo(stock) {
    const container = document.getElementById('stock-info-content');
    
    // å¦‚æœæ²¡æœ‰è·å–åˆ°è‚¡ç¥¨ä¿¡æ¯ï¼Œæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
    if (!stock) {
        container.innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-2">${currentStock} <small class="text-muted">è‚¡ç¥¨ä»£ç </small></h4>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        æ— æ³•è·å–è¯¥è‚¡ç¥¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œä½†å¯ä»¥è¿›è¡ŒæŠ€æœ¯åˆ†æ
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="window.open('/stock/${currentStock}', '_blank')">
                        <i class="fas fa-external-link-alt"></i> è¯¦æƒ…
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="addToWatchlist()">
                        <i class="fas fa-star"></i> è‡ªé€‰
                    </button>
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-2">${stock.name || currentStock} <small class="text-muted">(${stock.ts_code || currentStock})</small></h4>
                <div class="row g-3">
                    <div class="col-md-3">
                        <small class="text-muted">è¡Œä¸š</small><br>
                        <span class="badge bg-secondary">${stock.industry || '--'}</span>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">åœ°åŸŸ</small><br>
                        <span class="badge bg-info">${stock.area || '--'}</span>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">ä¸Šå¸‚æ—¥æœŸ</small><br>
                        <strong>${stock.list_date || '--'}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">å¸‚åœº</small><br>
                        <span class="badge ${(stock.ts_code || currentStock).includes('SH') ? 'bg-danger' : 'bg-success'}">
                            ${(stock.ts_code || currentStock).includes('SH') ? 'ä¸Šæµ·' : 'æ·±åœ³'}
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-outline-primary btn-sm me-2" onclick="window.open('/stock/${currentStock}', '_blank')">
                    <i class="fas fa-external-link-alt"></i> è¯¦æƒ…
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="addToWatchlist()">
                    <i class="fas fa-star"></i> è‡ªé€‰
                </button>
            </div>
        </div>
    `;
}

// æ¸²æŸ“å…³é”®æŒ‡æ ‡
function renderMetrics(data) {
    if (!data || data.length === 0) return;
    
    const latest = data[0];
    const previous = data[1];
    
    const currentPrice = latest.close || 0;
    const priceChange = previous ? ((currentPrice - previous.close) / previous.close * 100) : 0;
    const volume = latest.vol || 0;
    const turnover = latest.amount || 0;
    
    document.getElementById('current-price').textContent = formatNumber(currentPrice, 2);
    document.getElementById('price-change').textContent = formatPercent(priceChange);
    document.getElementById('price-change').className = `metric-value ${priceChange >= 0 ? 'text-success' : 'text-danger'}`;
    document.getElementById('volume').textContent = formatNumber(volume / 10000, 1) + 'ä¸‡';
    document.getElementById('turnover').textContent = formatNumber(turnover / 100000000, 2) + 'äº¿';
}

// æ¸²æŸ“ä¸»å›¾è¡¨
function renderMainChart() {
    if (!historyData || historyData.length === 0) {
        console.log('ä¸»å›¾è¡¨æ¸²æŸ“å¤±è´¥: æ²¡æœ‰å†å²æ•°æ®');
        return;
    }
    
    if (!mainChart) {
        console.log('ä¸»å›¾è¡¨æ¸²æŸ“å¤±è´¥: å›¾è¡¨å®ä¾‹ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–');
        const mainChartDom = document.getElementById('main-chart');
        if (mainChartDom) {
            mainChart = echarts.init(mainChartDom);
            console.log('ä¸»å›¾è¡¨é‡æ–°åˆå§‹åŒ–æˆåŠŸ');
        } else {
            console.error('ä¸»å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
    }
    
    if (currentMainChart === 'price') {
        renderPriceChart();
    } else {
        renderVolumeChart();
    }
}

// æ¸²æŸ“ä»·æ ¼å›¾è¡¨
function renderPriceChart() {
    console.log('å¼€å§‹æ¸²æŸ“ä»·æ ¼å›¾è¡¨ï¼Œå›¾è¡¨ç±»å‹:', chartType);
    console.log('å†å²æ•°æ®æ¡æ•°:', historyData.length);
    
    // åç«¯å·²ç»è¿”å›æ­£åºæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
    const dates = historyData.map(item => item.trade_date);
    const klineData = historyData.map(item => [item.open, item.close, item.low, item.high]);
    const lineData = historyData.map(item => item.close);
    
    console.log('å¤„ç†åçš„æ•°æ®:', {
        dates: dates.slice(0, 3),
        klineData: klineData.slice(0, 3),
        lineData: lineData.slice(0, 3)
    });
    
    const option = {
        title: {
            text: `${currentStock} ä»·æ ¼èµ°åŠ¿`,
            left: 'left'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            },
            formatter: function(params) {
                const data = params[0];
                if (chartType === 'candlestick') {
                    const values = data.data;
                    return `${data.name}<br/>
                            å¼€ç›˜: ${values[0]}<br/>
                            æ”¶ç›˜: ${values[1]}<br/>
                            æœ€ä½: ${values[2]}<br/>
                            æœ€é«˜: ${values[3]}`;
                } else {
                    return `${data.name}<br/>æ”¶ç›˜ä»·: ${data.value}`;
                }
            }
        },
        legend: {
            data: [chartType === 'candlestick' ? 'Kçº¿' : 'æ”¶ç›˜ä»·'],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates,
            scale: true,
            boundaryGap: false,
            axisLine: { onZero: false },
            splitLine: { show: false },
            min: 'dataMin',
            max: 'dataMax'
        },
        yAxis: {
            scale: true,
            splitArea: {
                show: true
            }
        },
        dataZoom: [
            {
                type: 'inside',
                start: 50,
                end: 100
            },
            {
                show: true,
                type: 'slider',
                top: '90%',
                start: 50,
                end: 100
            }
        ],
        series: [{
            name: chartType === 'candlestick' ? 'Kçº¿' : 'æ”¶ç›˜ä»·',
            type: chartType === 'candlestick' ? 'candlestick' : 'line',
            data: chartType === 'candlestick' ? klineData : lineData,
            itemStyle: chartType === 'candlestick' ? {
                color: '#ef232a',
                color0: '#14b143',
                borderColor: '#ef232a',
                borderColor0: '#14b143'
            } : {
                color: '#5470c6'
            },
            markPoint: {
                label: {
                    formatter: function (param) {
                        return param != null ? Math.round(param.value * 100) / 100 + '' : '';
                    }
                },
                data: [
                    {
                        name: 'æœ€é«˜å€¼',
                        type: 'max',
                        valueDim: chartType === 'candlestick' ? 'highest' : 'y'
                    },
                    {
                        name: 'æœ€ä½å€¼',
                        type: 'min',
                        valueDim: chartType === 'candlestick' ? 'lowest' : 'y'
                    }
                ]
            }
        }]
    };
    
    console.log('è®¾ç½®ä»·æ ¼å›¾è¡¨é€‰é¡¹...');
    mainChart.setOption(option, true);
    console.log('ä»·æ ¼å›¾è¡¨é€‰é¡¹è®¾ç½®å®Œæˆ');
    
    // å¼ºåˆ¶è°ƒæ•´å›¾è¡¨å°ºå¯¸
    setTimeout(() => {
        mainChart.resize();
        console.log('ä»·æ ¼å›¾è¡¨å°ºå¯¸è°ƒæ•´å®Œæˆ');
    }, 100);
}

// æ¸²æŸ“æˆäº¤é‡å›¾è¡¨
function renderVolumeChart() {
    // åç«¯å·²ç»è¿”å›æ­£åºæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
    const dates = historyData.map(item => item.trade_date);
    const volumeData = historyData.map(item => item.vol);
    
    const option = {
        title: {
            text: `${currentStock} æˆäº¤é‡`,
            left: 'left'
        },
        tooltip: {
            trigger: 'axis',
            formatter: function(params) {
                const data = params[0];
                return `${data.name}<br/>æˆäº¤é‡: ${formatNumber(data.value / 10000, 1)}ä¸‡`;
            }
        },
        legend: {
            data: ['æˆäº¤é‡'],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: function(value) {
                    return formatNumber(value / 10000, 1) + 'ä¸‡';
                }
            }
        },
        dataZoom: [
            {
                type: 'inside',
                start: 50,
                end: 100
            },
            {
                show: true,
                type: 'slider',
                top: '90%',
                start: 50,
                end: 100
            }
        ],
        series: [{
            name: 'æˆäº¤é‡',
            type: 'bar',
            data: volumeData,
            itemStyle: {
                color: '#91cc75'
            }
        }]
    };
    
    mainChart.setOption(option, true);
    // å¼ºåˆ¶è°ƒæ•´å›¾è¡¨å°ºå¯¸
    setTimeout(() => {
        mainChart.resize();
    }, 100);
}

// æ¸²æŸ“æŒ‡æ ‡å›¾è¡¨
function renderIndicatorChart() {
    if (!factorsData || factorsData.length === 0) {
        console.log('æŒ‡æ ‡å›¾è¡¨æ¸²æŸ“å¤±è´¥: æ²¡æœ‰æŠ€æœ¯å› å­æ•°æ®');
        return;
    }
    
    if (!indicatorChart) {
        console.log('æŒ‡æ ‡å›¾è¡¨æ¸²æŸ“å¤±è´¥: å›¾è¡¨å®ä¾‹ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°åˆå§‹åŒ–');
        const indicatorChartDom = document.getElementById('indicator-chart');
        if (indicatorChartDom) {
            indicatorChart = echarts.init(indicatorChartDom);
            console.log('æŒ‡æ ‡å›¾è¡¨é‡æ–°åˆå§‹åŒ–æˆåŠŸ');
        } else {
            console.error('æŒ‡æ ‡å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°');
            return;
        }
    }
    
    console.log('å¼€å§‹æ¸²æŸ“æŒ‡æ ‡å›¾è¡¨:', currentIndicator, 'æ•°æ®æ¡æ•°:', factorsData.length);
    
    switch(currentIndicator) {
        case 'macd':
            renderMACDChart();
            break;
        case 'kdj':
            renderKDJChart();
            break;
        case 'rsi':
            renderRSIChart();
            break;
        case 'boll':
            renderBollChart();
            break;
    }
}

// æ¸²æŸ“MACDå›¾è¡¨
function renderMACDChart() {
    // åç«¯å·²ç»è¿”å›æ­£åºæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
    const dates = factorsData.map(item => item.trade_date);
    const macdData = factorsData.map(item => item.macd || 0);
    const deaData = factorsData.map(item => item.macd_dea || 0);
    const difData = factorsData.map(item => item.macd_dif || 0);
    
    console.log('MACDæ•°æ®:', {
        dates: dates.slice(0, 3),
        macd: macdData.slice(0, 3),
        dea: deaData.slice(0, 3),
        dif: difData.slice(0, 3)
    });
    
    const option = {
        title: {
            text: 'MACDæŒ‡æ ‡',
            left: 'left'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['MACD', 'DEA', 'DIF'],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: 'MACD',
                type: 'bar',
                data: macdData,
                itemStyle: {
                    color: function(params) {
                        return params.value >= 0 ? '#ef232a' : '#14b143';
                    }
                }
            },
            {
                name: 'DEA',
                type: 'line',
                data: deaData,
                smooth: true,
                itemStyle: {
                    color: '#fac858'
                }
            },
            {
                name: 'DIF',
                type: 'line',
                data: difData,
                smooth: true,
                itemStyle: {
                    color: '#5470c6'
                }
            }
        ]
    };
    
    indicatorChart.setOption(option, true);
    // å¼ºåˆ¶è°ƒæ•´å›¾è¡¨å°ºå¯¸
    setTimeout(() => {
        indicatorChart.resize();
    }, 100);
}

// æ¸²æŸ“KDJå›¾è¡¨
function renderKDJChart() {
    // åç«¯å·²ç»è¿”å›æ­£åºæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
    const dates = factorsData.map(item => item.trade_date);
    const kData = factorsData.map(item => item.kdj_k || 0);
    const dData = factorsData.map(item => item.kdj_d || 0);
    const jData = factorsData.map(item => item.kdj_j || 0);
    
    const option = {
        title: {
            text: 'KDJæŒ‡æ ‡',
            left: 'left'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['K', 'D', 'J'],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates
        },
        yAxis: {
            type: 'value',
            min: 0,
            max: 100,
            axisLine: {
                lineStyle: {
                    color: '#999'
                }
            },
            splitLine: {
                lineStyle: {
                    color: ['#eee']
                }
            }
        },
        series: [
            {
                name: 'K',
                type: 'line',
                data: kData,
                smooth: true,
                itemStyle: {
                    color: '#5470c6'
                }
            },
            {
                name: 'D',
                type: 'line',
                data: dData,
                smooth: true,
                itemStyle: {
                    color: '#91cc75'
                }
            },
            {
                name: 'J',
                type: 'line',
                data: jData,
                smooth: true,
                itemStyle: {
                    color: '#fac858'
                }
            }
        ],
        markLine: {
            data: [
                { yAxis: 80, lineStyle: { color: '#ef232a', type: 'dashed' } },
                { yAxis: 20, lineStyle: { color: '#14b143', type: 'dashed' } }
            ]
        }
    };
    
    indicatorChart.setOption(option, true);
    // å¼ºåˆ¶è°ƒæ•´å›¾è¡¨å°ºå¯¸
    setTimeout(() => {
        indicatorChart.resize();
    }, 100);
}

// æ¸²æŸ“RSIå›¾è¡¨
function renderRSIChart() {
    // åç«¯å·²ç»è¿”å›æ­£åºæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
    const dates = factorsData.map(item => item.trade_date);
    const rsi6Data = factorsData.map(item => item.rsi_6 || 0);
    const rsi12Data = factorsData.map(item => item.rsi_12 || 0);
    const rsi24Data = factorsData.map(item => item.rsi_24 || 0);
    
    const option = {
        title: {
            text: 'RSIæŒ‡æ ‡',
            left: 'left'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['RSI6', 'RSI12', 'RSI24'],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates
        },
        yAxis: {
            type: 'value',
            min: 0,
            max: 100
        },
        series: [
            {
                name: 'RSI6',
                type: 'line',
                data: rsi6Data,
                smooth: true,
                itemStyle: {
                    color: '#5470c6'
                }
            },
            {
                name: 'RSI12',
                type: 'line',
                data: rsi12Data,
                smooth: true,
                itemStyle: {
                    color: '#91cc75'
                }
            },
            {
                name: 'RSI24',
                type: 'line',
                data: rsi24Data,
                smooth: true,
                itemStyle: {
                    color: '#fac858'
                }
            }
        ],
        markLine: {
            data: [
                { yAxis: 70, lineStyle: { color: '#ef232a', type: 'dashed' } },
                { yAxis: 30, lineStyle: { color: '#14b143', type: 'dashed' } }
            ]
        }
    };
    
    indicatorChart.setOption(option, true);
    // å¼ºåˆ¶è°ƒæ•´å›¾è¡¨å°ºå¯¸
    setTimeout(() => {
        indicatorChart.resize();
    }, 100);
}

// æ¸²æŸ“å¸ƒæ—å¸¦å›¾è¡¨
function renderBollChart() {
    // åç«¯å·²ç»è¿”å›æ­£åºæ•°æ®ï¼Œç›´æ¥ä½¿ç”¨
    const dates = historyData.map(item => item.trade_date);
    const closeData = historyData.map(item => item.close);
    
    // ä»æŠ€æœ¯å› å­æ•°æ®ä¸­è·å–å¸ƒæ—å¸¦æ•°æ®
    const bollUpper = [];
    const bollMid = [];
    const bollLower = [];
    
    dates.forEach(date => {
        const factor = factorsData.find(f => f.trade_date === date);
        bollUpper.push(factor ? factor.boll_upper || 0 : 0);
        bollMid.push(factor ? factor.boll_mid || 0 : 0);
        bollLower.push(factor ? factor.boll_lower || 0 : 0);
    });
    
    const option = {
        title: {
            text: 'å¸ƒæ—å¸¦æŒ‡æ ‡',
            left: 'left'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['æ”¶ç›˜ä»·', 'ä¸Šè½¨', 'ä¸­è½¨', 'ä¸‹è½¨'],
            top: 30
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: dates
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: 'æ”¶ç›˜ä»·',
                type: 'line',
                data: closeData,
                smooth: true,
                itemStyle: {
                    color: '#5470c6'
                },
                lineStyle: {
                    width: 2
                }
            },
            {
                name: 'ä¸Šè½¨',
                type: 'line',
                data: bollUpper,
                smooth: true,
                itemStyle: {
                    color: '#ef232a'
                },
                lineStyle: {
                    type: 'dashed'
                }
            },
            {
                name: 'ä¸­è½¨',
                type: 'line',
                data: bollMid,
                smooth: true,
                itemStyle: {
                    color: '#fac858'
                }
            },
            {
                name: 'ä¸‹è½¨',
                type: 'line',
                data: bollLower,
                smooth: true,
                itemStyle: {
                    color: '#14b143'
                },
                lineStyle: {
                    type: 'dashed'
                }
            }
        ]
    };
    
    indicatorChart.setOption(option, true);
    // å¼ºåˆ¶è°ƒæ•´å›¾è¡¨å°ºå¯¸
    setTimeout(() => {
        indicatorChart.resize();
    }, 100);
}

// åˆ‡æ¢ä¸»å›¾è¡¨
function switchMainChart(type) {
    currentMainChart = type;
    document.querySelectorAll('#main-chart-section .btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (historyData.length > 0) {
        renderMainChart();
    }
}

// åˆ‡æ¢æŒ‡æ ‡å›¾è¡¨
function switchIndicatorChart(indicator) {
    currentIndicator = indicator;
    
    // æ›´æ–°é€‰é¡¹å¡çŠ¶æ€
    document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
    
    // æ›´æ–°æ ‡é¢˜
    const titles = {
        'macd': 'ğŸ“ˆ MACDæŒ‡æ ‡',
        'kdj': 'ğŸ“Š KDJæŒ‡æ ‡',
        'rsi': 'ğŸ“‰ RSIæŒ‡æ ‡',
        'boll': 'ğŸ“Š å¸ƒæ—å¸¦æŒ‡æ ‡'
    };
    document.getElementById('indicator-title').textContent = titles[indicator];
    
    if (factorsData.length > 0) {
        renderIndicatorChart();
    }
}

// æ¸²æŸ“æ•°æ®è¡¨æ ¼
function renderDataTable(historyData, factorsData) {
    const tbody = document.getElementById('data-table-body');
    
    if (!historyData || historyData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    // åˆå¹¶å†å²æ•°æ®å’ŒæŠ€æœ¯å› å­æ•°æ®
    const mergedData = historyData.slice(0, 20).map(history => {
        const factor = factorsData.find(f => f.trade_date === history.trade_date) || {};
        return { ...history, ...factor };
    });
    
    tbody.innerHTML = mergedData.map(item => `
        <tr>
            <td>${item.trade_date}</td>
            <td>${formatNumber(item.open, 2)}</td>
            <td class="text-danger">${formatNumber(item.high, 2)}</td>
            <td class="text-success">${formatNumber(item.low, 2)}</td>
            <td><strong>${formatNumber(item.close, 2)}</strong></td>
            <td>${formatNumber(item.vol/10000, 1)}ä¸‡</td>
            <td class="${(item.pct_chg || 0) >= 0 ? 'text-danger' : 'text-success'}">
                ${formatPercent(item.pct_chg || 0)}
            </td>
            <td>${formatNumber(item.rsi_6, 2)}</td>
            <td>${formatNumber(item.macd, 4)}</td>
        </tr>
    `).join('');
}

// æ·»åŠ åˆ°è‡ªé€‰è‚¡
function addToWatchlist() {
    if (currentStock) {
        alert(`å·²å°†è‚¡ç¥¨ ${currentStock} åŠ å…¥è‡ªé€‰è‚¡`);
    }
}

// å·¥å…·å‡½æ•°
function formatNumber(num, decimals = 2) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    return Number(num).toLocaleString('zh-CN', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

function formatPercent(num) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    const sign = num >= 0 ? '+' : '';
    return sign + Number(num).toFixed(2) + '%';
}
</script>
{% endblock %} 