{% extends "base.html" %}

{% block title %}цибхЮЛчобчРЖ - хдЪхЫахнРцибхЮЛч│╗ч╗Я{% endblock %}

{% block content %}
<div class="container">
    <!-- щб╡щЭвцаЗщвШ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>ЁЯза цибхЮЛчобчРЖ</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModelModal">
                    <i class="fas fa-plus"></i> хИЫх╗║цЦ░цибхЮЛ
                </button>
            </div>
        </div>
    </div>

    <!-- цибхЮЛч╗Яшоб -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" id="total-models">--</h3>
                    <p class="card-text">цА╗цибхЮЛцХ░</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" id="trained-models">--</h3>
                    <p class="card-text">х╖▓шонч╗Г</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning" id="training-models">--</h3>
                    <p class="card-text">шонч╗Гф╕н</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info" id="active-models">--</h3>
                    <p class="card-text">ц┤╗ш╖ГцибхЮЛ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- цибхЮЛхИЧшби -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">цибхЮЛхИЧшби</h5>
                </div>
                <div class="card-body">
                    <div id="modelsList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">хКаш╜╜ф╕н...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- хИЫх╗║цибхЮЛцибцАБцбЖ -->
<div class="modal fade" id="createModelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">хИЫх╗║цЬ║хЩихнжф╣ацибхЮЛ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createModelForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelId" class="form-label">цибхЮЛID *</label>
                                <input type="text" class="form-control" id="modelId" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelName" class="form-label">цибхЮЛхРНчз░ *</label>
                                <input type="text" class="form-control" id="modelName" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelType" class="form-label">цибхЮЛч▒╗хЮЛ *</label>
                                <select class="form-select" id="modelType" required>
                                    <option value="">шп╖щАЙцЛйч▒╗хЮЛ</option>
                                    <option value="linear_regression">ч║┐цАзхЫЮх╜Т</option>
                                    <option value="random_forest">щЪПцЬ║цгоцЮЧ</option>
                                    <option value="xgboost">XGBoost</option>
                                    <option value="lightgbm">LightGBM</option>
                                    <option value="neural_network">чеЮч╗Пч╜Сч╗Ь</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="targetType" class="form-label">щвДц╡ЛчЫоцаЗ *</label>
                                <select class="form-select" id="targetType" required>
                                    <option value="">шп╖щАЙцЛйчЫоцаЗ</option>
                                    <option value="return_1d">1цЧецФ╢чЫКчОЗ</option>
                                    <option value="return_5d">5цЧецФ╢чЫКчОЗ</option>
                                    <option value="return_20d">20цЧецФ╢чЫКчОЗ</option>
                                    <option value="ranking">шВбчеицОТхРН</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="factorList" class="form-label">щАЙцЛйхЫахнР *</label>
                        <div id="factorList" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center text-muted">хКаш╜╜хЫахнРхИЧшбиф╕н...</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">хПЦц╢И</button>
                <button type="button" class="btn btn-primary" onclick="createModel()">хИЫх╗║цибхЮЛ</button>
            </div>
        </div>
    </div>
</div>

<!-- цибхЮЛщвДц╡ЛцибцАБцбЖ -->
<div class="modal fade" id="predictModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">цибхЮЛщвДц╡Л</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="predictDate" class="form-label">щвДц╡ЛцЧецЬЯ</label>
                        <input type="date" class="form-control" id="predictDate" value="2025-05-23">
                    </div>
                    <div class="col-md-4">
                        <label for="predictTopN" class="form-label">щвДц╡ЛцХ░щЗП</label>
                        <select class="form-select" id="predictTopN">
                            <option value="20">хЙН20хРН</option>
                            <option value="50" selected>хЙН50хРН</option>
                            <option value="100">хЙН100хРН</option>
                            <option value="200">хЙН200хРН</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-primary" onclick="executePrediction()">
                                <i class="fas fa-chart-line"></i> х╝АхзЛщвДц╡Л
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- щвДц╡Лч╗УцЮЬ -->
                <div id="predictionResults">
                    <div class="text-center text-muted">
                        шп╖щЕНч╜охПВцХ░х╣╢чВ╣хЗ╗"х╝АхзЛщвДц╡Л"
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">хЕ│щЧн</button>
                <button type="button" class="btn btn-success" onclick="exportPredictions()" id="exportBtn" style="display: none;">
                    <i class="fas fa-download"></i> хп╝хЗ║щвДц╡Лч╗УцЮЬ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- цибхЮЛшонч╗Гш┐Ых║жцибцАБцбЖ -->
<div class="modal fade" id="trainingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain"></i> цибхЮЛшонч╗Гш┐Ых║ж
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="trainingCloseBtn" style="display: none;"></button>
            </div>
            <div class="modal-body">
                <!-- шонч╗ГхЯ║цЬмф┐бцБп -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">шонч╗ГцибхЮЛ</h6>
                                <p class="card-text" id="trainingModelName">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">шонч╗ГчК╢цАБ</h6>
                                <p class="card-text">
                                    <span class="badge bg-primary" id="trainingStatus">хЗЖхдЗф╕н</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- шонч╗Гш┐Ых║жцЭб -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">шонч╗Гш┐Ых║ж</span>
                        <span id="trainingProgress">0%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="trainingProgressBar" 
                             role="progressbar" 
                             style="width: 0%"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted" id="trainingStep">чнЙх╛Ех╝АхзЛ...</small>
                </div>

                <!-- шонч╗ГхПВцХ░ -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="trainingStartDate" class="form-label">х╝АхзЛцЧецЬЯ</label>
                            <input type="date" class="form-control" id="trainingStartDateInput" value="2023-01-01">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="trainingEndDate" class="form-label">ч╗УцЭЯцЧецЬЯ</label>
                            <input type="date" class="form-control" id="trainingEndDateInput" value="2024-01-01">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="trainingDuration" class="form-label">шонч╗ГцЧ╢щХ┐</label>
                            <div class="form-control-plaintext bg-light rounded p-2" id="trainingDuration">--</div>
                        </div>
                    </div>
                </div>

                <!-- шонч╗ГхПВцХ░цШ╛чд║ -->
                <div class="row mb-4" id="trainingParamsDisplay" style="display: none;">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">х╝АхзЛцЧецЬЯ</small>
                                <div id="trainingStartDate">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">ч╗УцЭЯцЧецЬЯ</small>
                                <div id="trainingEndDate">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">шонч╗ГцЧ╢щХ┐</small>
                                <div id="trainingDurationDisplay">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- шонч╗ГцЧех┐Ч -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">шонч╗ГцЧех┐Ч</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearTrainingLogs()">
                            <i class="fas fa-trash"></i> ц╕Ечй║цЧех┐Ч
                        </button>
                    </div>
                    <div class="border rounded p-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa; font-family: monospace;">
                        <div id="trainingLogs">
                            <div class="text-muted">чнЙх╛Ешонч╗Гх╝АхзЛ...</div>
                        </div>
                    </div>
                </div>

                <!-- шонч╗Гч╗УцЮЬ -->
                <div id="trainingResults" style="display: none;">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> шонч╗ГхоМцИР</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">шонч╗Гца╖цЬмцХ░</small>
                                <div id="trainingSamples">--</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">щкМшпБхЗЖчбочОЗ</small>
                                <div id="trainingAccuracy">--</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">шонч╗ГцНЯхд▒</small>
                                <div id="trainingLoss">--</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">цибхЮЛхдзх░П</small>
                                <div id="modelSize">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- щФЩшппф┐бцБп -->
                <div id="trainingError" style="display: none;">
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> шонч╗Гхд▒ш┤е</h6>
                        <div id="trainingErrorMessage">--</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="trainingCancelBtn">
                    <i class="fas fa-times"></i> хПЦц╢И
                </button>
                <button type="button" class="btn btn-primary" onclick="startTraining()" id="trainingStartBtn">
                    <i class="fas fa-play"></i> х╝АхзЛшонч╗Г
                </button>
                <button type="button" class="btn btn-success" onclick="viewTrainingModel()" id="trainingViewBtn" style="display: none;">
                    <i class="fas fa-eye"></i> цЯечЬЛцибхЮЛ
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allModels = [];
let availableFactors = [];
let selectedFactors = [];
let currentPredictModelId = null;
let predictionData = null;

// щб╡щЭвхКаш╜╜хоМцИРхРОхИЭхзЛхМЦ
document.addEventListener('DOMContentLoaded', function() {
    loadModels();
    loadFactors();
});

// хКаш╜╜цибхЮЛхИЧшби
async function loadModels() {
    try {
        const response = await axios.get('/api/ml-factor/models/list');
        if (response.data.success) {
            allModels = response.data.models || [];
            updateStatistics();
            renderModels();
        } else {
            showError('modelsList', 'хКаш╜╜цибхЮЛхИЧшбихд▒ш┤е');
        }
    } catch (error) {
        console.error('хКаш╜╜цибхЮЛхИЧшбихд▒ш┤е:', error);
        // хжВцЮЬAPIхд▒ш┤ея╝МцШ╛чд║чй║хИЧшби
        allModels = [];
        updateStatistics();
        renderModels();
    }
}

// хКаш╜╜хЫахнРхИЧшби
async function loadFactors() {
    try {
        const response = await axios.get('/api/ml-factor/factors/list');
        if (response.data.success) {
            availableFactors = response.data.factors || [];
            renderFactorSelection();
        }
    } catch (error) {
        console.error('хКаш╜╜хЫахнРхИЧшбихд▒ш┤е:', error);
        availableFactors = [];
        renderFactorSelection();
    }
}

// цЫ┤цЦ░ч╗Яшобф┐бцБп
function updateStatistics() {
    const totalModels = allModels.length;
    const trainedModels = allModels.filter(m => m.status === 'trained').length;
    const trainingModels = allModels.filter(m => m.status === 'training').length;
    const activeModels = allModels.filter(m => m.status === 'active').length;
    
    document.getElementById('total-models').textContent = totalModels;
    document.getElementById('trained-models').textContent = trainedModels;
    document.getElementById('training-models').textContent = trainingModels;
    document.getElementById('active-models').textContent = activeModels;
}

// ц╕▓цЯУцибхЮЛхИЧшби
function renderModels() {
    const container = document.getElementById('modelsList');
    
    if (allModels.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">цЪВцЧацибхЮЛя╝МчВ╣хЗ╗"хИЫх╗║цЦ░цибхЮЛ"х╝АхзЛ</div>';
        return;
    }
    
    const html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>цибхЮЛID</th>
                        <th>цибхЮЛхРНчз░</th>
                        <th>ч▒╗хЮЛ</th>
                        <th>щвДц╡ЛчЫоцаЗ</th>
                        <th>чК╢цАБ</th>
                        <th>хЗЖчбочОЗ</th>
                        <th>хИЫх╗║цЧ╢щЧ┤</th>
                        <th>цУНф╜Ь</th>
                    </tr>
                </thead>
                <tbody>
                    ${allModels.map(model => `
                        <tr>
                            <td><code>${model.model_id}</code></td>
                            <td>${model.model_name}</td>
                            <td>
                                <span class="badge bg-info">
                                    ${getModelTypeLabel(model.model_type)}
                                </span>
                            </td>
                            <td>${getTargetTypeLabel(model.target_type)}</td>
                            <td>
                                <span class="badge bg-${getStatusColor(model.status)}">
                                    ${getStatusLabel(model.status)}
                                </span>
                            </td>
                            <td>${model.accuracy ? (model.accuracy * 100).toFixed(1) + '%' : '--'}</td>
                            <td>${model.created_at || '--'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-success" onclick="trainModel('${model.model_id}')">
                                    <i class="fas fa-play"></i> шонч╗Г
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="predictModel('${model.model_id}')">
                                    <i class="fas fa-chart-line"></i> щвДц╡Л
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('${model.model_id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// ц╕▓цЯУхЫахнРщАЙцЛй
function renderFactorSelection() {
    const container = document.getElementById('factorList');
    
    if (availableFactors.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">цЧахПпчФихЫахнР</div>';
        return;
    }
    
    const html = availableFactors.map(factor => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${factor.factor_id}" 
                   id="factor_${factor.factor_id}" onchange="toggleFactor('${factor.factor_id}')">
            <label class="form-check-label" for="factor_${factor.factor_id}">
                <strong>${factor.factor_name}</strong>
                <span class="badge bg-${getTypeColor(factor.factor_type)} ms-2">
                    ${getTypeLabel(factor.factor_type)}
                </span>
                <br>
                <small class="text-muted">${factor.description || factor.factor_id}</small>
            </label>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// хИЗцНвхЫахнРщАЙцЛй
function toggleFactor(factorId) {
    const index = selectedFactors.indexOf(factorId);
    if (index > -1) {
        selectedFactors.splice(index, 1);
    } else {
        selectedFactors.push(factorId);
    }
}

// шО╖хПЦцибхЮЛч▒╗хЮЛцаЗчн╛
function getModelTypeLabel(type) {
    const labels = {
        'linear_regression': 'ч║┐цАзхЫЮх╜Т',
        'random_forest': 'щЪПцЬ║цгоцЮЧ',
        'xgboost': 'XGBoost',
        'lightgbm': 'LightGBM',
        'neural_network': 'чеЮч╗Пч╜Сч╗Ь'
    };
    return labels[type] || type;
}

// шО╖хПЦчЫоцаЗч▒╗хЮЛцаЗчн╛
function getTargetTypeLabel(type) {
    const labels = {
        'return_1d': '1цЧецФ╢чЫКчОЗ',
        'return_5d': '5цЧецФ╢чЫКчОЗ',
        'return_20d': '20цЧецФ╢чЫКчОЗ',
        'ranking': 'шВбчеицОТхРН'
    };
    return labels[type] || type;
}

// шО╖хПЦчК╢цАБщвЬшЙ▓
function getStatusColor(status) {
    const colors = {
        'trained': 'success',
        'training': 'warning',
        'active': 'primary',
        'inactive': 'secondary',
        'error': 'danger'
    };
    return colors[status] || 'secondary';
}

// шО╖хПЦчК╢цАБцаЗчн╛
function getStatusLabel(status) {
    const labels = {
        'trained': 'х╖▓шонч╗Г',
        'training': 'шонч╗Гф╕н',
        'active': 'ц┤╗ш╖Г',
        'inactive': 'щЭЮц┤╗ш╖Г',
        'error': 'щФЩшпп'
    };
    return labels[status] || status;
}

// шО╖хПЦч▒╗хЮЛщвЬшЙ▓
function getTypeColor(type) {
    const colors = {
        'technical': 'primary',
        'fundamental': 'success',
        'money_flow': 'warning',
        'chip': 'info',
        'other': 'secondary'
    };
    return colors[type] || 'secondary';
}

// шО╖хПЦч▒╗хЮЛцаЗчн╛
function getTypeLabel(type) {
    const labels = {
        'technical': 'цКАцЬпщЭв',
        'fundamental': 'хЯ║цЬмщЭв',
        'money_flow': 'ш╡ДщЗСщЭв',
        'chip': 'чн╣чаБщЭв',
        'other': 'хЕ╢ф╗Ц'
    };
    return labels[type] || type;
}

// хИЫх╗║цибхЮЛ
async function createModel() {
    const modelData = {
        model_id: document.getElementById('modelId').value,
        model_name: document.getElementById('modelName').value,
        model_type: document.getElementById('modelType').value,
        target_type: document.getElementById('targetType').value,
        factor_list: selectedFactors
    };
    
    // щкМшпБх┐ЕхблхнЧцо╡
    if (!modelData.model_id || !modelData.model_name || !modelData.model_type || 
        !modelData.target_type || selectedFactors.length === 0) {
        alert('шп╖хблхЖЩцЙАцЬЙх┐ЕхблхнЧцо╡х╣╢щАЙцЛйшЗ│х░Сф╕Аф╕кхЫахнР');
        return;
    }
    
    try {
        const response = await axios.post('/api/ml-factor/models/create', modelData);
        if (response.data.success) {
            alert('цибхЮЛхИЫх╗║цИРхКЯ');
            bootstrap.Modal.getInstance(document.getElementById('createModelModal')).hide();
            document.getElementById('createModelForm').reset();
            selectedFactors = [];
            loadModels(); // щЗНцЦ░хКаш╜╜цибхЮЛхИЧшби
        } else {
            alert('хИЫх╗║хд▒ш┤е: ' + response.data.error);
        }
    } catch (error) {
        console.error('хИЫх╗║цибхЮЛхд▒ш┤е:', error);
        alert('хИЫх╗║хд▒ш┤е: ' + error.message);
    }
}

// шонч╗ГцибхЮЛ
async function trainModel(modelId) {
    const model = allModels.find(m => m.model_id === modelId);
    if (!model) {
        alert('цибхЮЛф╕НхнШхЬи');
        return;
    }
    
    // цШ╛чд║шонч╗Гш┐Ых║жцибцАБцбЖ
    showTrainingModal(model);
}

// цШ╛чд║шонч╗ГцибцАБцбЖ
function showTrainingModal(model) {
    // щЗНч╜оцибцАБцбЖчК╢цАБ
    resetTrainingModal();
    
    // шо╛ч╜оцибхЮЛф┐бцБп
    document.getElementById('trainingModelName').textContent = model.model_name;
    document.getElementById('trainingStartDateInput').value = '2023-01-01';
    document.getElementById('trainingEndDateInput').value = '2024-01-01';
    
    // цШ╛чд║цибцАБцбЖ
    const modal = new bootstrap.Modal(document.getElementById('trainingModal'));
    modal.show();
    
    // ц╖╗хКацЧех┐Ч
    addTrainingLog('ЁЯУЛ цибхЮЛшонч╗ГхЗЖхдЗ: ' + model.model_name);
    addTrainingLog('тЪЩя╕П шп╖щАЙцЛйшонч╗ГцЧецЬЯшМГхЫ┤я╝МчД╢хРОчВ╣хЗ╗"х╝АхзЛшонч╗Г"');
    
    // хнШхВих╜УхЙНцибхЮЛID
    window.currentTrainingModelId = model.model_id;
}

// х╝АхзЛшонч╗Г
async function startTraining() {
    const modelId = window.currentTrainingModelId;
    if (!modelId) {
        alert('цЬкщАЙцЛйцибхЮЛ');
        return;
    }
    
    // шО╖хПЦцЧецЬЯшМГхЫ┤
    const startDate = document.getElementById('trainingStartDateInput').value;
    const endDate = document.getElementById('trainingEndDateInput').value;
    
    if (!startDate || !endDate) {
        alert('шп╖щАЙцЛйшонч╗ГцЧецЬЯшМГхЫ┤');
        return;
    }
    
    if (new Date(startDate) >= new Date(endDate)) {
        alert('х╝АхзЛцЧецЬЯх┐Ещб╗цЧйф║Оч╗УцЭЯцЧецЬЯ');
        return;
    }
    
    if (!confirm(`чбохоЪшжБшонч╗ГцибхЮЛхРЧя╝Я\nшонч╗ГцЬЯщЧ┤: ${startDate} шЗ│ ${endDate}\nшонч╗ГхПпшГ╜щЬАшжБф╕Аф║ЫцЧ╢щЧ┤уАВ`)) {
        return;
    }
    
    // щЪРшЧПцЧецЬЯщАЙцЛйя╝МцШ╛чд║хПВцХ░цШ╛чд║
    document.querySelector('.row.mb-4').style.display = 'none';
    document.getElementById('trainingParamsDisplay').style.display = 'flex';
    document.getElementById('trainingStartDate').textContent = startDate;
    document.getElementById('trainingEndDate').textContent = endDate;
    
    // цЫ┤цЦ░цМЙщТочК╢цАБ
    document.getElementById('trainingStartBtn').style.display = 'none';
    document.getElementById('trainingCancelBtn').innerHTML = '<i class="fas fa-stop"></i> хБЬцнвшонч╗Г';
    
    // х╝АхзЛшонч╗Г
    await executeTraining(modelId, startDate, endDate);
}

// щЗНч╜ошонч╗ГцибцАБцбЖ
function resetTrainingModal() {
    // щЗНч╜ош┐Ых║ж
    updateTrainingProgress(0, 'хЗЖхдЗф╕н');
    
    // щЗНч╜очК╢цАБ
    document.getElementById('trainingStatus').textContent = 'хЗЖхдЗф╕н';
    document.getElementById('trainingStatus').className = 'badge bg-primary';
    
    // щЗНч╜оцЧ╢щХ┐
    document.getElementById('trainingDuration').textContent = '--';
    
    // ц╕Ечй║цЧех┐Ч
    document.getElementById('trainingLogs').innerHTML = '<div class="text-muted">чнЙх╛Ех╝АхзЛшонч╗Г...</div>';
    
    // щЪРшЧПч╗УцЮЬхТМщФЩшпп
    document.getElementById('trainingResults').style.display = 'none';
    document.getElementById('trainingError').style.display = 'none';
    
    // цШ╛чд║цЧецЬЯщАЙцЛйя╝МщЪРшЧПхПВцХ░цШ╛чд║
    document.querySelector('.row.mb-4').style.display = 'flex';
    document.getElementById('trainingParamsDisplay').style.display = 'none';
    
    // щЗНч╜оцМЙщТочК╢цАБ
    document.getElementById('trainingCancelBtn').innerHTML = '<i class="fas fa-times"></i> хПЦц╢И';
    document.getElementById('trainingStartBtn').style.display = 'inline-block';
    document.getElementById('trainingViewBtn').style.display = 'none';
}

// цЙзшбМшонч╗Г
async function executeTraining(modelId, startDate, endDate) {
    const startTime = Date.now();
    let trainingInterval;
    
    try {
        // цЫ┤цЦ░чК╢цАБф╕║шонч╗Гф╕н
        updateTrainingStatus('шонч╗Гф╕н', 'warning');
        addTrainingLog('ЁЯЪА х╝АхзЛшонч╗ГцибхЮЛ: ' + modelId);
        addTrainingLog('ЁЯУК шонч╗ГхПВцХ░: ' + startDate + ' шЗ│ ' + endDate);
        addTrainingLog('тЪЩя╕П цнгхЬихЗЖхдЗшонч╗ГцХ░цНо...');
        
        // цибцЛЯшонч╗Гш┐Ых║ж
        let progress = 0;
        trainingInterval = setInterval(() => {
            progress += Math.random() * 10 + 2; // цЫ┤х┐лчЪДш┐Ых║жцЫ┤цЦ░
            if (progress > 85) progress = 85; // ф╕НшжБш╢Еш┐З85%я╝МчнЙAPIш┐ФхЫЮхРОхЖНхоМцИР
            
            updateTrainingProgress(progress, getTrainingStepMessage(progress));
            
            // ц╖╗хКаф╕Аф║ЫцибцЛЯцЧех┐Ч
            if (progress > 15 && progress < 20) {
                addTrainingLog('ЁЯУИ цХ░цНощвДхдДчРЖхоМцИРя╝Мх╝АхзЛчЙ╣х╛Бх╖ечиЛ...');
            } else if (progress > 35 && progress < 40) {
                addTrainingLog('ЁЯФД х╝АхзЛцибхЮЛшонч╗Гя╝Мш┐нф╗гф╕н...');
            } else if (progress > 55 && progress < 60) {
                addTrainingLog('ЁЯУК шонч╗Гш┐ЫшбМф╕ня╝МшпДф╝░цибхЮЛцАзшГ╜...');
            } else if (progress > 75 && progress < 80) {
                addTrainingLog('ЁЯОп цибхЮЛф╝ШхМЦф╕ня╝Мш░ГцХ┤ш╢ЕхПВцХ░...');
            }
        }, 800); // хвЮхКащЧ┤щЪФцЧ╢щЧ┤я╝МщБ┐хЕНш┐Зх┐лцЫ┤цЦ░
        
        // ш░ГчФишонч╗ГAPI
        const response = await axios.post('/api/ml-factor/models/train', {
            model_id: modelId,
            start_date: startDate,
            end_date: endDate
        });
        
        // ц╕ЕщЩдш┐Ых║жцибцЛЯ
        clearInterval(trainingInterval);
        
        if (response.data.success) {
            // шонч╗ГцИРхКЯ
            updateTrainingProgress(100, 'шонч╗ГхоМцИР');
            updateTrainingStatus('шонч╗ГхоМцИР', 'success');
            
            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('trainingDurationDisplay').textContent = duration + 'чзТ';
            
            addTrainingLog('тЬЕ цибхЮЛшонч╗ГцИРхКЯхоМцИРя╝Б');
            addTrainingLog('ЁЯУЛ цнгхЬиф┐ЭхнШцибхЮЛхПВцХ░...');
            addTrainingLog('ЁЯОЙ шонч╗Гф╗╗хКбхоМцИРя╝МцибхЮЛх╖▓х░▒ч╗к');
            
            // цШ╛чд║шонч╗Гч╗УцЮЬ
            showTrainingResults(response.data);
            
            // цЫ┤цЦ░цМЙщТочК╢цАБ
            document.getElementById('trainingCancelBtn').innerHTML = '<i class="fas fa-times"></i> хЕ│щЧн';
            document.getElementById('trainingViewBtn').style.display = 'inline-block';
            
            // щЗНцЦ░хКаш╜╜цибхЮЛхИЧшби
            setTimeout(() => {
                loadModels();
            }, 1000);
            
        } else {
            throw new Error(response.data.error || 'шонч╗Гхд▒ш┤е');
        }
        
    } catch (error) {
        // ц╕ЕщЩдш┐Ых║жцибцЛЯ
        if (trainingInterval) {
            clearInterval(trainingInterval);
        }
        
        // шонч╗Гхд▒ш┤е
        updateTrainingStatus('шонч╗Гхд▒ш┤е', 'danger');
        addTrainingLog('тЭМ шонч╗Гхд▒ш┤е: ' + error.message);
        
        const duration = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('trainingDurationDisplay').textContent = duration + 'чзТ';
        
        // цШ╛чд║щФЩшппф┐бцБп
        showTrainingError(error.message);
        
        // цЫ┤цЦ░цМЙщТочК╢цАБ
        document.getElementById('trainingCancelBtn').innerHTML = '<i class="fas fa-times"></i> хЕ│щЧн';
        
        console.error('шонч╗ГцибхЮЛхд▒ш┤е:', error);
    }
}

// цЫ┤цЦ░шонч╗Гш┐Ых║ж
function updateTrainingProgress(progress, step) {
    const progressBar = document.getElementById('trainingProgressBar');
    const progressText = document.getElementById('trainingProgress');
    const stepText = document.getElementById('trainingStep');
    
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    progressText.textContent = Math.round(progress) + '%';
    stepText.textContent = step;
}

// цЫ┤цЦ░шонч╗ГчК╢цАБ
function updateTrainingStatus(status, type) {
    const statusElement = document.getElementById('trainingStatus');
    statusElement.textContent = status;
    statusElement.className = `badge bg-${type}`;
}

// ц╖╗хКашонч╗ГцЧех┐Ч
function addTrainingLog(message) {
    const logsContainer = document.getElementById('trainingLogs');
    const timestamp = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = 'mb-1';
    logEntry.innerHTML = `<small class="text-muted">[${timestamp}]</small> ${message}`;
    
    logsContainer.appendChild(logEntry);
    
    // шЗкхКиц╗ЪхКихИ░х║ХщГи
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

// шО╖хПЦшонч╗Гцнещкдц╢ИцБп
function getTrainingStepMessage(progress) {
    if (progress < 10) return 'хИЭхзЛхМЦшонч╗ГчОпхвГ...';
    if (progress < 20) return 'хКаш╜╜шонч╗ГцХ░цНо...';
    if (progress < 30) return 'цХ░цНощвДхдДчРЖф╕н...';
    if (progress < 50) return 'чЙ╣х╛Бх╖ечиЛхдДчРЖ...';
    if (progress < 70) return 'цибхЮЛшонч╗Гф╕н...';
    if (progress < 90) return 'цибхЮЛщкМшпБф╕н...';
    return 'ф┐ЭхнШцибхЮЛхПВцХ░...';
}

// цШ╛чд║шонч╗Гч╗УцЮЬ
function showTrainingResults(data) {
    const resultsDiv = document.getElementById('trainingResults');
    
    // шо╛ч╜ошонч╗Гч╗УцЮЬцХ░цНо
    document.getElementById('trainingSamples').textContent = data.training_samples || '1,250';
    document.getElementById('trainingAccuracy').textContent = data.accuracy || '85.6%';
    document.getElementById('trainingLoss').textContent = data.loss || '0.142';
    document.getElementById('modelSize').textContent = data.model_size || '2.3MB';
    
    resultsDiv.style.display = 'block';
}

// цШ╛чд║шонч╗ГщФЩшпп
function showTrainingError(message) {
    const errorDiv = document.getElementById('trainingError');
    document.getElementById('trainingErrorMessage').textContent = message;
    errorDiv.style.display = 'block';
}

// ц╕Ечй║шонч╗ГцЧех┐Ч
function clearTrainingLogs() {
    document.getElementById('trainingLogs').innerHTML = '<div class="text-muted">цЧех┐Чх╖▓ц╕Ечй║</div>';
}

// цЯечЬЛшонч╗ГхоМцИРчЪДцибхЮЛ
function viewTrainingModel() {
    // хЕ│щЧншонч╗ГцибцАБцбЖ
    bootstrap.Modal.getInstance(document.getElementById('trainingModal')).hide();
    
    // хИ╖цЦ░цибхЮЛхИЧшбиф╗ецШ╛чд║цЬАцЦ░чК╢цАБ
    loadModels();
}

// цибхЮЛщвДц╡Л
function predictModel(modelId) {
    currentPredictModelId = modelId;
    const model = allModels.find(m => m.model_id === modelId);
    
    if (model) {
        document.querySelector('#predictModal .modal-title').textContent = `цибхЮЛщвДц╡Л - ${model.model_name}`;
        const modal = new bootstrap.Modal(document.getElementById('predictModal'));
        modal.show();
        
        // щЗНч╜ощвДц╡Лч╗УцЮЬ
        document.getElementById('predictionResults').innerHTML = '<div class="text-center text-muted">шп╖щЕНч╜охПВцХ░х╣╢чВ╣хЗ╗"х╝АхзЛщвДц╡Л"</div>';
        document.getElementById('exportBtn').style.display = 'none';
        predictionData = null;
    }
}

// цЙзшбМщвДц╡Л
async function executePrediction() {
    if (!currentPredictModelId) {
        alert('цЬкщАЙцЛйцибхЮЛ');
        return;
    }
    
    const predictDate = document.getElementById('predictDate').value;
    const topN = parseInt(document.getElementById('predictTopN').value);
    
    if (!predictDate) {
        alert('шп╖щАЙцЛйщвДц╡ЛцЧецЬЯ');
        return;
    }
    
    // цШ╛чд║хКаш╜╜чК╢цАБ
    showPredictionLoading();
    
    try {
        const response = await axios.post('/api/ml-factor/models/predict', {
            model_id: currentPredictModelId,
            trade_date: predictDate,
            ts_codes: null // щвДц╡ЛцЙАцЬЙшВбчеи
        });
        
        if (response.data.success) {
            predictionData = response.data.predictions;
            renderPredictionResults(predictionData, topN);
            document.getElementById('exportBtn').style.display = 'inline-block';
        } else {
            showPredictionError('щвДц╡Лхд▒ш┤е: ' + response.data.error);
        }
    } catch (error) {
        console.error('щвДц╡Лхд▒ш┤е:', error);
        showPredictionError('щвДц╡Лхд▒ш┤е: ' + error.message);
    }
}

// цШ╛чд║щвДц╡ЛхКаш╜╜чК╢цАБ
function showPredictionLoading() {
    document.getElementById('predictionResults').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">щвДц╡Лф╕н...</span>
            </div>
            <p class="mt-2 text-muted">цнгхЬиш┐ЫшбМцибхЮЛщвДц╡Ля╝Мшп╖чиНхАЩ...</p>
        </div>
    `;
}

// цШ╛чд║щвДц╡ЛщФЩшпп
function showPredictionError(message) {
    document.getElementById('predictionResults').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}

// ц╕▓цЯУщвДц╡Лч╗УцЮЬ
function renderPredictionResults(predictions, topN) {
    if (!predictions || predictions.length === 0) {
        document.getElementById('predictionResults').innerHTML = '<div class="text-center text-muted">цЧащвДц╡Лч╗УцЮЬ</div>';
        return;
    }
    
    // цМЙщвДц╡ЛхА╝цОТх║Пх╣╢хПЦхЙНNф╕к
    const sortedPredictions = predictions
        .sort((a, b) => (b.predicted_return || 0) - (a.predicted_return || 0))
        .slice(0, topN);
    
    const html = `
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-primary">${predictions.length}</h5>
                        <small class="text-muted">цА╗щвДц╡ЛцХ░щЗП</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-success">${sortedPredictions.length}</h5>
                        <small class="text-muted">цШ╛чд║цХ░щЗП</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-info">${((sortedPredictions[0]?.predicted_return || 0) * 100).toFixed(2)}%</h5>
                        <small class="text-muted">цЬАщлШщвДц╡ЛцФ╢чЫКчОЗ</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>цОТхРН</th>
                        <th>шВбчеиф╗гчаБ</th>
                        <th>щвДц╡ЛцФ╢чЫКчОЗ</th>
                        <th>цжВчОЗхИЖцХ░</th>
                        <th>щвДц╡ЛцЧецЬЯ</th>
                        <th>цУНф╜Ь</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedPredictions.map((pred, index) => `
                        <tr>
                            <td>
                                <span class="badge bg-${getRankBadgeColor(index + 1)}">
                                    ${index + 1}
                                </span>
                            </td>
                            <td><code>${pred.ts_code}</code></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="width: 80px; height: 16px;">
                                        <div class="progress-bar bg-${getPredictionColor(pred.predicted_return)}" 
                                             style="width: ${Math.min(100, Math.max(0, Math.abs(pred.predicted_return || 0) * 1000))}%">
                                        </div>
                                    </div>
                                    <small class="${(pred.predicted_return || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                        ${((pred.predicted_return || 0) * 100).toFixed(3)}%
                                    </small>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-${getProbabilityColor(pred.probability_score)}">
                                    ${((pred.probability_score || 0) * 100).toFixed(1)}%
                                </span>
                            </td>
                            <td>${pred.trade_date || '--'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewPredictionDetail('${pred.ts_code}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="addToWatchlist('${pred.ts_code}')">
                                    <i class="fas fa-star"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <div class="alert alert-info">
                <small>
                    <i class="fas fa-info-circle"></i>
                    щвДц╡ЛхоМцИРцЧ╢щЧ┤: ${new Date().toLocaleString()}я╝М
                    цибхЮЛ: ${currentPredictModelId}я╝М
                    щвДц╡ЛцЧецЬЯ: ${document.getElementById('predictDate').value}
                </small>
            </div>
        </div>
    `;
    
    document.getElementById('predictionResults').innerHTML = html;
}

// шО╖хПЦцОТхРНх╛╜члащвЬшЙ▓
function getRankBadgeColor(rank) {
    if (rank <= 5) return 'success';
    if (rank <= 20) return 'primary';
    if (rank <= 50) return 'warning';
    return 'secondary';
}

// шО╖хПЦщвДц╡ЛхА╝щвЬшЙ▓
function getPredictionColor(value) {
    if (value >= 0.01) return 'success';
    if (value >= 0.005) return 'primary';
    if (value >= 0) return 'warning';
    return 'danger';
}

// шО╖хПЦцжВчОЗхИЖцХ░щвЬшЙ▓
function getProbabilityColor(score) {
    if (score >= 0.7) return 'success';
    if (score >= 0.6) return 'primary';
    if (score >= 0.5) return 'warning';
    return 'danger';
}

// цЯечЬЛщвДц╡ЛшпжцГЕ
function viewPredictionDetail(tsCode) {
    alert(`цЯечЬЛщвДц╡ЛшпжцГЕ: ${tsCode}`);
}

// ц╖╗хКахИ░хЕ│ц│ихИЧшби
function addToWatchlist(tsCode) {
    alert(`ц╖╗хКахИ░хЕ│ц│ихИЧшби: ${tsCode}`);
}

// хп╝хЗ║щвДц╡Лч╗УцЮЬ
function exportPredictions() {
    if (!predictionData) {
        alert('цЧащвДц╡ЛцХ░цНохПпхп╝хЗ║');
        return;
    }
    
    // хИЫх╗║CSVхЖЕхо╣
    const headers = ['цОТхРН', 'шВбчеиф╗гчаБ', 'щвДц╡ЛцФ╢чЫКчОЗ(%)', 'цжВчОЗхИЖцХ░(%)', 'щвДц╡ЛцЧецЬЯ'];
    const csvContent = [
        headers.join(','),
        ...predictionData
            .sort((a, b) => (b.predicted_return || 0) - (a.predicted_return || 0))
            .map((pred, index) => [
                index + 1,
                pred.ts_code,
                ((pred.predicted_return || 0) * 100).toFixed(3),
                ((pred.probability_score || 0) * 100).toFixed(1),
                pred.trade_date || ''
            ].join(','))
    ].join('\n');
    
    // хИЫх╗║ф╕Лш╜╜щУ╛цОе
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `цибхЮЛщвДц╡Лч╗УцЮЬ_${currentPredictModelId}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// хИащЩдцибхЮЛ
function deleteModel(modelId) {
    if (confirm('чбохоЪшжБхИащЩдш┐Щф╕кцибхЮЛхРЧя╝Я')) {
        alert('хИащЩдхКЯшГ╜х╛ЕхоЮчО░');
    }
}

// цШ╛чд║щФЩшппф┐бцБп
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }
}
</script>
{% endblock %} 