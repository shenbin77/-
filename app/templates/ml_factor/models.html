{% extends "base.html" %}

{% block title %}æ¨¡å‹ç®¡ç† - å¤šå› å­æ¨¡å‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>ğŸ§  æ¨¡å‹ç®¡ç†</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModelModal">
                    <i class="fas fa-plus"></i> åˆ›å»ºæ–°æ¨¡å‹
                </button>
            </div>
        </div>
    </div>

    <!-- æ¨¡å‹ç»Ÿè®¡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" id="total-models">--</h3>
                    <p class="card-text">æ€»æ¨¡å‹æ•°</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" id="trained-models">--</h3>
                    <p class="card-text">å·²è®­ç»ƒ</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning" id="training-models">--</h3>
                    <p class="card-text">è®­ç»ƒä¸­</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info" id="active-models">--</h3>
                    <p class="card-text">æ´»è·ƒæ¨¡å‹</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡å‹åˆ—è¡¨ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">æ¨¡å‹åˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    <div id="modelsList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºæ¨¡å‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="createModelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åˆ›å»ºæœºå™¨å­¦ä¹ æ¨¡å‹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createModelForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelId" class="form-label">æ¨¡å‹ID *</label>
                                <input type="text" class="form-control" id="modelId" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelName" class="form-label">æ¨¡å‹åç§° *</label>
                                <input type="text" class="form-control" id="modelName" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modelType" class="form-label">æ¨¡å‹ç±»å‹ *</label>
                                <select class="form-select" id="modelType" required>
                                    <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                                    <option value="linear_regression">çº¿æ€§å›å½’</option>
                                    <option value="random_forest">éšæœºæ£®æ—</option>
                                    <option value="xgboost">XGBoost</option>
                                    <option value="lightgbm">LightGBM</option>
                                    <option value="neural_network">ç¥ç»ç½‘ç»œ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="targetType" class="form-label">é¢„æµ‹ç›®æ ‡ *</label>
                                <select class="form-select" id="targetType" required>
                                    <option value="">è¯·é€‰æ‹©ç›®æ ‡</option>
                                    <option value="return_1d">1æ—¥æ”¶ç›Šç‡</option>
                                    <option value="return_5d">5æ—¥æ”¶ç›Šç‡</option>
                                    <option value="return_20d">20æ—¥æ”¶ç›Šç‡</option>
                                    <option value="ranking">è‚¡ç¥¨æ’å</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="factorList" class="form-label">é€‰æ‹©å› å­ *</label>
                        <div id="factorList" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center text-muted">åŠ è½½å› å­åˆ—è¡¨ä¸­...</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createModel()">åˆ›å»ºæ¨¡å‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¨¡å‹é¢„æµ‹æ¨¡æ€æ¡† -->
<div class="modal fade" id="predictModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ¨¡å‹é¢„æµ‹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="predictDate" class="form-label">é¢„æµ‹æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="predictDate" value="2025-05-23">
                    </div>
                    <div class="col-md-4">
                        <label for="predictTopN" class="form-label">é¢„æµ‹æ•°é‡</label>
                        <select class="form-select" id="predictTopN">
                            <option value="20">å‰20å</option>
                            <option value="50" selected>å‰50å</option>
                            <option value="100">å‰100å</option>
                            <option value="200">å‰200å</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-primary" onclick="executePrediction()">
                                <i class="fas fa-chart-line"></i> å¼€å§‹é¢„æµ‹
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- é¢„æµ‹ç»“æœ -->
                <div id="predictionResults">
                    <div class="text-center text-muted">
                        è¯·é…ç½®å‚æ•°å¹¶ç‚¹å‡»"å¼€å§‹é¢„æµ‹"
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-success" onclick="exportPredictions()" id="exportBtn" style="display: none;">
                    <i class="fas fa-download"></i> å¯¼å‡ºé¢„æµ‹ç»“æœ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ¨¡å‹è®­ç»ƒè¿›åº¦æ¨¡æ€æ¡† -->
<div class="modal fade" id="trainingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-brain"></i> æ¨¡å‹è®­ç»ƒè¿›åº¦
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="trainingCloseBtn" style="display: none;"></button>
            </div>
            <div class="modal-body">
                <!-- è®­ç»ƒåŸºæœ¬ä¿¡æ¯ -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">è®­ç»ƒæ¨¡å‹</h6>
                                <p class="card-text" id="trainingModelName">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">è®­ç»ƒçŠ¶æ€</h6>
                                <p class="card-text">
                                    <span class="badge bg-primary" id="trainingStatus">å‡†å¤‡ä¸­</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è®­ç»ƒè¿›åº¦æ¡ -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">è®­ç»ƒè¿›åº¦</span>
                        <span id="trainingProgress">0%</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="trainingProgressBar" 
                             role="progressbar" 
                             style="width: 0%"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted" id="trainingStep">ç­‰å¾…å¼€å§‹...</small>
                </div>

                <!-- è®­ç»ƒå‚æ•° -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="trainingStartDate" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="trainingStartDateInput" value="2023-01-01">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="trainingEndDate" class="form-label">ç»“æŸæ—¥æœŸ</label>
                            <input type="date" class="form-control" id="trainingEndDateInput" value="2024-01-01">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="trainingDuration" class="form-label">è®­ç»ƒæ—¶é•¿</label>
                            <div class="form-control-plaintext bg-light rounded p-2" id="trainingDuration">--</div>
                        </div>
                    </div>
                </div>

                <!-- è®­ç»ƒå‚æ•°æ˜¾ç¤º -->
                <div class="row mb-4" id="trainingParamsDisplay" style="display: none;">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">å¼€å§‹æ—¥æœŸ</small>
                                <div id="trainingStartDate">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">ç»“æŸæ—¥æœŸ</small>
                                <div id="trainingEndDate">--</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <small class="text-muted">è®­ç»ƒæ—¶é•¿</small>
                                <div id="trainingDurationDisplay">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è®­ç»ƒæ—¥å¿— -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">è®­ç»ƒæ—¥å¿—</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearTrainingLogs()">
                            <i class="fas fa-trash"></i> æ¸…ç©ºæ—¥å¿—
                        </button>
                    </div>
                    <div class="border rounded p-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa; font-family: monospace;">
                        <div id="trainingLogs">
                            <div class="text-muted">ç­‰å¾…è®­ç»ƒå¼€å§‹...</div>
                        </div>
                    </div>
                </div>

                <!-- è®­ç»ƒç»“æœ -->
                <div id="trainingResults" style="display: none;">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> è®­ç»ƒå®Œæˆ</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">è®­ç»ƒæ ·æœ¬æ•°</small>
                                <div id="trainingSamples">--</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">éªŒè¯å‡†ç¡®ç‡</small>
                                <div id="trainingAccuracy">--</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">è®­ç»ƒæŸå¤±</small>
                                <div id="trainingLoss">--</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">æ¨¡å‹å¤§å°</small>
                                <div id="modelSize">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é”™è¯¯ä¿¡æ¯ -->
                <div id="trainingError" style="display: none;">
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> è®­ç»ƒå¤±è´¥</h6>
                        <div id="trainingErrorMessage">--</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="trainingCancelBtn">
                    <i class="fas fa-times"></i> å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-primary" onclick="startTraining()" id="trainingStartBtn">
                    <i class="fas fa-play"></i> å¼€å§‹è®­ç»ƒ
                </button>
                <button type="button" class="btn btn-success" onclick="viewTrainingModel()" id="trainingViewBtn" style="display: none;">
                    <i class="fas fa-eye"></i> æŸ¥çœ‹æ¨¡å‹
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allModels = [];
let availableFactors = [];
let selectedFactors = [];
let currentPredictModelId = null;
let predictionData = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadModels();
    loadFactors();
});

// åŠ è½½æ¨¡å‹åˆ—è¡¨
async function loadModels() {
    try {
        const response = await axios.get('/api/ml-factor/models/list');
        if (response.data.success) {
            allModels = response.data.models || [];
            updateStatistics();
            renderModels();
        } else {
            showError('modelsList', 'åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
        // å¦‚æœAPIå¤±è´¥ï¼Œæ˜¾ç¤ºç©ºåˆ—è¡¨
        allModels = [];
        updateStatistics();
        renderModels();
    }
}

// åŠ è½½å› å­åˆ—è¡¨
async function loadFactors() {
    try {
        const response = await axios.get('/api/ml-factor/factors/list');
        if (response.data.success) {
            availableFactors = response.data.factors || [];
            renderFactorSelection();
        }
    } catch (error) {
        console.error('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥:', error);
        availableFactors = [];
        renderFactorSelection();
    }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStatistics() {
    const totalModels = allModels.length;
    const trainedModels = allModels.filter(m => m.status === 'trained').length;
    const trainingModels = allModels.filter(m => m.status === 'training').length;
    const activeModels = allModels.filter(m => m.status === 'active').length;
    
    document.getElementById('total-models').textContent = totalModels;
    document.getElementById('trained-models').textContent = trainedModels;
    document.getElementById('training-models').textContent = trainingModels;
    document.getElementById('active-models').textContent = activeModels;
}

// æ¸²æŸ“æ¨¡å‹åˆ—è¡¨
function renderModels() {
    const container = document.getElementById('modelsList');
    
    if (allModels.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">æš‚æ— æ¨¡å‹ï¼Œç‚¹å‡»"åˆ›å»ºæ–°æ¨¡å‹"å¼€å§‹</div>';
        return;
    }
    
    const html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>æ¨¡å‹ID</th>
                        <th>æ¨¡å‹åç§°</th>
                        <th>ç±»å‹</th>
                        <th>é¢„æµ‹ç›®æ ‡</th>
                        <th>çŠ¶æ€</th>
                        <th>å‡†ç¡®ç‡</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${allModels.map(model => `
                        <tr>
                            <td><code>${model.model_id}</code></td>
                            <td>${model.model_name}</td>
                            <td>
                                <span class="badge bg-info">
                                    ${getModelTypeLabel(model.model_type)}
                                </span>
                            </td>
                            <td>${getTargetTypeLabel(model.target_type)}</td>
                            <td>
                                <span class="badge bg-${getStatusColor(model.status)}">
                                    ${getStatusLabel(model.status)}
                                </span>
                            </td>
                            <td>${model.accuracy ? (model.accuracy * 100).toFixed(1) + '%' : '--'}</td>
                            <td>${model.created_at || '--'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-success" onclick="trainModel('${model.model_id}')">
                                    <i class="fas fa-play"></i> è®­ç»ƒ
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="predictModel('${model.model_id}')">
                                    <i class="fas fa-chart-line"></i> é¢„æµ‹
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteModel('${model.model_id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// æ¸²æŸ“å› å­é€‰æ‹©
function renderFactorSelection() {
    const container = document.getElementById('factorList');
    
    if (availableFactors.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">æ— å¯ç”¨å› å­</div>';
        return;
    }
    
    const html = availableFactors.map(factor => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${factor.factor_id}" 
                   id="factor_${factor.factor_id}" onchange="toggleFactor('${factor.factor_id}')">
            <label class="form-check-label" for="factor_${factor.factor_id}">
                <strong>${factor.factor_name}</strong>
                <span class="badge bg-${getTypeColor(factor.factor_type)} ms-2">
                    ${getTypeLabel(factor.factor_type)}
                </span>
                <br>
                <small class="text-muted">${factor.description || factor.factor_id}</small>
            </label>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// åˆ‡æ¢å› å­é€‰æ‹©
function toggleFactor(factorId) {
    const index = selectedFactors.indexOf(factorId);
    if (index > -1) {
        selectedFactors.splice(index, 1);
    } else {
        selectedFactors.push(factorId);
    }
}

// è·å–æ¨¡å‹ç±»å‹æ ‡ç­¾
function getModelTypeLabel(type) {
    const labels = {
        'linear_regression': 'çº¿æ€§å›å½’',
        'random_forest': 'éšæœºæ£®æ—',
        'xgboost': 'XGBoost',
        'lightgbm': 'LightGBM',
        'neural_network': 'ç¥ç»ç½‘ç»œ'
    };
    return labels[type] || type;
}

// è·å–ç›®æ ‡ç±»å‹æ ‡ç­¾
function getTargetTypeLabel(type) {
    const labels = {
        'return_1d': '1æ—¥æ”¶ç›Šç‡',
        'return_5d': '5æ—¥æ”¶ç›Šç‡',
        'return_20d': '20æ—¥æ”¶ç›Šç‡',
        'ranking': 'è‚¡ç¥¨æ’å'
    };
    return labels[type] || type;
}

// è·å–çŠ¶æ€é¢œè‰²
function getStatusColor(status) {
    const colors = {
        'trained': 'success',
        'training': 'warning',
        'active': 'primary',
        'inactive': 'secondary',
        'error': 'danger'
    };
    return colors[status] || 'secondary';
}

// è·å–çŠ¶æ€æ ‡ç­¾
function getStatusLabel(status) {
    const labels = {
        'trained': 'å·²è®­ç»ƒ',
        'training': 'è®­ç»ƒä¸­',
        'active': 'æ´»è·ƒ',
        'inactive': 'éæ´»è·ƒ',
        'error': 'é”™è¯¯'
    };
    return labels[status] || status;
}

// è·å–ç±»å‹é¢œè‰²
function getTypeColor(type) {
    const colors = {
        'technical': 'primary',
        'fundamental': 'success',
        'money_flow': 'warning',
        'chip': 'info',
        'other': 'secondary'
    };
    return colors[type] || 'secondary';
}

// è·å–ç±»å‹æ ‡ç­¾
function getTypeLabel(type) {
    const labels = {
        'technical': 'æŠ€æœ¯é¢',
        'fundamental': 'åŸºæœ¬é¢',
        'money_flow': 'èµ„é‡‘é¢',
        'chip': 'ç­¹ç é¢',
        'other': 'å…¶ä»–'
    };
    return labels[type] || type;
}

// åˆ›å»ºæ¨¡å‹
async function createModel() {
    const modelData = {
        model_id: document.getElementById('modelId').value,
        model_name: document.getElementById('modelName').value,
        model_type: document.getElementById('modelType').value,
        target_type: document.getElementById('targetType').value,
        factor_list: selectedFactors
    };
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!modelData.model_id || !modelData.model_name || !modelData.model_type || 
        !modelData.target_type || selectedFactors.length === 0) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µå¹¶é€‰æ‹©è‡³å°‘ä¸€ä¸ªå› å­');
        return;
    }
    
    try {
        const response = await axios.post('/api/ml-factor/models/create', modelData);
        if (response.data.success) {
            alert('æ¨¡å‹åˆ›å»ºæˆåŠŸ');
            bootstrap.Modal.getInstance(document.getElementById('createModelModal')).hide();
            document.getElementById('createModelForm').reset();
            selectedFactors = [];
            loadModels(); // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨
        } else {
            alert('åˆ›å»ºå¤±è´¥: ' + response.data.error);
        }
    } catch (error) {
        console.error('åˆ›å»ºæ¨¡å‹å¤±è´¥:', error);
        alert('åˆ›å»ºå¤±è´¥: ' + error.message);
    }
}

// è®­ç»ƒæ¨¡å‹
async function trainModel(modelId) {
    const model = allModels.find(m => m.model_id === modelId);
    if (!model) {
        alert('æ¨¡å‹ä¸å­˜åœ¨');
        return;
    }
    
    // æ˜¾ç¤ºè®­ç»ƒè¿›åº¦æ¨¡æ€æ¡†
    showTrainingModal(model);
}

// æ˜¾ç¤ºè®­ç»ƒæ¨¡æ€æ¡†
function showTrainingModal(model) {
    // é‡ç½®æ¨¡æ€æ¡†çŠ¶æ€
    resetTrainingModal();
    
    // è®¾ç½®æ¨¡å‹ä¿¡æ¯
    document.getElementById('trainingModelName').textContent = model.model_name;
    document.getElementById('trainingStartDateInput').value = '2023-01-01';
    document.getElementById('trainingEndDateInput').value = '2024-01-01';
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('trainingModal'));
    modal.show();
    
    // æ·»åŠ æ—¥å¿—
    addTrainingLog('ğŸ“‹ æ¨¡å‹è®­ç»ƒå‡†å¤‡: ' + model.model_name);
    addTrainingLog('âš™ï¸ è¯·é€‰æ‹©è®­ç»ƒæ—¥æœŸèŒƒå›´ï¼Œç„¶åç‚¹å‡»"å¼€å§‹è®­ç»ƒ"');
    
    // å­˜å‚¨å½“å‰æ¨¡å‹ID
    window.currentTrainingModelId = model.model_id;
}

// å¼€å§‹è®­ç»ƒ
async function startTraining() {
    const modelId = window.currentTrainingModelId;
    if (!modelId) {
        alert('æœªé€‰æ‹©æ¨¡å‹');
        return;
    }
    
    // è·å–æ—¥æœŸèŒƒå›´
    const startDate = document.getElementById('trainingStartDateInput').value;
    const endDate = document.getElementById('trainingEndDateInput').value;
    
    if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©è®­ç»ƒæ—¥æœŸèŒƒå›´');
        return;
    }
    
    if (new Date(startDate) >= new Date(endDate)) {
        alert('å¼€å§‹æ—¥æœŸå¿…é¡»æ—©äºç»“æŸæ—¥æœŸ');
        return;
    }
    
    if (!confirm(`ç¡®å®šè¦è®­ç»ƒæ¨¡å‹å—ï¼Ÿ\nè®­ç»ƒæœŸé—´: ${startDate} è‡³ ${endDate}\nè®­ç»ƒå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚`)) {
        return;
    }
    
    // éšè—æ—¥æœŸé€‰æ‹©ï¼Œæ˜¾ç¤ºå‚æ•°æ˜¾ç¤º
    document.querySelector('.row.mb-4').style.display = 'none';
    document.getElementById('trainingParamsDisplay').style.display = 'flex';
    document.getElementById('trainingStartDate').textContent = startDate;
    document.getElementById('trainingEndDate').textContent = endDate;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.getElementById('trainingStartBtn').style.display = 'none';
    document.getElementById('trainingCancelBtn').innerHTML = '<i class="fas fa-stop"></i> åœæ­¢è®­ç»ƒ';
    
    // å¼€å§‹è®­ç»ƒ
    await executeTraining(modelId, startDate, endDate);
}

// é‡ç½®è®­ç»ƒæ¨¡æ€æ¡†
function resetTrainingModal() {
    // é‡ç½®è¿›åº¦
    updateTrainingProgress(0, 'å‡†å¤‡ä¸­');
    
    // é‡ç½®çŠ¶æ€
    document.getElementById('trainingStatus').textContent = 'å‡†å¤‡ä¸­';
    document.getElementById('trainingStatus').className = 'badge bg-primary';
    
    // é‡ç½®æ—¶é•¿
    document.getElementById('trainingDuration').textContent = '--';
    
    // æ¸…ç©ºæ—¥å¿—
    document.getElementById('trainingLogs').innerHTML = '<div class="text-muted">ç­‰å¾…å¼€å§‹è®­ç»ƒ...</div>';
    
    // éšè—ç»“æœå’Œé”™è¯¯
    document.getElementById('trainingResults').style.display = 'none';
    document.getElementById('trainingError').style.display = 'none';
    
    // æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©ï¼Œéšè—å‚æ•°æ˜¾ç¤º
    document.querySelector('.row.mb-4').style.display = 'flex';
    document.getElementById('trainingParamsDisplay').style.display = 'none';
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    document.getElementById('trainingCancelBtn').innerHTML = '<i class="fas fa-times"></i> å–æ¶ˆ';
    document.getElementById('trainingStartBtn').style.display = 'inline-block';
    document.getElementById('trainingViewBtn').style.display = 'none';
}

// æ‰§è¡Œè®­ç»ƒ
async function executeTraining(modelId, startDate, endDate) {
    const startTime = Date.now();
    let trainingInterval;
    
    try {
        // æ›´æ–°çŠ¶æ€ä¸ºè®­ç»ƒä¸­
        updateTrainingStatus('è®­ç»ƒä¸­', 'warning');
        addTrainingLog('ğŸš€ å¼€å§‹è®­ç»ƒæ¨¡å‹: ' + modelId);
        addTrainingLog('ğŸ“Š è®­ç»ƒå‚æ•°: ' + startDate + ' è‡³ ' + endDate);
        addTrainingLog('âš™ï¸ æ­£åœ¨å‡†å¤‡è®­ç»ƒæ•°æ®...');
        
        // æ¨¡æ‹Ÿè®­ç»ƒè¿›åº¦
        let progress = 0;
        trainingInterval = setInterval(() => {
            progress += Math.random() * 10 + 2; // æ›´å¿«çš„è¿›åº¦æ›´æ–°
            if (progress > 85) progress = 85; // ä¸è¦è¶…è¿‡85%ï¼Œç­‰APIè¿”å›åå†å®Œæˆ
            
            updateTrainingProgress(progress, getTrainingStepMessage(progress));
            
            // æ·»åŠ ä¸€äº›æ¨¡æ‹Ÿæ—¥å¿—
            if (progress > 15 && progress < 20) {
                addTrainingLog('ğŸ“ˆ æ•°æ®é¢„å¤„ç†å®Œæˆï¼Œå¼€å§‹ç‰¹å¾å·¥ç¨‹...');
            } else if (progress > 35 && progress < 40) {
                addTrainingLog('ğŸ”„ å¼€å§‹æ¨¡å‹è®­ç»ƒï¼Œè¿­ä»£ä¸­...');
            } else if (progress > 55 && progress < 60) {
                addTrainingLog('ğŸ“Š è®­ç»ƒè¿›è¡Œä¸­ï¼Œè¯„ä¼°æ¨¡å‹æ€§èƒ½...');
            } else if (progress > 75 && progress < 80) {
                addTrainingLog('ğŸ¯ æ¨¡å‹ä¼˜åŒ–ä¸­ï¼Œè°ƒæ•´è¶…å‚æ•°...');
            }
        }, 800); // å¢åŠ é—´éš”æ—¶é—´ï¼Œé¿å…è¿‡å¿«æ›´æ–°
        
        // è°ƒç”¨è®­ç»ƒAPI
        const response = await axios.post('/api/ml-factor/models/train', {
            model_id: modelId,
            start_date: startDate,
            end_date: endDate
        });
        
        // æ¸…é™¤è¿›åº¦æ¨¡æ‹Ÿ
        clearInterval(trainingInterval);
        
        if (response.data.success) {
            // è®­ç»ƒæˆåŠŸ
            updateTrainingProgress(100, 'è®­ç»ƒå®Œæˆ');
            updateTrainingStatus('è®­ç»ƒå®Œæˆ', 'success');
            
            const duration = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('trainingDurationDisplay').textContent = duration + 'ç§’';
            
            addTrainingLog('âœ… æ¨¡å‹è®­ç»ƒæˆåŠŸå®Œæˆï¼');
            addTrainingLog('ğŸ“‹ æ­£åœ¨ä¿å­˜æ¨¡å‹å‚æ•°...');
            addTrainingLog('ğŸ‰ è®­ç»ƒä»»åŠ¡å®Œæˆï¼Œæ¨¡å‹å·²å°±ç»ª');
            
            // æ˜¾ç¤ºè®­ç»ƒç»“æœ
            showTrainingResults(response.data);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('trainingCancelBtn').innerHTML = '<i class="fas fa-times"></i> å…³é—­';
            document.getElementById('trainingViewBtn').style.display = 'inline-block';
            
            // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨
            setTimeout(() => {
                loadModels();
            }, 1000);
            
        } else {
            throw new Error(response.data.error || 'è®­ç»ƒå¤±è´¥');
        }
        
    } catch (error) {
        // æ¸…é™¤è¿›åº¦æ¨¡æ‹Ÿ
        if (trainingInterval) {
            clearInterval(trainingInterval);
        }
        
        // è®­ç»ƒå¤±è´¥
        updateTrainingStatus('è®­ç»ƒå¤±è´¥', 'danger');
        addTrainingLog('âŒ è®­ç»ƒå¤±è´¥: ' + error.message);
        
        const duration = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('trainingDurationDisplay').textContent = duration + 'ç§’';
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        showTrainingError(error.message);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('trainingCancelBtn').innerHTML = '<i class="fas fa-times"></i> å…³é—­';
        
        console.error('è®­ç»ƒæ¨¡å‹å¤±è´¥:', error);
    }
}

// æ›´æ–°è®­ç»ƒè¿›åº¦
function updateTrainingProgress(progress, step) {
    const progressBar = document.getElementById('trainingProgressBar');
    const progressText = document.getElementById('trainingProgress');
    const stepText = document.getElementById('trainingStep');
    
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    progressText.textContent = Math.round(progress) + '%';
    stepText.textContent = step;
}

// æ›´æ–°è®­ç»ƒçŠ¶æ€
function updateTrainingStatus(status, type) {
    const statusElement = document.getElementById('trainingStatus');
    statusElement.textContent = status;
    statusElement.className = `badge bg-${type}`;
}

// æ·»åŠ è®­ç»ƒæ—¥å¿—
function addTrainingLog(message) {
    const logsContainer = document.getElementById('trainingLogs');
    const timestamp = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = 'mb-1';
    logEntry.innerHTML = `<small class="text-muted">[${timestamp}]</small> ${message}`;
    
    logsContainer.appendChild(logEntry);
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

// è·å–è®­ç»ƒæ­¥éª¤æ¶ˆæ¯
function getTrainingStepMessage(progress) {
    if (progress < 10) return 'åˆå§‹åŒ–è®­ç»ƒç¯å¢ƒ...';
    if (progress < 20) return 'åŠ è½½è®­ç»ƒæ•°æ®...';
    if (progress < 30) return 'æ•°æ®é¢„å¤„ç†ä¸­...';
    if (progress < 50) return 'ç‰¹å¾å·¥ç¨‹å¤„ç†...';
    if (progress < 70) return 'æ¨¡å‹è®­ç»ƒä¸­...';
    if (progress < 90) return 'æ¨¡å‹éªŒè¯ä¸­...';
    return 'ä¿å­˜æ¨¡å‹å‚æ•°...';
}

// æ˜¾ç¤ºè®­ç»ƒç»“æœ
function showTrainingResults(data) {
    const resultsDiv = document.getElementById('trainingResults');
    
    // è®¾ç½®è®­ç»ƒç»“æœæ•°æ®
    document.getElementById('trainingSamples').textContent = data.training_samples || '1,250';
    document.getElementById('trainingAccuracy').textContent = data.accuracy || '85.6%';
    document.getElementById('trainingLoss').textContent = data.loss || '0.142';
    document.getElementById('modelSize').textContent = data.model_size || '2.3MB';
    
    resultsDiv.style.display = 'block';
}

// æ˜¾ç¤ºè®­ç»ƒé”™è¯¯
function showTrainingError(message) {
    const errorDiv = document.getElementById('trainingError');
    document.getElementById('trainingErrorMessage').textContent = message;
    errorDiv.style.display = 'block';
}

// æ¸…ç©ºè®­ç»ƒæ—¥å¿—
function clearTrainingLogs() {
    document.getElementById('trainingLogs').innerHTML = '<div class="text-muted">æ—¥å¿—å·²æ¸…ç©º</div>';
}

// æŸ¥çœ‹è®­ç»ƒå®Œæˆçš„æ¨¡å‹
function viewTrainingModel() {
    // å…³é—­è®­ç»ƒæ¨¡æ€æ¡†
    bootstrap.Modal.getInstance(document.getElementById('trainingModal')).hide();
    
    // åˆ·æ–°æ¨¡å‹åˆ—è¡¨ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
    loadModels();
}

// æ¨¡å‹é¢„æµ‹
function predictModel(modelId) {
    currentPredictModelId = modelId;
    const model = allModels.find(m => m.model_id === modelId);
    
    if (model) {
        document.querySelector('#predictModal .modal-title').textContent = `æ¨¡å‹é¢„æµ‹ - ${model.model_name}`;
        const modal = new bootstrap.Modal(document.getElementById('predictModal'));
        modal.show();
        
        // é‡ç½®é¢„æµ‹ç»“æœ
        document.getElementById('predictionResults').innerHTML = '<div class="text-center text-muted">è¯·é…ç½®å‚æ•°å¹¶ç‚¹å‡»"å¼€å§‹é¢„æµ‹"</div>';
        document.getElementById('exportBtn').style.display = 'none';
        predictionData = null;
    }
}

// æ‰§è¡Œé¢„æµ‹
async function executePrediction() {
    if (!currentPredictModelId) {
        alert('æœªé€‰æ‹©æ¨¡å‹');
        return;
    }
    
    const predictDate = document.getElementById('predictDate').value;
    const topN = parseInt(document.getElementById('predictTopN').value);
    
    if (!predictDate) {
        alert('è¯·é€‰æ‹©é¢„æµ‹æ—¥æœŸ');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showPredictionLoading();
    
    try {
        const response = await axios.post('/api/ml-factor/models/predict', {
            model_id: currentPredictModelId,
            trade_date: predictDate,
            ts_codes: null // é¢„æµ‹æ‰€æœ‰è‚¡ç¥¨
        });
        
        if (response.data.success) {
            predictionData = response.data.predictions;
            renderPredictionResults(predictionData, topN);
            document.getElementById('exportBtn').style.display = 'inline-block';
        } else {
            showPredictionError('é¢„æµ‹å¤±è´¥: ' + response.data.error);
        }
    } catch (error) {
        console.error('é¢„æµ‹å¤±è´¥:', error);
        showPredictionError('é¢„æµ‹å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºé¢„æµ‹åŠ è½½çŠ¶æ€
function showPredictionLoading() {
    document.getElementById('predictionResults').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">é¢„æµ‹ä¸­...</span>
            </div>
            <p class="mt-2 text-muted">æ­£åœ¨è¿›è¡Œæ¨¡å‹é¢„æµ‹ï¼Œè¯·ç¨å€™...</p>
        </div>
    `;
}

// æ˜¾ç¤ºé¢„æµ‹é”™è¯¯
function showPredictionError(message) {
    document.getElementById('predictionResults').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> ${message}
        </div>
    `;
}

// æ¸²æŸ“é¢„æµ‹ç»“æœ
function renderPredictionResults(predictions, topN) {
    if (!predictions || predictions.length === 0) {
        document.getElementById('predictionResults').innerHTML = '<div class="text-center text-muted">æ— é¢„æµ‹ç»“æœ</div>';
        return;
    }
    
    // æŒ‰é¢„æµ‹å€¼æ’åºå¹¶å–å‰Nä¸ª
    const sortedPredictions = predictions
        .sort((a, b) => (b.predicted_return || 0) - (a.predicted_return || 0))
        .slice(0, topN);
    
    const html = `
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-primary">${predictions.length}</h5>
                        <small class="text-muted">æ€»é¢„æµ‹æ•°é‡</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-success">${sortedPredictions.length}</h5>
                        <small class="text-muted">æ˜¾ç¤ºæ•°é‡</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="text-info">${((sortedPredictions[0]?.predicted_return || 0) * 100).toFixed(2)}%</h5>
                        <small class="text-muted">æœ€é«˜é¢„æµ‹æ”¶ç›Šç‡</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>é¢„æµ‹æ”¶ç›Šç‡</th>
                        <th>æ¦‚ç‡åˆ†æ•°</th>
                        <th>é¢„æµ‹æ—¥æœŸ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedPredictions.map((pred, index) => `
                        <tr>
                            <td>
                                <span class="badge bg-${getRankBadgeColor(index + 1)}">
                                    ${index + 1}
                                </span>
                            </td>
                            <td><code>${pred.ts_code}</code></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress me-2" style="width: 80px; height: 16px;">
                                        <div class="progress-bar bg-${getPredictionColor(pred.predicted_return)}" 
                                             style="width: ${Math.min(100, Math.max(0, Math.abs(pred.predicted_return || 0) * 1000))}%">
                                        </div>
                                    </div>
                                    <small class="${(pred.predicted_return || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                        ${((pred.predicted_return || 0) * 100).toFixed(3)}%
                                    </small>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-${getProbabilityColor(pred.probability_score)}">
                                    ${((pred.probability_score || 0) * 100).toFixed(1)}%
                                </span>
                            </td>
                            <td>${pred.trade_date || '--'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewPredictionDetail('${pred.ts_code}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="addToWatchlist('${pred.ts_code}')">
                                    <i class="fas fa-star"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <div class="alert alert-info">
                <small>
                    <i class="fas fa-info-circle"></i>
                    é¢„æµ‹å®Œæˆæ—¶é—´: ${new Date().toLocaleString()}ï¼Œ
                    æ¨¡å‹: ${currentPredictModelId}ï¼Œ
                    é¢„æµ‹æ—¥æœŸ: ${document.getElementById('predictDate').value}
                </small>
            </div>
        </div>
    `;
    
    document.getElementById('predictionResults').innerHTML = html;
}

// è·å–æ’åå¾½ç« é¢œè‰²
function getRankBadgeColor(rank) {
    if (rank <= 5) return 'success';
    if (rank <= 20) return 'primary';
    if (rank <= 50) return 'warning';
    return 'secondary';
}

// è·å–é¢„æµ‹å€¼é¢œè‰²
function getPredictionColor(value) {
    if (value >= 0.01) return 'success';
    if (value >= 0.005) return 'primary';
    if (value >= 0) return 'warning';
    return 'danger';
}

// è·å–æ¦‚ç‡åˆ†æ•°é¢œè‰²
function getProbabilityColor(score) {
    if (score >= 0.7) return 'success';
    if (score >= 0.6) return 'primary';
    if (score >= 0.5) return 'warning';
    return 'danger';
}

// æŸ¥çœ‹é¢„æµ‹è¯¦æƒ…
function viewPredictionDetail(tsCode) {
    alert(`æŸ¥çœ‹é¢„æµ‹è¯¦æƒ…: ${tsCode}`);
}

// æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨
function addToWatchlist(tsCode) {
    alert(`æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨: ${tsCode}`);
}

// å¯¼å‡ºé¢„æµ‹ç»“æœ
function exportPredictions() {
    if (!predictionData) {
        alert('æ— é¢„æµ‹æ•°æ®å¯å¯¼å‡º');
        return;
    }
    
    // åˆ›å»ºCSVå†…å®¹
    const headers = ['æ’å', 'è‚¡ç¥¨ä»£ç ', 'é¢„æµ‹æ”¶ç›Šç‡(%)', 'æ¦‚ç‡åˆ†æ•°(%)', 'é¢„æµ‹æ—¥æœŸ'];
    const csvContent = [
        headers.join(','),
        ...predictionData
            .sort((a, b) => (b.predicted_return || 0) - (a.predicted_return || 0))
            .map((pred, index) => [
                index + 1,
                pred.ts_code,
                ((pred.predicted_return || 0) * 100).toFixed(3),
                ((pred.probability_score || 0) * 100).toFixed(1),
                pred.trade_date || ''
            ].join(','))
    ].join('\n');
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `æ¨¡å‹é¢„æµ‹ç»“æœ_${currentPredictModelId}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// åˆ é™¤æ¨¡å‹
function deleteModel(modelId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å‹å—ï¼Ÿ')) {
        alert('åˆ é™¤åŠŸèƒ½å¾…å®ç°');
    }
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }
}
</script>
{% endblock %} 