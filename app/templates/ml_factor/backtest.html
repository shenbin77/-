{% extends "base.html" %}

{% block title %}å›æµ‹éªŒè¯ - å¤šå› å­æ¨¡å‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>ğŸ”„ å›æµ‹éªŒè¯</h1>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="startBacktest()">
                        <i class="fas fa-play"></i> å¼€å§‹å›æµ‹
                    </button>
                    <button class="btn btn-success" onclick="saveStrategy()">
                        <i class="fas fa-save"></i> ä¿å­˜ç­–ç•¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›æµ‹é…ç½® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">âš™ï¸ å›æµ‹é…ç½®</h5>
                </div>
                <div class="card-body">
                    <form id="backtestConfigForm">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="startDate" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                                    <input type="date" class="form-control" id="startDate" value="2023-01-01">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="endDate" class="form-label">ç»“æŸæ—¥æœŸ</label>
                                    <input type="date" class="form-control" id="endDate" value="2024-05-28">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="initialCapital" class="form-label">åˆå§‹èµ„é‡‘</label>
                                    <input type="number" class="form-control" id="initialCapital" value="1000000" min="10000">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="rebalanceFreq" class="form-label">è°ƒä»“é¢‘ç‡</label>
                                    <select class="form-select" id="rebalanceFreq">
                                        <option value="daily">æ¯æ—¥</option>
                                        <option value="weekly">æ¯å‘¨</option>
                                        <option value="monthly" selected>æ¯æœˆ</option>
                                        <option value="quarterly">æ¯å­£åº¦</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="stockCount" class="form-label">æŒè‚¡æ•°é‡</label>
                                    <input type="number" class="form-control" id="stockCount" value="20" min="5" max="100">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="commissionRate" class="form-label">æ‰‹ç»­è´¹ç‡(%)</label>
                                    <input type="number" class="form-control" id="commissionRate" value="0.1" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="slippageRate" class="form-label">æ»‘ç‚¹ç‡(%)</label>
                                    <input type="number" class="form-control" id="slippageRate" value="0.05" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="benchmarkIndex" class="form-label">åŸºå‡†æŒ‡æ•°</label>
                                    <select class="form-select" id="benchmarkIndex">
                                        <option value="000300.SH">æ²ªæ·±300</option>
                                        <option value="000905.SH">ä¸­è¯500</option>
                                        <option value="000852.SH">ä¸­è¯1000</option>
                                        <option value="399006.SZ">åˆ›ä¸šæ¿æŒ‡</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­–ç•¥é€‰æ‹© -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ§  æ¨¡å‹ç­–ç•¥</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="selectedModel" class="form-label">é€‰æ‹©æ¨¡å‹</label>
                        <select class="form-select" id="selectedModel">
                            <option value="">è¯·é€‰æ‹©æ¨¡å‹</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modelWeight" class="form-label">æ¨¡å‹æƒé‡</label>
                        <input type="range" class="form-range" id="modelWeight" min="0" max="100" value="70">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small id="modelWeightValue">70%</small>
                            <small>100%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“Š å› å­ç­–ç•¥</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©å› å­</label>
                        <div id="factorSelection" style="max-height: 200px; overflow-y: auto;">
                            <!-- å› å­é€‰æ‹©åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="factorWeight" class="form-label">å› å­æƒé‡</label>
                        <input type="range" class="form-range" id="factorWeight" min="0" max="100" value="30">
                        <div class="d-flex justify-content-between">
                            <small>0%</small>
                            <small id="factorWeightValue">30%</small>
                            <small>100%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›æµ‹ç»“æœ -->
    <div class="row mb-4" id="backtestResults" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“ˆ å›æµ‹ç»“æœ</h5>
                </div>
                <div class="card-body">
                    <!-- å…³é”®æŒ‡æ ‡ -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-primary" id="totalReturn">--</h4>
                                <small class="text-muted">æ€»æ”¶ç›Šç‡</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-success" id="annualReturn">--</h4>
                                <small class="text-muted">å¹´åŒ–æ”¶ç›Šç‡</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-warning" id="maxDrawdown">--</h4>
                                <small class="text-muted">æœ€å¤§å›æ’¤</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-info" id="sharpeRatio">--</h4>
                                <small class="text-muted">å¤æ™®æ¯”ç‡</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-danger" id="volatility">--</h4>
                                <small class="text-muted">æ³¢åŠ¨ç‡</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h4 class="text-secondary" id="winRate">--</h4>
                                <small class="text-muted">èƒœç‡</small>
                            </div>
                        </div>
                    </div>

                    <!-- æ”¶ç›Šæ›²çº¿å›¾ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div id="returnsChart" style="height: 400px;"></div>
                        </div>
                    </div>

                    <!-- è¯¦ç»†åˆ†æ -->
                    <div class="row">
                        <div class="col-md-6">
                            <div id="drawdownChart" style="height: 300px;"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="rollingReturnsChart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŒä»“åˆ†æ -->
    <div class="row mb-4" id="positionAnalysis" style="display: none;">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“‹ æŒä»“æ˜ç»†</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>è‚¡ç¥¨ä»£ç </th>
                                    <th>è‚¡ç¥¨åç§°</th>
                                    <th>æƒé‡</th>
                                    <th>æŒæœ‰æœŸé—´</th>
                                    <th>æ”¶ç›Šç‡</th>
                                    <th>è´¡çŒ®åº¦</th>
                                </tr>
                            </thead>
                            <tbody id="positionTable">
                                <tr>
                                    <td colspan="6" class="text-center">æš‚æ— æ•°æ®</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ­ è¡Œä¸šåˆ†å¸ƒ</h5>
                </div>
                <div class="card-body">
                    <div id="industryChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é£é™©åˆ†æ -->
    <div class="row mb-4" id="riskAnalysis" style="display: none;">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">âš ï¸ é£é™©æŒ‡æ ‡</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td>VaR (95%)</td>
                                    <td id="var95">--</td>
                                </tr>
                                <tr>
                                    <td>CVaR (95%)</td>
                                    <td id="cvar95">--</td>
                                </tr>
                                <tr>
                                    <td>Beta</td>
                                    <td id="beta">--</td>
                                </tr>
                                <tr>
                                    <td>Alpha</td>
                                    <td id="alpha">--</td>
                                </tr>
                                <tr>
                                    <td>ä¿¡æ¯æ¯”ç‡</td>
                                    <td id="informationRatio">--</td>
                                </tr>
                                <tr>
                                    <td>å¡å°”é©¬æ¯”ç‡</td>
                                    <td id="calmarRatio">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“Š æ”¶ç›Šåˆ†å¸ƒ</h5>
                </div>
                <div class="card-body">
                    <div id="returnsDistributionChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let backtestData = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadModels();
    loadFactors();
    initializeEventListeners();
});

// åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function initializeEventListeners() {
    // æƒé‡æ»‘å—äº‹ä»¶
    document.getElementById('modelWeight').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('modelWeightValue').textContent = value + '%';
        document.getElementById('factorWeight').value = 100 - value;
        document.getElementById('factorWeightValue').textContent = (100 - value) + '%';
    });
    
    document.getElementById('factorWeight').addEventListener('input', function() {
        const value = this.value;
        document.getElementById('factorWeightValue').textContent = value + '%';
        document.getElementById('modelWeight').value = 100 - value;
        document.getElementById('modelWeightValue').textContent = (100 - value) + '%';
    });
}

// åŠ è½½æ¨¡å‹åˆ—è¡¨
async function loadModels() {
    try {
        const response = await axios.get('/api/ml-factor/models/list');
        
        if (response.data.success) {
            const models = response.data.models || [];
            
            const select = document.getElementById('selectedModel');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.model_id;
                option.textContent = `${model.model_name} (${model.model_type})`;
                select.appendChild(option);
            });
        } else {
            console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', response.data.message);
        }
        
    } catch (error) {
        console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
        showAlert('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥', 'warning');
    }
}

// åŠ è½½å› å­åˆ—è¡¨
async function loadFactors() {
    try {
        const response = await axios.get('/api/ml-factor/factors/list');
        
        if (response.data.success) {
            const factors = response.data.factors || [];
            
            const container = document.getElementById('factorSelection');
            container.innerHTML = '';
            
            // æŒ‰å› å­ç±»å‹åˆ†ç»„
            const factorsByType = {};
            factors.forEach(factor => {
                const type = factor.factor_type || 'other';
                if (!factorsByType[type]) {
                    factorsByType[type] = [];
                }
                factorsByType[type].push(factor);
            });
            
            // ç”Ÿæˆåˆ†ç»„çš„å› å­é€‰æ‹©ç•Œé¢
            Object.keys(factorsByType).forEach(type => {
                const typeLabel = getFactorTypeLabel(type);
                
                // æ·»åŠ ç±»å‹æ ‡é¢˜
                const typeHeader = document.createElement('div');
                typeHeader.className = 'fw-bold text-muted mb-2 mt-2';
                typeHeader.textContent = typeLabel;
                container.appendChild(typeHeader);
                
                // æ·»åŠ è¯¥ç±»å‹ä¸‹çš„å› å­
                factorsByType[type].forEach(factor => {
                    const div = document.createElement('div');
                    div.className = 'form-check ms-3';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" value="${factor.factor_id}" id="factor_${factor.factor_id}">
                        <label class="form-check-label" for="factor_${factor.factor_id}">
                            ${factor.factor_name}
                        </label>
                    `;
                    container.appendChild(div);
                });
            });
        } else {
            console.error('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥:', response.data.message);
        }
        
    } catch (error) {
        console.error('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥:', error);
        showAlert('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥', 'warning');
    }
}

// è·å–å› å­ç±»å‹æ ‡ç­¾
function getFactorTypeLabel(type) {
    const labels = {
        'technical': 'ğŸ“ˆ æŠ€æœ¯é¢å› å­',
        'fundamental': 'ğŸ“Š åŸºæœ¬é¢å› å­',
        'money_flow': 'ğŸ’° èµ„é‡‘é¢å› å­',
        'chip': 'ğŸ¯ ç­¹ç é¢å› å­',
        'other': 'ğŸ”§ å…¶ä»–å› å­'
    };
    return labels[type] || 'ğŸ”§ å…¶ä»–å› å­';
}

// å¼€å§‹å›æµ‹
async function startBacktest() {
    const config = getBacktestConfig();
    
    if (!validateConfig(config)) {
        return;
    }
    
    showAlert('æ­£åœ¨æ‰§è¡Œå›æµ‹ï¼Œè¯·ç¨å€™...', 'info');
    
    try {
        // æ„é€ ç­–ç•¥é…ç½®
        const strategyConfig = {
            selection_method: config.model_id ? 'ml_based' : 'factor_based',
            model_ids: config.model_id ? [config.model_id] : [],
            factor_list: config.selected_factors,
            factor_weights: {},  // ç®€åŒ–å¤„ç†ï¼Œä½¿ç”¨ç­‰æƒé‡
            model_weight: config.model_weight,
            factor_weight: config.factor_weight,
            top_n: config.stock_count,
            optimization: {
                method: 'equal_weight',  // ç®€åŒ–å¤„ç†
                constraints: {
                    max_weight: 0.1,
                    min_weight: 0.01
                }
            },
            transaction_cost: config.commission_rate + config.slippage_rate
        };
        
        // ä¸ºé€‰æ‹©çš„å› å­è®¾ç½®ç­‰æƒé‡
        if (config.selected_factors.length > 0) {
            const weight = 1.0 / config.selected_factors.length;
            config.selected_factors.forEach(factor => {
                strategyConfig.factor_weights[factor] = weight;
            });
        }
        
        const requestData = {
            strategy_config: strategyConfig,
            start_date: config.start_date,
            end_date: config.end_date,
            initial_capital: config.initial_capital,
            rebalance_frequency: config.rebalance_freq
        };
        
        const response = await axios.post('/api/ml-factor/backtest/run', requestData);
        
        if (response.data.success) {
            backtestData = response.data;
            displayBacktestResults(backtestData);
            showAlert('å›æµ‹å®Œæˆ', 'success');
        } else {
            showAlert('å›æµ‹å¤±è´¥: ' + (response.data.error || response.data.message), 'danger');
        }
    } catch (error) {
        console.error('å›æµ‹å¤±è´¥:', error);
        let errorMessage = 'å›æµ‹å¤±è´¥';
        if (error.response && error.response.data && error.response.data.error) {
            errorMessage += ': ' + error.response.data.error;
        } else if (error.message) {
            errorMessage += ': ' + error.message;
        }
        showAlert(errorMessage, 'danger');
        
        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤º
        showAlert('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤º', 'info');
        displayMockResults();
    }
}

// è·å–å›æµ‹é…ç½®
function getBacktestConfig() {
    const selectedFactors = Array.from(document.querySelectorAll('#factorSelection input:checked'))
        .map(input => input.value);
    
    return {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        initial_capital: parseFloat(document.getElementById('initialCapital').value),
        rebalance_freq: document.getElementById('rebalanceFreq').value,
        stock_count: parseInt(document.getElementById('stockCount').value),
        commission_rate: parseFloat(document.getElementById('commissionRate').value) / 100,
        slippage_rate: parseFloat(document.getElementById('slippageRate').value) / 100,
        benchmark_index: document.getElementById('benchmarkIndex').value,
        model_id: document.getElementById('selectedModel').value,
        model_weight: parseFloat(document.getElementById('modelWeight').value) / 100,
        selected_factors: selectedFactors,
        factor_weight: parseFloat(document.getElementById('factorWeight').value) / 100
    };
}

// éªŒè¯é…ç½®
function validateConfig(config) {
    if (!config.start_date || !config.end_date) {
        showAlert('è¯·é€‰æ‹©å›æµ‹æ—¶é—´èŒƒå›´', 'warning');
        return false;
    }
    
    if (new Date(config.start_date) >= new Date(config.end_date)) {
        showAlert('å¼€å§‹æ—¥æœŸå¿…é¡»æ—©äºç»“æŸæ—¥æœŸ', 'warning');
        return false;
    }
    
    if (config.initial_capital < 10000) {
        showAlert('åˆå§‹èµ„é‡‘ä¸èƒ½å°‘äº1ä¸‡å…ƒ', 'warning');
        return false;
    }
    
    if (!config.model_id && config.selected_factors.length === 0) {
        showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡å‹æˆ–å› å­', 'warning');
        return false;
    }
    
    return true;
}

// æ˜¾ç¤ºå›æµ‹ç»“æœ
function displayBacktestResults(data) {
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    document.getElementById('backtestResults').style.display = 'block';
    document.getElementById('positionAnalysis').style.display = 'block';
    document.getElementById('riskAnalysis').style.display = 'block';
    
    // ä»åç«¯æ•°æ®ä¸­æå–æŒ‡æ ‡
    const totalReturn = data.total_return || 0;
    const performanceMetrics = data.performance_metrics || {};
    
    // æ›´æ–°å…³é”®æŒ‡æ ‡
    document.getElementById('totalReturn').textContent = (totalReturn * 100).toFixed(2) + '%';
    document.getElementById('annualReturn').textContent = ((performanceMetrics.annual_return || 0) * 100).toFixed(2) + '%';
    document.getElementById('maxDrawdown').textContent = ((performanceMetrics.max_drawdown || 0) * 100).toFixed(2) + '%';
    document.getElementById('sharpeRatio').textContent = (performanceMetrics.sharpe_ratio || 0).toFixed(2);
    document.getElementById('volatility').textContent = ((performanceMetrics.volatility || 0) * 100).toFixed(2) + '%';
    document.getElementById('winRate').textContent = ((performanceMetrics.win_rate || 0) * 100).toFixed(1) + '%';
    
    // å¤„ç†å›¾è¡¨æ•°æ®
    const portfolioValues = data.portfolio_values || [];
    const benchmarkReturns = data.benchmark_returns || [];
    
    // è½¬æ¢ä¸ºå›¾è¡¨éœ€è¦çš„æ ¼å¼
    const returnsData = portfolioValues.map((item, index) => ({
        date: item.date,
        portfolio: item.total_value / (data.initial_capital || 1000000),
        benchmark: benchmarkReturns[index] ? benchmarkReturns[index].value : 1.0
    }));
    
    // è®¡ç®—å›æ’¤æ•°æ®
    const drawdownData = calculateDrawdownFromValues(portfolioValues, data.initial_capital || 1000000);
    
    // ç”Ÿæˆæœˆåº¦æ”¶ç›Šæ•°æ®
    const rollingReturns = generateRollingReturnsFromDaily(data.daily_returns || [], portfolioValues);
    
    // æ¨¡æ‹Ÿè¡Œä¸šåˆ†å¸ƒå’Œæ”¶ç›Šåˆ†å¸ƒæ•°æ®
    const industryDistribution = [
        { name: 'ç”µå­', value: 25 },
        { name: 'åŒ»è¯ç”Ÿç‰©', value: 20 },
        { name: 'è®¡ç®—æœº', value: 15 },
        { name: 'åŒ–å·¥', value: 12 },
        { name: 'æœºæ¢°è®¾å¤‡', value: 10 },
        { name: 'å…¶ä»–', value: 18 }
    ];
    
    const returnsDistribution = generateReturnsDistributionFromDaily(data.daily_returns || []);
    
    // ç»˜åˆ¶å›¾è¡¨
    drawReturnsChart(returnsData);
    drawDrawdownChart(drawdownData);
    drawRollingReturnsChart(rollingReturns);
    drawIndustryChart(industryDistribution);
    drawReturnsDistributionChart(returnsDistribution);
    
    // æ›´æ–°æŒä»“è¡¨
    const positions = generatePositionsFromBacktest(data);
    updatePositionTable(positions);
    
    // æ›´æ–°é£é™©æŒ‡æ ‡
    const riskMetrics = {
        var_95: performanceMetrics.var_95 || -0.023,
        cvar_95: performanceMetrics.cvar_95 || -0.034,
        beta: performanceMetrics.beta || 0.89,
        alpha: performanceMetrics.alpha || 0.045,
        information_ratio: performanceMetrics.information_ratio || 0.67,
        calmar_ratio: performanceMetrics.calmar_ratio || 1.02
    };
    updateRiskMetrics(riskMetrics);
}

// ä»æŠ•èµ„ç»„åˆä»·å€¼è®¡ç®—å›æ’¤
function calculateDrawdownFromValues(portfolioValues, initialCapital) {
    const data = [];
    let maxValue = initialCapital;
    
    portfolioValues.forEach(item => {
        const currentValue = item.total_value;
        maxValue = Math.max(maxValue, currentValue);
        const drawdown = (currentValue - maxValue) / maxValue;
        
        data.push({
            date: item.date,
            drawdown: drawdown
        });
    });
    
    return data;
}

// ä»æ—¥æ”¶ç›Šç‡ç”Ÿæˆæœˆåº¦æ”¶ç›Š
function generateRollingReturnsFromDaily(dailyReturns, portfolioValues) {
    if (!dailyReturns || dailyReturns.length === 0) {
        return generateMockRollingReturns();
    }
    
    // ç®€åŒ–å¤„ç†ï¼šæ¯30ä¸ªäº¤æ˜“æ—¥ä½œä¸ºä¸€ä¸ªæœˆ
    const monthlyData = [];
    const monthSize = 30;
    
    for (let i = 0; i < dailyReturns.length; i += monthSize) {
        const monthReturns = dailyReturns.slice(i, i + monthSize);
        const monthReturn = monthReturns.reduce((acc, ret) => (1 + acc) * (1 + ret) - 1, 0);
        
        const dateIndex = Math.min(i + monthSize - 1, portfolioValues.length - 1);
        const date = portfolioValues[dateIndex] ? portfolioValues[dateIndex].date : new Date().toISOString().split('T')[0];
        
        monthlyData.push({
            date: date.substring(0, 7), // YYYY-MMæ ¼å¼
            portfolio: monthReturn,
            benchmark: monthReturn * 0.8 // æ¨¡æ‹ŸåŸºå‡†æ”¶ç›Š
        });
    }
    
    return monthlyData;
}

// ä»æ—¥æ”¶ç›Šç‡ç”Ÿæˆæ”¶ç›Šåˆ†å¸ƒ
function generateReturnsDistributionFromDaily(dailyReturns) {
    if (!dailyReturns || dailyReturns.length === 0) {
        return generateMockReturnsDistribution();
    }
    
    // åˆ›å»ºæ”¶ç›Šç‡åŒºé—´
    const bins = [];
    for (let i = -10; i <= 10; i++) {
        bins.push(i / 100);
    }
    
    // ç»Ÿè®¡æ¯ä¸ªåŒºé—´çš„é¢‘ç‡
    const distribution = bins.map(binValue => {
        const count = dailyReturns.filter(ret => 
            ret >= binValue - 0.005 && ret < binValue + 0.005
        ).length;
        
        return {
            returns: binValue,
            frequency: count
        };
    });
    
    return distribution;
}

// ä»å›æµ‹æ•°æ®ç”ŸæˆæŒä»“ä¿¡æ¯
function generatePositionsFromBacktest(data) {
    const dailyPositions = data.daily_positions || [];
    
    if (dailyPositions.length === 0) {
        return generateMockPositions();
    }
    
    // å–æœ€åä¸€æœŸçš„æŒä»“
    const lastPositions = dailyPositions[dailyPositions.length - 1] || {};
    const totalValue = data.final_value || data.initial_capital || 1000000;
    
    return Object.entries(lastPositions).map(([ tsCode, shares ], index) => ({
        code: tsCode,
        name: tsCode, // ç®€åŒ–å¤„ç†
        weight: (shares * 100) / totalValue, // å‡è®¾è‚¡ä»·ä¸º100å…ƒ
        period: 'æŒæœ‰ä¸­',
        return: (Math.random() - 0.4) * 0.3, // æ¨¡æ‹Ÿæ”¶ç›Šç‡
        contribution: (Math.random() - 0.4) * 0.05 // æ¨¡æ‹Ÿè´¡çŒ®åº¦
    }));
}

// æ˜¾ç¤ºæ¨¡æ‹Ÿç»“æœï¼ˆç”¨äºæ¼”ç¤ºï¼‰
function displayMockResults() {
    const mockData = {
        total_return: 0.156,
        annual_return: 0.089,
        max_drawdown: -0.087,
        sharpe_ratio: 1.23,
        volatility: 0.145,
        win_rate: 0.634,
        returns_data: generateMockReturnsData(),
        drawdown_data: generateMockDrawdownData(),
        rolling_returns: generateMockRollingReturns(),
        industry_distribution: [
            { name: 'ç”µå­', value: 25 },
            { name: 'åŒ»è¯ç”Ÿç‰©', value: 20 },
            { name: 'è®¡ç®—æœº', value: 15 },
            { name: 'åŒ–å·¥', value: 12 },
            { name: 'æœºæ¢°è®¾å¤‡', value: 10 },
            { name: 'å…¶ä»–', value: 18 }
        ],
        returns_distribution: generateMockReturnsDistribution(),
        positions: generateMockPositions(),
        risk_metrics: {
            var_95: -0.023,
            cvar_95: -0.034,
            beta: 0.89,
            alpha: 0.045,
            information_ratio: 0.67,
            calmar_ratio: 1.02
        }
    };
    
    displayBacktestResults(mockData);
}

// ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®çš„è¾…åŠ©å‡½æ•°
function generateMockReturnsData() {
    const data = [];
    let portfolioValue = 1.0;
    let benchmarkValue = 1.0;
    
    for (let i = 0; i < 365; i++) {
        const date = new Date(2023, 0, 1);
        date.setDate(date.getDate() + i);
        
        portfolioValue *= (1 + (Math.random() - 0.48) * 0.02);
        benchmarkValue *= (1 + (Math.random() - 0.49) * 0.015);
        
        data.push({
            date: date.toISOString().split('T')[0],
            portfolio: portfolioValue,
            benchmark: benchmarkValue
        });
    }
    
    return data;
}

function generateMockDrawdownData() {
    const data = [];
    let maxValue = 1.0;
    let currentValue = 1.0;
    
    for (let i = 0; i < 365; i++) {
        const date = new Date(2023, 0, 1);
        date.setDate(date.getDate() + i);
        
        currentValue *= (1 + (Math.random() - 0.48) * 0.02);
        maxValue = Math.max(maxValue, currentValue);
        
        const drawdown = (currentValue - maxValue) / maxValue;
        
        data.push({
            date: date.toISOString().split('T')[0],
            drawdown: drawdown
        });
    }
    
    return data;
}

function generateMockRollingReturns() {
    const data = [];
    
    for (let i = 0; i < 12; i++) {
        const date = new Date(2023, i, 1);
        data.push({
            date: date.toISOString().split('T')[0].substring(0, 7),
            portfolio: (Math.random() - 0.4) * 0.2,
            benchmark: (Math.random() - 0.45) * 0.15
        });
    }
    
    return data;
}

function generateMockReturnsDistribution() {
    const data = [];
    
    for (let i = -10; i <= 10; i++) {
        const returns = i / 100;
        const frequency = Math.exp(-Math.pow(returns - 0.001, 2) / (2 * Math.pow(0.02, 2)));
        data.push({ returns: returns, frequency: frequency });
    }
    
    return data;
}

function generateMockPositions() {
    const stocks = [
        { code: '000001.SZ', name: 'å¹³å®‰é“¶è¡Œ', weight: 0.08, period: '2023-01-01 ~ 2023-12-31', return: 0.12, contribution: 0.0096 },
        { code: '000002.SZ', name: 'ä¸‡ç§‘A', weight: 0.06, period: '2023-01-01 ~ 2023-12-31', return: -0.05, contribution: -0.003 },
        { code: '600036.SH', name: 'æ‹›å•†é“¶è¡Œ', weight: 0.09, period: '2023-01-01 ~ 2023-12-31', return: 0.15, contribution: 0.0135 },
        { code: '600519.SH', name: 'è´µå·èŒ…å°', weight: 0.07, period: '2023-01-01 ~ 2023-12-31', return: 0.08, contribution: 0.0056 },
        { code: '000858.SZ', name: 'äº”ç²®æ¶²', weight: 0.05, period: '2023-01-01 ~ 2023-12-31', return: 0.06, contribution: 0.003 }
    ];
    
    return stocks;
}

// ç»˜åˆ¶æ”¶ç›Šæ›²çº¿å›¾
function drawReturnsChart(data) {
    const chart = echarts.init(document.getElementById('returnsChart'));
    
    const option = {
        title: {
            text: 'ç´¯è®¡æ”¶ç›Šæ›²çº¿',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['ç­–ç•¥æ”¶ç›Š', 'åŸºå‡†æ”¶ç›Š'],
            bottom: 0
        },
        xAxis: {
            type: 'category',
            data: data.map(d => d.date)
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: function(value) {
                    return ((value - 1) * 100).toFixed(1) + '%';
                }
            }
        },
        series: [
            {
                name: 'ç­–ç•¥æ”¶ç›Š',
                type: 'line',
                data: data.map(d => d.portfolio),
                lineStyle: { width: 2 }
            },
            {
                name: 'åŸºå‡†æ”¶ç›Š',
                type: 'line',
                data: data.map(d => d.benchmark),
                lineStyle: { width: 2 }
            }
        ]
    };
    
    chart.setOption(option);
}

// ç»˜åˆ¶å›æ’¤å›¾
function drawDrawdownChart(data) {
    const chart = echarts.init(document.getElementById('drawdownChart'));
    
    const option = {
        title: {
            text: 'å›æ’¤åˆ†æ',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis'
        },
        xAxis: {
            type: 'category',
            data: data.map(d => d.date)
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value}%'
            }
        },
        series: [
            {
                name: 'å›æ’¤',
                type: 'line',
                data: data.map(d => d.drawdown * 100),
                areaStyle: {
                    color: 'rgba(255, 0, 0, 0.1)'
                },
                lineStyle: {
                    color: '#ff4757'
                }
            }
        ]
    };
    
    chart.setOption(option);
}

// ç»˜åˆ¶æ»šåŠ¨æ”¶ç›Šå›¾
function drawRollingReturnsChart(data) {
    const chart = echarts.init(document.getElementById('rollingReturnsChart'));
    
    const option = {
        title: {
            text: 'æœˆåº¦æ”¶ç›Šå¯¹æ¯”',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['ç­–ç•¥æ”¶ç›Š', 'åŸºå‡†æ”¶ç›Š'],
            bottom: 0
        },
        xAxis: {
            type: 'category',
            data: data.map(d => d.date)
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value}%'
            }
        },
        series: [
            {
                name: 'ç­–ç•¥æ”¶ç›Š',
                type: 'bar',
                data: data.map(d => d.portfolio * 100)
            },
            {
                name: 'åŸºå‡†æ”¶ç›Š',
                type: 'bar',
                data: data.map(d => d.benchmark * 100)
            }
        ]
    };
    
    chart.setOption(option);
}

// ç»˜åˆ¶è¡Œä¸šåˆ†å¸ƒå›¾
function drawIndustryChart(data) {
    const chart = echarts.init(document.getElementById('industryChart'));
    
    const option = {
        title: {
            text: 'è¡Œä¸šåˆ†å¸ƒ',
            left: 'center'
        },
        tooltip: {
            trigger: 'item'
        },
        series: [
            {
                name: 'æƒé‡',
                type: 'pie',
                radius: '50%',
                data: data,
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
    
    chart.setOption(option);
}

// ç»˜åˆ¶æ”¶ç›Šåˆ†å¸ƒå›¾
function drawReturnsDistributionChart(data) {
    const chart = echarts.init(document.getElementById('returnsDistributionChart'));
    
    const option = {
        title: {
            text: 'æ”¶ç›Šåˆ†å¸ƒ',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis'
        },
        xAxis: {
            type: 'category',
            data: data.map(d => (d.returns * 100).toFixed(1) + '%')
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: 'é¢‘ç‡',
                type: 'bar',
                data: data.map(d => d.frequency)
            }
        ]
    };
    
    chart.setOption(option);
}

// æ›´æ–°æŒä»“è¡¨
function updatePositionTable(positions) {
    const tbody = document.getElementById('positionTable');
    
    if (!positions || positions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    tbody.innerHTML = positions.map(pos => `
        <tr>
            <td>${pos.code}</td>
            <td>${pos.name}</td>
            <td>${(pos.weight * 100).toFixed(1)}%</td>
            <td>${pos.period}</td>
            <td class="${pos.return >= 0 ? 'text-success' : 'text-danger'}">
                ${(pos.return * 100).toFixed(2)}%
            </td>
            <td class="${pos.contribution >= 0 ? 'text-success' : 'text-danger'}">
                ${(pos.contribution * 100).toFixed(2)}%
            </td>
        </tr>
    `).join('');
}

// æ›´æ–°é£é™©æŒ‡æ ‡
function updateRiskMetrics(metrics) {
    document.getElementById('var95').textContent = (metrics.var_95 * 100).toFixed(2) + '%';
    document.getElementById('cvar95').textContent = (metrics.cvar_95 * 100).toFixed(2) + '%';
    document.getElementById('beta').textContent = metrics.beta.toFixed(2);
    document.getElementById('alpha').textContent = (metrics.alpha * 100).toFixed(2) + '%';
    document.getElementById('informationRatio').textContent = metrics.information_ratio.toFixed(2);
    document.getElementById('calmarRatio').textContent = metrics.calmar_ratio.toFixed(2);
}

// ä¿å­˜ç­–ç•¥
async function saveStrategy() {
    const config = getBacktestConfig();
    
    if (!backtestData) {
        showAlert('è¯·å…ˆæ‰§è¡Œå›æµ‹', 'warning');
        return;
    }
    
    const strategyName = prompt('è¯·è¾“å…¥ç­–ç•¥åç§°:');
    if (!strategyName) {
        return;
    }
    
    try {
        const response = await axios.post('/api/ml-factor/strategies/save', {
            name: strategyName,
            config: config,
            results: backtestData
        });
        
        if (response.data.success) {
            showAlert('ç­–ç•¥ä¿å­˜æˆåŠŸ', 'success');
        } else {
            showAlert('ä¿å­˜å¤±è´¥: ' + response.data.message, 'danger');
        }
    } catch (error) {
        console.error('ä¿å­˜ç­–ç•¥å¤±è´¥:', error);
        showAlert('ä¿å­˜ç­–ç•¥å¤±è´¥', 'danger');
    }
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>
{% endblock %} 