{% extends "base.html" %}

{% block title %}æŠ•èµ„ç»„åˆ - å¤šå› å­æ¨¡å‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>ğŸ’¼ æŠ•èµ„ç»„åˆ</h1>
                    <p class="text-muted">æ™ºèƒ½æ„å»ºå’Œä¼˜åŒ–æŠ•èµ„ç»„åˆ</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPortfolioModal">
                    <i class="fas fa-plus"></i> åˆ›å»ºç»„åˆ
                </button>
            </div>
        </div>
    </div>

    <!-- ç»„åˆä¼˜åŒ–å·¥å…· -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ç»„åˆä¼˜åŒ–å·¥å…·</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="optimizationMethod" class="form-label">ä¼˜åŒ–æ–¹æ³•</label>
                            <select class="form-select" id="optimizationMethod">
                                <option value="mean_variance">å‡å€¼æ–¹å·®ä¼˜åŒ–</option>
                                <option value="risk_parity">é£é™©å¹³ä»·</option>
                                <option value="max_sharpe">æœ€å¤§å¤æ™®æ¯”ç‡</option>
                                <option value="min_variance">æœ€å°æ–¹å·®</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="riskLevel" class="form-label">é£é™©æ°´å¹³</label>
                            <select class="form-select" id="riskLevel">
                                <option value="conservative">ä¿å®ˆå‹</option>
                                <option value="moderate">ç¨³å¥å‹</option>
                                <option value="aggressive">ç§¯æå‹</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="maxStocks" class="form-label">æœ€å¤§æŒè‚¡æ•°</label>
                            <input type="number" class="form-control" id="maxStocks" value="20" min="5" max="50">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button class="btn btn-success" onclick="optimizePortfolio()">
                                    <i class="fas fa-chart-line"></i> ä¼˜åŒ–ç»„åˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»„åˆåˆ—è¡¨ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">æˆ‘çš„æŠ•èµ„ç»„åˆ</h5>
                </div>
                <div class="card-body">
                    <div id="portfolioList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºç»„åˆæ¨¡æ€æ¡† -->
<div class="modal fade" id="createPortfolioModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åˆ›å»ºæŠ•èµ„ç»„åˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPortfolioForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="portfolioName" class="form-label">ç»„åˆåç§° *</label>
                                <input type="text" class="form-control" id="portfolioName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="initialCapital" class="form-label">åˆå§‹èµ„é‡‘ *</label>
                                <input type="number" class="form-control" id="initialCapital" value="1000000" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="portfolioDescription" class="form-label">ç»„åˆæè¿°</label>
                        <textarea class="form-control" id="portfolioDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰è‚¡ç­–ç•¥</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="selectionStrategy" 
                                           id="factorStrategy" value="factor_based" checked>
                                    <label class="form-check-label" for="factorStrategy">
                                        åŸºäºå› å­é€‰è‚¡
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="selectionStrategy" 
                                           id="mlStrategy" value="ml_based">
                                    <label class="form-check-label" for="mlStrategy">
                                        åŸºäºMLæ¨¡å‹é€‰è‚¡
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createPortfolio()">åˆ›å»ºç»„åˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- ç»„åˆè¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="portfolioDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="portfolioDetailTitle">ç»„åˆè¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="portfolioDetailContent">
                    <!-- ç»„åˆè¯¦æƒ…å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let portfolios = [];

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadPortfolios();
});

// åŠ è½½æŠ•èµ„ç»„åˆåˆ—è¡¨
async function loadPortfolios() {
    try {
        // æ¨¡æ‹Ÿæ•°æ®
        portfolios = [
            {
                id: 'portfolio_001',
                name: 'ä»·å€¼æŠ•èµ„ç»„åˆ',
                description: 'åŸºäºä»·å€¼å› å­çš„é•¿æœŸæŠ•èµ„ç»„åˆ',
                initial_capital: 1000000,
                current_value: 1150000,
                return_rate: 0.15,
                volatility: 0.12,
                sharpe_ratio: 1.25,
                max_drawdown: 0.08,
                created_at: '2024-01-01',
                status: 'active',
                holdings: [
                    {ts_code: '000001.SZ', name: 'å¹³å®‰é“¶è¡Œ', weight: 0.15, value: 172500},
                    {ts_code: '600036.SH', name: 'æ‹›å•†é“¶è¡Œ', weight: 0.12, value: 138000},
                    {ts_code: '000002.SZ', name: 'ä¸‡ç§‘A', weight: 0.10, value: 115000}
                ]
            },
            {
                id: 'portfolio_002',
                name: 'æˆé•¿æŠ•èµ„ç»„åˆ',
                description: 'åŸºäºæˆé•¿å› å­çš„æŠ•èµ„ç»„åˆ',
                initial_capital: 500000,
                current_value: 580000,
                return_rate: 0.16,
                volatility: 0.18,
                sharpe_ratio: 0.89,
                max_drawdown: 0.15,
                created_at: '2024-02-01',
                status: 'active',
                holdings: []
            }
        ];
        
        renderPortfolios();
    } catch (error) {
        console.error('åŠ è½½æŠ•èµ„ç»„åˆå¤±è´¥:', error);
        showError('portfolioList', 'åŠ è½½æŠ•èµ„ç»„åˆå¤±è´¥');
    }
}

// æ¸²æŸ“æŠ•èµ„ç»„åˆåˆ—è¡¨
function renderPortfolios() {
    const container = document.getElementById('portfolioList');
    
    if (portfolios.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">æš‚æ— æŠ•èµ„ç»„åˆï¼Œç‚¹å‡»"åˆ›å»ºç»„åˆ"å¼€å§‹</div>';
        return;
    }
    
    const html = portfolios.map(portfolio => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title">
                            ${portfolio.name}
                            <span class="badge bg-${portfolio.status === 'active' ? 'success' : 'secondary'} ms-2">
                                ${portfolio.status === 'active' ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
                            </span>
                        </h5>
                        <p class="card-text text-muted">${portfolio.description}</p>
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">åˆå§‹èµ„é‡‘</small>
                                <div class="fw-bold">${formatAmount(portfolio.initial_capital)}</div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">å½“å‰ä»·å€¼</small>
                                <div class="fw-bold text-${portfolio.current_value > portfolio.initial_capital ? 'success' : 'danger'}">
                                    ${formatAmount(portfolio.current_value)}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">æ”¶ç›Šç‡</small>
                                <div class="fw-bold text-${portfolio.return_rate > 0 ? 'success' : 'danger'}">
                                    ${formatPercent(portfolio.return_rate)}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">å¤æ™®æ¯”ç‡</small>
                                <div class="fw-bold">${portfolio.sharpe_ratio.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary" onclick="viewPortfolioDetail('${portfolio.id}')">
                                <i class="fas fa-eye"></i> è¯¦æƒ…
                            </button>
                            <button class="btn btn-outline-success" onclick="rebalancePortfolio('${portfolio.id}')">
                                <i class="fas fa-balance-scale"></i> å†å¹³è¡¡
                            </button>
                            <button class="btn btn-outline-warning" onclick="editPortfolio('${portfolio.id}')">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </button>
                            <button class="btn btn-outline-danger" onclick="deletePortfolio('${portfolio.id}')">
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">åˆ›å»ºäº ${portfolio.created_at}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// ä¼˜åŒ–æŠ•èµ„ç»„åˆ
async function optimizePortfolio() {
    const method = document.getElementById('optimizationMethod').value;
    const riskLevel = document.getElementById('riskLevel').value;
    const maxStocks = parseInt(document.getElementById('maxStocks').value);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const button = document.querySelector('button[onclick="optimizePortfolio()"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¼˜åŒ–ä¸­...';
    button.disabled = true;
    
    try {
        // æ ¹æ®é£é™©æ°´å¹³è®¾ç½®ä¼˜åŒ–å‚æ•°
        const riskParams = getRiskParameters(riskLevel);
        const tradeDate = new Date().toISOString().split('T')[0];
        
        // é¦–å…ˆå°è¯•ä½¿ç”¨é€‰æ‹©çš„ä¼˜åŒ–æ–¹æ³•
        let response;
        try {
            response = await axios.post('/api/ml-factor/portfolio/integrated-selection', {
                trade_date: tradeDate,
                selection_method: 'factor_based',
                factor_list: ['momentum_5d', 'pe_percentile', 'money_flow_strength'],
                weights: {'momentum_5d': 0.4, 'pe_percentile': 0.3, 'money_flow_strength': 0.3},
                top_n: Math.max(maxStocks * 2, 20), // é€‰æ‹©æ›´å¤§çš„è‚¡ç¥¨æ± è¿›è¡Œä¼˜åŒ–
                optimization_method: method,
                constraints: {
                    max_weight: riskParams.max_weight,
                    min_weight: riskParams.min_weight,
                    max_stocks: maxStocks,
                    target_return: riskParams.target_return,
                    risk_tolerance: riskParams.risk_tolerance
                }
            });
        } catch (error) {
            console.warn(`${method} ä¼˜åŒ–å¤±è´¥ï¼Œå°è¯•ç­‰æƒé‡æ–¹æ³•:`, error.message);
            response = null;
        }
        
        // å¦‚æœä¸»è¦æ–¹æ³•å¤±è´¥ï¼Œå›é€€åˆ°ç­‰æƒé‡æ–¹æ³•
        if (!response || !response.data.success) {
            console.log('å›é€€åˆ°ç­‰æƒé‡ä¼˜åŒ–æ–¹æ³•...');
            
            response = await axios.post('/api/ml-factor/portfolio/integrated-selection', {
                trade_date: tradeDate,
                selection_method: 'factor_based',
                factor_list: ['momentum_5d', 'pe_percentile'],
                weights: {'momentum_5d': 0.6, 'pe_percentile': 0.4},
                top_n: maxStocks,
                optimization_method: 'equal_weight'
            });
            
            if (response.data.success) {
                // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
                showOptimizationWarning(method, 'equal_weight');
            }
        }
        
        if (response.data.success) {
            // æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
            showOptimizationResults(response.data.portfolio_optimization, method, riskLevel, maxStocks, response.data);
        } else {
            throw new Error('æ‰€æœ‰ä¼˜åŒ–æ–¹æ³•éƒ½å¤±è´¥äº†: ' + (response.data.error || 'æœªçŸ¥é”™è¯¯'));
        }
        
    } catch (error) {
        console.error('æŠ•èµ„ç»„åˆä¼˜åŒ–å¤±è´¥:', error);
        alert('æŠ•èµ„ç»„åˆä¼˜åŒ–å¤±è´¥: ' + error.message + '\n\nè¯·æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å› å­æ•°æ®ï¼Œæˆ–å°è¯•å‡å°‘æœ€å¤§æŒè‚¡æ•°ã€‚');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// æ ¹æ®é£é™©æ°´å¹³è·å–å‚æ•°
function getRiskParameters(riskLevel) {
    const params = {
        'conservative': {
            max_weight: 0.08,      // å•åªè‚¡ç¥¨æœ€å¤§æƒé‡8%
            min_weight: 0.02,      // å•åªè‚¡ç¥¨æœ€å°æƒé‡2%
            target_return: 0.08,   // ç›®æ ‡å¹´åŒ–æ”¶ç›Šç‡8%
            risk_tolerance: 0.12   // é£é™©å®¹å¿åº¦12%
        },
        'moderate': {
            max_weight: 0.12,      // å•åªè‚¡ç¥¨æœ€å¤§æƒé‡12%
            min_weight: 0.01,      // å•åªè‚¡ç¥¨æœ€å°æƒé‡1%
            target_return: 0.12,   // ç›®æ ‡å¹´åŒ–æ”¶ç›Šç‡12%
            risk_tolerance: 0.18   // é£é™©å®¹å¿åº¦18%
        },
        'aggressive': {
            max_weight: 0.20,      // å•åªè‚¡ç¥¨æœ€å¤§æƒé‡20%
            min_weight: 0.005,     // å•åªè‚¡ç¥¨æœ€å°æƒé‡0.5%
            target_return: 0.18,   // ç›®æ ‡å¹´åŒ–æ”¶ç›Šç‡18%
            risk_tolerance: 0.25   // é£é™©å®¹å¿åº¦25%
        }
    };
    
    return params[riskLevel] || params['moderate'];
}

// æ˜¾ç¤ºä¼˜åŒ–ç»“æœ
function showOptimizationResults(data, method, riskLevel, maxStocks, responseData) {
    const weights = data.weights || {};
    const stats = data.portfolio_stats || {};
    
    // åˆ›å»ºç»“æœæ¨¡æ€æ¡†
    const modalHtml = `
        <div class="modal fade" id="optimizationResultModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-line"></i> æŠ•èµ„ç»„åˆä¼˜åŒ–ç»“æœ
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ä¼˜åŒ–å‚æ•° -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-cog"></i> ä¼˜åŒ–å‚æ•°</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>ä¼˜åŒ–æ–¹æ³•:</strong> ${getMethodLabel(method)}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>é£é™©æ°´å¹³:</strong> ${getRiskLabel(riskLevel)}
                                        </div>
                                        <div class="col-md-3">
                                            <strong>æœ€å¤§æŒè‚¡æ•°:</strong> ${maxStocks}åª
                                        </div>
                                        <div class="col-md-3">
                                            <strong>å®é™…æŒè‚¡æ•°:</strong> ${Object.keys(weights).length}åª
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç»„åˆç»Ÿè®¡ -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-primary">${formatPercent(stats.expected_return || 0)}</h4>
                                        <p class="card-text">é¢„æœŸæ”¶ç›Šç‡</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-warning">${formatPercent(stats.volatility || 0)}</h4>
                                        <p class="card-text">ç»„åˆæ³¢åŠ¨ç‡</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-success">${(stats.sharpe_ratio || 0).toFixed(2)}</h4>
                                        <p class="card-text">å¤æ™®æ¯”ç‡</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h4 class="text-info">${formatPercent(stats.max_weight || 0)}</h4>
                                        <p class="card-text">æœ€å¤§æƒé‡</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æƒé‡åˆ†å¸ƒ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-chart-pie"></i> æƒé‡åˆ†å¸ƒ</h6>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>æ’å</th>
                                                <th>è‚¡ç¥¨ä»£ç </th>
                                                <th>æƒé‡</th>
                                                <th>æƒé‡å¯è§†åŒ–</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(weights)
                                                .sort(([,a], [,b]) => b - a)
                                                .map(([ts_code, weight], index) => `
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-${getWeightBadgeColor(index + 1)}">
                                                                ${index + 1}
                                                            </span>
                                                        </td>
                                                        <td><code>${ts_code}</code></td>
                                                        <td><strong>${formatPercent(weight)}</strong></td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar bg-${getWeightProgressColor(weight)}" 
                                                                     style="width: ${(weight * 100 / Math.max(...Object.values(weights))) * 100}%">
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é£é™©åˆ†æ -->
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-shield-alt"></i> é£é™©åˆ†æ</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">æƒé‡é›†ä¸­åº¦</h6>
                                                <p class="card-text">
                                                    å‰5å¤§æŒä»“æƒé‡: <strong>${formatPercent(
                                                        Object.values(weights)
                                                            .sort((a, b) => b - a)
                                                            .slice(0, 5)
                                                            .reduce((sum, w) => sum + w, 0)
                                                    )}</strong>
                                                </p>
                                                <p class="card-text">
                                                    æƒé‡æ ‡å‡†å·®: <strong>${formatPercent(calculateWeightStd(weights))}</strong>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">åˆ†æ•£åŒ–ç¨‹åº¦</h6>
                                                <p class="card-text">
                                                    æœ‰æ•ˆè‚¡ç¥¨æ•°: <strong>${calculateEffectiveStocks(weights).toFixed(1)}åª</strong>
                                                </p>
                                                <p class="card-text">
                                                    åˆ†æ•£åŒ–æ¯”ç‡: <strong>${formatPercent(calculateEffectiveStocks(weights) / Object.keys(weights).length)}</strong>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        <button type="button" class="btn btn-success" onclick="saveOptimizedPortfolio()">
                            <i class="fas fa-save"></i> ä¿å­˜ä¸ºæŠ•èµ„ç»„åˆ
                        </button>
                        <button type="button" class="btn btn-primary" onclick="exportOptimizationResults()">
                            <i class="fas fa-download"></i> å¯¼å‡ºç»“æœ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    const existingModal = document.getElementById('optimizationResultModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // æ·»åŠ æ–°æ¨¡æ€æ¡†åˆ°é¡µé¢
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ä¿å­˜ä¼˜åŒ–ç»“æœåˆ°å…¨å±€å˜é‡
    window.currentOptimizationResult = {
        weights: weights,
        stats: stats,
        method: method,
        riskLevel: riskLevel,
        maxStocks: maxStocks
    };
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    new bootstrap.Modal(document.getElementById('optimizationResultModal')).show();
}

// è·å–æ–¹æ³•æ ‡ç­¾
function getMethodLabel(method) {
    const labels = {
        'mean_variance': 'å‡å€¼æ–¹å·®ä¼˜åŒ–',
        'risk_parity': 'é£é™©å¹³ä»·',
        'max_sharpe': 'æœ€å¤§å¤æ™®æ¯”ç‡',
        'min_variance': 'æœ€å°æ–¹å·®'
    };
    return labels[method] || method;
}

// è·å–é£é™©æ ‡ç­¾
function getRiskLabel(riskLevel) {
    const labels = {
        'conservative': 'ä¿å®ˆå‹',
        'moderate': 'ç¨³å¥å‹',
        'aggressive': 'ç§¯æå‹'
    };
    return labels[riskLevel] || riskLevel;
}

// è·å–æƒé‡å¾½ç« é¢œè‰²
function getWeightBadgeColor(rank) {
    if (rank <= 3) return 'success';
    if (rank <= 10) return 'primary';
    if (rank <= 20) return 'warning';
    return 'secondary';
}

// è·å–æƒé‡è¿›åº¦æ¡é¢œè‰²
function getWeightProgressColor(weight) {
    if (weight >= 0.15) return 'danger';
    if (weight >= 0.10) return 'warning';
    if (weight >= 0.05) return 'primary';
    return 'success';
}

// è®¡ç®—æƒé‡æ ‡å‡†å·®
function calculateWeightStd(weights) {
    const values = Object.values(weights);
    const mean = values.reduce((sum, w) => sum + w, 0) / values.length;
    const variance = values.reduce((sum, w) => sum + Math.pow(w - mean, 2), 0) / values.length;
    return Math.sqrt(variance);
}

// è®¡ç®—æœ‰æ•ˆè‚¡ç¥¨æ•°
function calculateEffectiveStocks(weights) {
    const sumSquaredWeights = Object.values(weights).reduce((sum, w) => sum + w * w, 0);
    return 1 / sumSquaredWeights;
}

// ä¿å­˜ä¼˜åŒ–åçš„æŠ•èµ„ç»„åˆ
function saveOptimizedPortfolio() {
    if (!window.currentOptimizationResult) {
        alert('æ²¡æœ‰ä¼˜åŒ–ç»“æœå¯ä¿å­˜');
        return;
    }
    
    const result = window.currentOptimizationResult;
    const name = prompt('è¯·è¾“å…¥æŠ•èµ„ç»„åˆåç§°:', `${getMethodLabel(result.method)}_${getRiskLabel(result.riskLevel)}_${new Date().toISOString().split('T')[0]}`);
    
    if (!name) return;
    
    // æ„é€ ç»„åˆæ•°æ®
    const portfolioData = {
        id: 'portfolio_' + Date.now(),
        name: name,
        description: `åŸºäº${getMethodLabel(result.method)}çš„${getRiskLabel(result.riskLevel)}æŠ•èµ„ç»„åˆ`,
        initial_capital: 1000000, // é»˜è®¤100ä¸‡
        current_value: 1000000,
        return_rate: result.stats.expected_return || 0,
        volatility: result.stats.volatility || 0,
        sharpe_ratio: result.stats.sharpe_ratio || 0,
        max_drawdown: 0,
        created_at: new Date().toISOString().split('T')[0],
        status: 'active',
        holdings: Object.entries(result.weights).map(([ts_code, weight]) => ({
            ts_code: ts_code,
            name: ts_code,
            weight: weight,
            value: 1000000 * weight
        }))
    };
    
    // æ·»åŠ åˆ°ç»„åˆåˆ—è¡¨
    portfolios.push(portfolioData);
    
    alert('æŠ•èµ„ç»„åˆä¿å­˜æˆåŠŸï¼');
    bootstrap.Modal.getInstance(document.getElementById('optimizationResultModal')).hide();
    renderPortfolios();
}

// å¯¼å‡ºä¼˜åŒ–ç»“æœ
function exportOptimizationResults() {
    if (!window.currentOptimizationResult) {
        alert('æ²¡æœ‰ä¼˜åŒ–ç»“æœå¯å¯¼å‡º');
        return;
    }
    
    const result = window.currentOptimizationResult;
    
    // åˆ›å»ºCSVå†…å®¹
    const headers = ['è‚¡ç¥¨ä»£ç ', 'æƒé‡(%)', 'æƒé‡(å°æ•°)', 'æ’å'];
    const csvContent = [
        `# æŠ•èµ„ç»„åˆä¼˜åŒ–ç»“æœ`,
        `# ä¼˜åŒ–æ–¹æ³•: ${getMethodLabel(result.method)}`,
        `# é£é™©æ°´å¹³: ${getRiskLabel(result.riskLevel)}`,
        `# é¢„æœŸæ”¶ç›Šç‡: ${formatPercent(result.stats.expected_return || 0)}`,
        `# ç»„åˆæ³¢åŠ¨ç‡: ${formatPercent(result.stats.volatility || 0)}`,
        `# å¤æ™®æ¯”ç‡: ${(result.stats.sharpe_ratio || 0).toFixed(2)}`,
        `# ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}`,
        '',
        headers.join(','),
        ...Object.entries(result.weights)
            .sort(([,a], [,b]) => b - a)
            .map(([ts_code, weight], index) => [
                ts_code,
                (weight * 100).toFixed(2),
                weight.toFixed(6),
                index + 1
            ].join(','))
    ].join('\n');
    
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `æŠ•èµ„ç»„åˆä¼˜åŒ–ç»“æœ_${result.method}_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// æŸ¥çœ‹ç»„åˆè¯¦æƒ…
function viewPortfolioDetail(portfolioId) {
    const portfolio = portfolios.find(p => p.id === portfolioId);
    if (!portfolio) return;
    
    document.getElementById('portfolioDetailTitle').textContent = portfolio.name;
    
    const detailHtml = `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">${formatAmount(portfolio.current_value)}</h4>
                        <p class="card-text">å½“å‰ä»·å€¼</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-success">${formatPercent(portfolio.return_rate)}</h4>
                        <p class="card-text">æ€»æ”¶ç›Šç‡</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-warning">${formatPercent(portfolio.volatility)}</h4>
                        <p class="card-text">æ³¢åŠ¨ç‡</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h4 class="text-info">${portfolio.sharpe_ratio.toFixed(2)}</h4>
                        <p class="card-text">å¤æ™®æ¯”ç‡</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <h6>æŒä»“æ˜ç»†</h6>
                ${portfolio.holdings.length > 0 ? `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>è‚¡ç¥¨ä»£ç </th>
                                    <th>è‚¡ç¥¨åç§°</th>
                                    <th>æƒé‡</th>
                                    <th>å¸‚å€¼</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${portfolio.holdings.map(holding => `
                                    <tr>
                                        <td><code>${holding.ts_code}</code></td>
                                        <td>${holding.name}</td>
                                        <td>${formatPercent(holding.weight)}</td>
                                        <td>${formatAmount(holding.value)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : '<p class="text-muted">æš‚æ— æŒä»“</p>'}
            </div>
        </div>
    `;
    
    document.getElementById('portfolioDetailContent').innerHTML = detailHtml;
    new bootstrap.Modal(document.getElementById('portfolioDetailModal')).show();
}

// å†å¹³è¡¡ç»„åˆ
function rebalancePortfolio(portfolioId) {
    alert('å†å¹³è¡¡åŠŸèƒ½å¾…å®ç°');
}

// ç¼–è¾‘ç»„åˆ
function editPortfolio(portfolioId) {
    alert('ç¼–è¾‘åŠŸèƒ½å¾…å®ç°');
}

// åˆ é™¤ç»„åˆ
function deletePortfolio(portfolioId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ•èµ„ç»„åˆå—ï¼Ÿ')) {
        alert('åˆ é™¤åŠŸèƒ½å¾…å®ç°');
    }
}

// æ ¼å¼åŒ–é‡‘é¢
function formatAmount(amount) {
    if (amount >= 100000000) {
        return (amount / 100000000).toFixed(2) + 'äº¿';
    } else if (amount >= 10000) {
        return (amount / 10000).toFixed(2) + 'ä¸‡';
    }
    return amount.toFixed(2);
}

// æ ¼å¼åŒ–ç™¾åˆ†æ¯”
function formatPercent(value) {
    return (value * 100).toFixed(2) + '%';
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }
}

// åˆ›å»ºæŠ•èµ„ç»„åˆ
async function createPortfolio() {
    const name = document.getElementById('portfolioName').value;
    const capital = parseFloat(document.getElementById('initialCapital').value);
    const description = document.getElementById('portfolioDescription').value;
    const strategy = document.querySelector('input[name="selectionStrategy"]:checked').value;
    
    if (!name || !capital) {
        alert('è¯·å¡«å†™å¿…å¡«å­—æ®µ');
        return;
    }
    
    try {
        const tradeDate = new Date().toISOString().split('T')[0];
        
        // æ ¹æ®é€‰æ‹©çš„ç­–ç•¥åˆ›å»ºæŠ•èµ„ç»„åˆ
        let response;
        if (strategy === 'factor_based') {
            // åŸºäºå› å­çš„ç­–ç•¥
            response = await axios.post('/api/ml-factor/portfolio/integrated-selection', {
                trade_date: tradeDate,
                selection_method: 'factor_based',
                factor_list: ['momentum_5d', 'pe_percentile', 'money_flow_strength'],
                weights: {'momentum_5d': 0.4, 'pe_percentile': 0.3, 'money_flow_strength': 0.3},
                top_n: 20,
                optimization_method: 'mean_variance',
                constraints: {
                    max_weight: 0.1,  // å•åªè‚¡ç¥¨æœ€å¤§æƒé‡10%
                    min_weight: 0.01  // å•åªè‚¡ç¥¨æœ€å°æƒé‡1%
                }
            });
        } else if (strategy === 'ml_based') {
            // åŸºäºMLæ¨¡å‹çš„ç­–ç•¥
            const modelsResponse = await axios.get('/api/ml-factor/models/list');
            if (modelsResponse.data.success && modelsResponse.data.models.length > 0) {
                const modelIds = modelsResponse.data.models.map(m => m.model_id);
                response = await axios.post('/api/ml-factor/portfolio/integrated-selection', {
                    trade_date: tradeDate,
                    selection_method: 'ml_based',
                    model_ids: modelIds,
                    top_n: 20,
                    optimization_method: 'mean_variance'
                });
            } else {
                alert('æ²¡æœ‰å¯ç”¨çš„MLæ¨¡å‹ï¼Œè¯·å…ˆåˆ›å»ºå’Œè®­ç»ƒæ¨¡å‹');
                return;
            }
        } else {
            // ç­‰æƒé‡ç­–ç•¥
            response = await axios.post('/api/ml-factor/portfolio/integrated-selection', {
                trade_date: tradeDate,
                selection_method: 'factor_based',
                factor_list: ['momentum_5d', 'pe_percentile'],
                top_n: 10,
                optimization_method: 'equal_weight'
            });
        }
        
        if (response.data.success) {
            // æ„é€ ç»„åˆæ•°æ®
            const portfolioData = {
                id: 'portfolio_' + Date.now(),
                name: name,
                description: description,
                initial_capital: capital,
                current_value: capital,
                return_rate: 0,
                volatility: response.data.portfolio_optimization?.portfolio_stats?.volatility || 0.15,
                sharpe_ratio: response.data.portfolio_optimization?.portfolio_stats?.sharpe_ratio || 1.0,
                max_drawdown: 0,
                created_at: tradeDate,
                status: 'active',
                holdings: []
            };
            
            // è½¬æ¢æŒä»“æ•°æ®
            const weights = response.data.portfolio_optimization?.weights || {};
            portfolioData.holdings = Object.entries(weights).map(([ts_code, weight]) => ({
                ts_code: ts_code,
                name: ts_code, // ç®€åŒ–æ˜¾ç¤º
                weight: weight,
                value: capital * weight
            }));
            
            // æ·»åŠ åˆ°ç»„åˆåˆ—è¡¨
            portfolios.push(portfolioData);
            
            alert('æŠ•èµ„ç»„åˆåˆ›å»ºæˆåŠŸï¼');
            bootstrap.Modal.getInstance(document.getElementById('createPortfolioModal')).hide();
            document.getElementById('createPortfolioForm').reset();
            renderPortfolios();
            
        } else {
            alert('åˆ›å»ºå¤±è´¥: ' + response.data.error);
        }
        
    } catch (error) {
        console.error('åˆ›å»ºæŠ•èµ„ç»„åˆå¤±è´¥:', error);
        alert('åˆ›å»ºæŠ•èµ„ç»„åˆå¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºç¼ºå°‘å› å­æ•°æ®ã€‚è¯·å…ˆè®¡ç®—å› å­å€¼ã€‚é”™è¯¯: ' + error.message);
    }
}

// æ˜¾ç¤ºä¼˜åŒ–è­¦å‘Š
function showOptimizationWarning(originalMethod, fallbackMethod) {
    const warningHtml = `
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>ä¼˜åŒ–æ–¹æ³•å›é€€:</strong> ${getMethodLabel(originalMethod)} ä¼˜åŒ–å¤±è´¥ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ° ${getMethodLabel(fallbackMethod)}ã€‚
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºè­¦å‘Š
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', warningHtml);
    
    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        const alert = document.querySelector('.alert-warning');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %} 