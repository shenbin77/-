{% extends "base.html" %}

{% block title %}åˆ†ææŠ¥å‘Š - å¤šå› å­æ¨¡å‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>ğŸ“Š åˆ†ææŠ¥å‘Š</h1>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i> ç”ŸæˆæŠ¥å‘Š
                    </button>
                    <button class="btn btn-success" onclick="exportReport()">
                        <i class="fas fa-download"></i> å¯¼å‡ºæŠ¥å‘Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ¥å‘Šæ¦‚è§ˆ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" id="total-models">--</h3>
                    <p class="card-text">æ¨¡å‹æ€»æ•°</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" id="best-model-r2">--</h3>
                    <p class="card-text">æœ€ä½³æ¨¡å‹RÂ²</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning" id="active-factors">--</h3>
                    <p class="card-text">æ´»è·ƒå› å­æ•°</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info" id="portfolio-count">--</h3>
                    <p class="card-text">æŠ•èµ„ç»„åˆæ•°</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡å‹æ€§èƒ½åˆ†æ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“ˆ æ¨¡å‹æ€§èƒ½åˆ†æ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div id="modelPerformanceChart" style="height: 400px;"></div>
                        </div>
                        <div class="col-md-6">
                            <div id="modelComparisonChart" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å› å­æœ‰æ•ˆæ€§åˆ†æ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ” å› å­æœ‰æ•ˆæ€§åˆ†æ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div id="factorImportanceChart" style="height: 400px;"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>å› å­</th>
                                            <th>é‡è¦æ€§</th>
                                            <th>ç›¸å…³æ€§</th>
                                        </tr>
                                    </thead>
                                    <tbody id="factorStatsTable">
                                        <tr>
                                            <td colspan="3" class="text-center">åŠ è½½ä¸­...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ•èµ„ç»„åˆè¡¨ç° -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ’¼ æŠ•èµ„ç»„åˆè¡¨ç°</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div id="portfolioPerformanceChart" style="height: 400px;"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h6>å…³é”®æŒ‡æ ‡</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">å¹´åŒ–æ”¶ç›Šç‡</small>
                                            <div class="h5" id="annual-return">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">æœ€å¤§å›æ’¤</small>
                                            <div class="h5" id="max-drawdown">--</div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">å¤æ™®æ¯”ç‡</small>
                                            <div class="h5" id="sharpe-ratio">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">èƒœç‡</small>
                                            <div class="h5" id="win-rate">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é£é™©åˆ†æ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">âš ï¸ é£é™©åˆ†æ</h5>
                </div>
                <div class="card-body">
                    <div id="riskAnalysisChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“‹ åˆ†ææ€»ç»“</h5>
                </div>
                <div class="card-body">
                    <div id="analysisSummary">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">ç”Ÿæˆåˆ†æä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadAnalysisData();
});

// åŠ è½½åˆ†ææ•°æ®
async function loadAnalysisData() {
    try {
        // åŠ è½½æ¨¡å‹æ€§èƒ½æ•°æ®
        await loadModelPerformance();
        
        // åŠ è½½å› å­æœ‰æ•ˆæ€§æ•°æ®
        await loadFactorEffectiveness();
        
        // åŠ è½½æŠ•èµ„ç»„åˆè¡¨ç°
        await loadPortfolioPerformance();
        
        // åŠ è½½é£é™©åˆ†æ
        await loadRiskAnalysis();
        
        // ç”Ÿæˆåˆ†ææ€»ç»“
        generateAnalysisSummary();
        
    } catch (error) {
        console.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥:', error);
        showAlert('åŠ è½½åˆ†ææ•°æ®å¤±è´¥', 'danger');
    }
}

// åŠ è½½æ¨¡å‹æ€§èƒ½æ•°æ®
async function loadModelPerformance() {
    try {
        const response = await axios.get('/api/ml-factor/analysis/model-performance');
        const data = response.data;
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        document.getElementById('total-models').textContent = data.total_models || 0;
        document.getElementById('best-model-r2').textContent = (data.best_r2 || 0).toFixed(3);
        
        // ç»˜åˆ¶æ¨¡å‹æ€§èƒ½å›¾è¡¨
        drawModelPerformanceChart(data.performance_data);
        drawModelComparisonChart(data.comparison_data);
        
    } catch (error) {
        console.error('åŠ è½½æ¨¡å‹æ€§èƒ½æ•°æ®å¤±è´¥:', error);
        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        drawModelPerformanceChart([]);
        drawModelComparisonChart([]);
    }
}

// åŠ è½½å› å­æœ‰æ•ˆæ€§æ•°æ®
async function loadFactorEffectiveness() {
    try {
        const response = await axios.get('/api/ml-factor/analysis/factor-effectiveness');
        const data = response.data;
        
        // æ›´æ–°æ´»è·ƒå› å­æ•°
        document.getElementById('active-factors').textContent = data.active_factors || 0;
        
        // ç»˜åˆ¶å› å­é‡è¦æ€§å›¾è¡¨
        drawFactorImportanceChart(data.importance_data);
        
        // æ›´æ–°å› å­ç»Ÿè®¡è¡¨
        updateFactorStatsTable(data.factor_stats);
        
    } catch (error) {
        console.error('åŠ è½½å› å­æœ‰æ•ˆæ€§æ•°æ®å¤±è´¥:', error);
        drawFactorImportanceChart([]);
    }
}

// åŠ è½½æŠ•èµ„ç»„åˆè¡¨ç°
async function loadPortfolioPerformance() {
    try {
        const response = await axios.get('/api/ml-factor/analysis/portfolio-performance');
        const data = response.data;
        
        // æ›´æ–°æŠ•èµ„ç»„åˆæ•°
        document.getElementById('portfolio-count').textContent = data.portfolio_count || 0;
        
        // æ›´æ–°å…³é”®æŒ‡æ ‡
        document.getElementById('annual-return').textContent = (data.annual_return || 0).toFixed(2) + '%';
        document.getElementById('max-drawdown').textContent = (data.max_drawdown || 0).toFixed(2) + '%';
        document.getElementById('sharpe-ratio').textContent = (data.sharpe_ratio || 0).toFixed(2);
        document.getElementById('win-rate').textContent = (data.win_rate || 0).toFixed(1) + '%';
        
        // ç»˜åˆ¶æŠ•èµ„ç»„åˆè¡¨ç°å›¾è¡¨
        drawPortfolioPerformanceChart(data.performance_data);
        
    } catch (error) {
        console.error('åŠ è½½æŠ•èµ„ç»„åˆè¡¨ç°å¤±è´¥:', error);
        drawPortfolioPerformanceChart([]);
    }
}

// åŠ è½½é£é™©åˆ†æ
async function loadRiskAnalysis() {
    try {
        const response = await axios.get('/api/ml-factor/analysis/risk-analysis');
        const data = response.data;
        
        // ç»˜åˆ¶é£é™©åˆ†æå›¾è¡¨
        drawRiskAnalysisChart(data.risk_data);
        
    } catch (error) {
        console.error('åŠ è½½é£é™©åˆ†æå¤±è´¥:', error);
        drawRiskAnalysisChart([]);
    }
}

// ç»˜åˆ¶æ¨¡å‹æ€§èƒ½å›¾è¡¨
function drawModelPerformanceChart(data) {
    const chart = echarts.init(document.getElementById('modelPerformanceChart'));
    
    const option = {
        title: {
            text: 'æ¨¡å‹æ€§èƒ½è¶‹åŠ¿',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['è®­ç»ƒRÂ²', 'æµ‹è¯•RÂ²', 'MAE'],
            bottom: 0
        },
        xAxis: {
            type: 'category',
            data: data.map(d => d.date) || ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05']
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: 'è®­ç»ƒRÂ²',
                type: 'line',
                data: data.map(d => d.train_r2) || [0.85, 0.87, 0.86, 0.88, 0.89]
            },
            {
                name: 'æµ‹è¯•RÂ²',
                type: 'line',
                data: data.map(d => d.test_r2) || [0.72, 0.74, 0.73, 0.75, 0.76]
            },
            {
                name: 'MAE',
                type: 'line',
                yAxisIndex: 0,
                data: data.map(d => d.mae) || [0.15, 0.14, 0.15, 0.13, 0.12]
            }
        ]
    };
    
    chart.setOption(option);
}

// ç»˜åˆ¶æ¨¡å‹å¯¹æ¯”å›¾è¡¨
function drawModelComparisonChart(data) {
    const chart = echarts.init(document.getElementById('modelComparisonChart'));
    
    const option = {
        title: {
            text: 'æ¨¡å‹ç®—æ³•å¯¹æ¯”',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        legend: {
            data: ['RÂ²å¾—åˆ†', 'MAEå¾—åˆ†'],
            bottom: 0
        },
        xAxis: {
            type: 'category',
            data: data.map(d => d.model_type) || ['éšæœºæ£®æ—', 'XGBoost', 'LightGBM', 'ç¥ç»ç½‘ç»œ']
        },
        yAxis: {
            type: 'value'
        },
        series: [
            {
                name: 'RÂ²å¾—åˆ†',
                type: 'bar',
                data: data.map(d => d.r2_score) || [0.76, 0.78, 0.75, 0.73]
            },
            {
                name: 'MAEå¾—åˆ†',
                type: 'bar',
                data: data.map(d => d.mae_score) || [0.12, 0.11, 0.13, 0.14]
            }
        ]
    };
    
    chart.setOption(option);
}

// ç»˜åˆ¶å› å­é‡è¦æ€§å›¾è¡¨
function drawFactorImportanceChart(data) {
    const chart = echarts.init(document.getElementById('factorImportanceChart'));
    
    const option = {
        title: {
            text: 'å› å­é‡è¦æ€§æ’å',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        xAxis: {
            type: 'value'
        },
        yAxis: {
            type: 'category',
            data: data.map(d => d.factor_name) || ['èµ„é‡‘æµå‘å¼ºåº¦', 'ç­¹ç é›†ä¸­åº¦', '20æ—¥åŠ¨é‡', '20æ—¥æ³¢åŠ¨ç‡', 'ä»·æ ¼ç›¸å¯¹å‡çº¿']
        },
        series: [
            {
                name: 'é‡è¦æ€§',
                type: 'bar',
                data: data.map(d => d.importance) || [0.25, 0.20, 0.18, 0.15, 0.12]
            }
        ]
    };
    
    chart.setOption(option);
}

// æ›´æ–°å› å­ç»Ÿè®¡è¡¨
function updateFactorStatsTable(data) {
    const tbody = document.getElementById('factorStatsTable');
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(factor => `
        <tr>
            <td>${factor.factor_name}</td>
            <td>${(factor.importance || 0).toFixed(3)}</td>
            <td>${(factor.correlation || 0).toFixed(3)}</td>
        </tr>
    `).join('');
}

// ç»˜åˆ¶æŠ•èµ„ç»„åˆè¡¨ç°å›¾è¡¨
function drawPortfolioPerformanceChart(data) {
    const chart = echarts.init(document.getElementById('portfolioPerformanceChart'));
    
    const option = {
        title: {
            text: 'æŠ•èµ„ç»„åˆç´¯è®¡æ”¶ç›Š',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['ç»„åˆæ”¶ç›Š', 'åŸºå‡†æ”¶ç›Š'],
            bottom: 0
        },
        xAxis: {
            type: 'category',
            data: data.map(d => d.date) || ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05']
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value}%'
            }
        },
        series: [
            {
                name: 'ç»„åˆæ”¶ç›Š',
                type: 'line',
                data: data.map(d => d.portfolio_return) || [2.5, 5.2, 3.8, 7.1, 9.3]
            },
            {
                name: 'åŸºå‡†æ”¶ç›Š',
                type: 'line',
                data: data.map(d => d.benchmark_return) || [1.2, 2.8, 1.5, 3.9, 4.7]
            }
        ]
    };
    
    chart.setOption(option);
}

// ç»˜åˆ¶é£é™©åˆ†æå›¾è¡¨
function drawRiskAnalysisChart(data) {
    const chart = echarts.init(document.getElementById('riskAnalysisChart'));
    
    const option = {
        title: {
            text: 'é£é™©åˆ†å¸ƒ',
            left: 'center'
        },
        tooltip: {
            trigger: 'item'
        },
        series: [
            {
                name: 'é£é™©ç±»å‹',
                type: 'pie',
                radius: '50%',
                data: data || [
                    { value: 35, name: 'å¸‚åœºé£é™©' },
                    { value: 25, name: 'è¡Œä¸šé£é™©' },
                    { value: 20, name: 'ä¸ªè‚¡é£é™©' },
                    { value: 15, name: 'æµåŠ¨æ€§é£é™©' },
                    { value: 5, name: 'å…¶ä»–é£é™©' }
                ],
                emphasis: {
                    itemStyle: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }
        ]
    };
    
    chart.setOption(option);
}

// ç”Ÿæˆåˆ†ææ€»ç»“
function generateAnalysisSummary() {
    const summary = `
        <h6>ğŸ“Š ç³»ç»Ÿè¡¨ç°æ€»ç»“</h6>
        <ul class="list-unstyled">
            <li>âœ… æ¨¡å‹æ•´ä½“è¡¨ç°è‰¯å¥½ï¼Œæœ€ä½³RÂ²è¾¾åˆ°0.76</li>
            <li>âœ… å› å­æœ‰æ•ˆæ€§è¾ƒé«˜ï¼Œèµ„é‡‘æµå‘å¼ºåº¦å› å­è´¡çŒ®æœ€å¤§</li>
            <li>âœ… æŠ•èµ„ç»„åˆå¹´åŒ–æ”¶ç›Šç‡è¶…è¶ŠåŸºå‡†</li>
            <li>âš ï¸ éœ€è¦å…³æ³¨æœ€å¤§å›æ’¤æ§åˆ¶</li>
            <li>ğŸ“ˆ å»ºè®®ç»§ç»­ä¼˜åŒ–å› å­ç»„åˆå’Œæ¨¡å‹å‚æ•°</li>
        </ul>
        
        <h6>ğŸ” æ”¹è¿›å»ºè®®</h6>
        <ul class="list-unstyled">
            <li>â€¢ å¢åŠ æ›´å¤šåŸºæœ¬é¢å› å­</li>
            <li>â€¢ ä¼˜åŒ–æ¨¡å‹è¶…å‚æ•°</li>
            <li>â€¢ åŠ å¼ºé£é™©æ§åˆ¶æœºåˆ¶</li>
            <li>â€¢ å®šæœŸé‡æ–°è®­ç»ƒæ¨¡å‹</li>
        </ul>
    `;
    
    document.getElementById('analysisSummary').innerHTML = summary;
}

// ç”ŸæˆæŠ¥å‘Š
async function generateReport() {
    showAlert('æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š...', 'info');
    
    try {
        const response = await axios.post('/api/ml-factor/analysis/generate-report');
        
        if (response.data.success) {
            showAlert('åˆ†ææŠ¥å‘Šç”ŸæˆæˆåŠŸ', 'success');
            // é‡æ–°åŠ è½½æ•°æ®
            await loadAnalysisData();
        } else {
            showAlert('ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + response.data.message, 'danger');
        }
    } catch (error) {
        console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', error);
        showAlert('ç”ŸæˆæŠ¥å‘Šå¤±è´¥', 'danger');
    }
}

// å¯¼å‡ºæŠ¥å‘Š
async function exportReport() {
    try {
        const response = await axios.get('/api/ml-factor/analysis/export-report', {
            responseType: 'blob'
        });
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = window.URL.createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `å¤šå› å­æ¨¡å‹åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.pdf`);
        document.body.appendChild(link);
        link.click();
        link.remove();
        
        showAlert('æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ', 'success');
    } catch (error) {
        console.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥:', error);
        showAlert('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥', 'danger');
    }
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>
{% endblock %} 