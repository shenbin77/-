{% extends "base.html" %}

{% block title %}хЫахнРчобчРЖ - хдЪхЫахнРцибхЮЛч│╗ч╗Я{% endblock %}

{% block content %}
<div class="container">
    <!-- щб╡щЭвцаЗщвШ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>ЁЯза хЫахнРчобчРЖ</h1>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="calculateAllFactors()">
                        <i class="fas fa-calculator"></i> шобчоЧхЫахнР
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createFactorModal">
                        <i class="fas fa-plus"></i> хИЫх╗║шЗкхоЪф╣ЙхЫахнР
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- хЫахнРч╗Яшоб -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" id="total-factors">--</h3>
                    <p class="card-text">цА╗хЫахнРцХ░</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" id="builtin-factors">--</h3>
                    <p class="card-text">хЖЕч╜охЫахнР</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning" id="custom-factors">--</h3>
                    <p class="card-text">шЗкхоЪф╣ЙхЫахнР</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info" id="active-factors">--</h3>
                    <p class="card-text">ц┤╗ш╖ГхЫахнР</p>
                </div>
            </div>
        </div>
    </div>

    <!-- хЫахнРчнЫщАЙ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="factorTypeFilter" class="form-label">хЫахнРч▒╗хЮЛ</label>
                            <select class="form-select" id="factorTypeFilter">
                                <option value="">хЕищГич▒╗хЮЛ</option>
                                <option value="technical">цКАцЬпщЭв</option>
                                <option value="fundamental">хЯ║цЬмщЭв</option>
                                <option value="money_flow">ш╡ДщЗСщЭв</option>
                                <option value="chip">чн╣чаБщЭв</option>
                                <option value="other">хЕ╢ф╗Ц</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="factorSourceFilter" class="form-label">хЫахнРцЭец║Р</label>
                            <select class="form-select" id="factorSourceFilter">
                                <option value="">хЕищГицЭец║Р</option>
                                <option value="builtin">хЖЕч╜охЫахнР</option>
                                <option value="custom">шЗкхоЪф╣ЙхЫахнР</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="factorStatusFilter" class="form-label">чК╢цАБ</label>
                            <select class="form-select" id="factorStatusFilter">
                                <option value="">хЕищГичК╢цАБ</option>
                                <option value="active">ц┤╗ш╖Г</option>
                                <option value="inactive">щЭЮц┤╗ш╖Г</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">цРЬч┤в</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="цРЬч┤вхЫахнРхРНчз░цИЦID">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- хЫахнРхИЧшби -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">хЫахнРхИЧшби</h5>
                </div>
                <div class="card-body">
                    <div id="factorsList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">хКаш╜╜ф╕н...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- хИЫх╗║хЫахнРцибцАБцбЖ -->
<div class="modal fade" id="createFactorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">хИЫх╗║шЗкхоЪф╣ЙхЫахнР</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createFactorForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factorId" class="form-label">хЫахнРID *</label>
                                <input type="text" class="form-control" id="factorId" required>
                                <div class="form-text">хФпф╕АцаЗшпЖчмжя╝МхПкшГ╜хМЕхРлхнЧцпНуАБцХ░хнЧхТМф╕ЛхИТч║┐</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factorName" class="form-label">хЫахнРхРНчз░ *</label>
                                <input type="text" class="form-control" id="factorName" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factorType" class="form-label">хЫахнРч▒╗хЮЛ *</label>
                                <select class="form-select" id="factorType" required>
                                    <option value="">шп╖щАЙцЛйч▒╗хЮЛ</option>
                                    <option value="technical">цКАцЬпщЭв</option>
                                    <option value="fundamental">хЯ║цЬмщЭв</option>
                                    <option value="money_flow">ш╡ДщЗСщЭв</option>
                                    <option value="chip">чн╣чаБщЭв</option>
                                    <option value="other">хЕ╢ф╗Ц</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factorFormula" class="form-label">хЫахнРхЕмх╝П *</label>
                                <input type="text" class="form-control" id="factorFormula" required>
                                <div class="form-text">ф╛ЛхжВ: (close - ma20) / ma20</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="factorDescription" class="form-label">цППш┐░</label>
                        <textarea class="form-control" id="factorDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">хПЦц╢И</button>
                <button type="button" class="btn btn-primary" onclick="createFactor()">хИЫх╗║хЫахнР</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allFactors = [];
let filteredFactors = [];

// щб╡щЭвхКаш╜╜хоМцИРхРОхИЭхзЛхМЦ
document.addEventListener('DOMContentLoaded', function() {
    loadFactors();
    
    // ч╗СхоЪчнЫщАЙф║Лф╗╢
    document.getElementById('factorTypeFilter').addEventListener('change', filterFactors);
    document.getElementById('factorSourceFilter').addEventListener('change', filterFactors);
    document.getElementById('factorStatusFilter').addEventListener('change', filterFactors);
    document.getElementById('searchInput').addEventListener('input', filterFactors);
});

// хКаш╜╜хЫахнРхИЧшби
async function loadFactors() {
    try {
        const response = await axios.get('/api/ml-factor/factors/list');
        if (response.data.success) {
            // хдДчРЖчЬЯхоЮцХ░цНоя╝Мц╖╗хКаis_builtinхнЧцо╡
            allFactors = response.data.factors.map(factor => ({
                ...factor,
                is_builtin: true, // чЫохЙНщГ╜цШпхЖЕч╜охЫахнР
                is_active: factor.is_active !== false
            }));
            filteredFactors = [...allFactors];
            updateStatistics();
            renderFactors();
        } else {
            showError('factorsList', 'хКаш╜╜хЫахнРхИЧшбихд▒ш┤е');
        }
    } catch (error) {
        console.error('хКаш╜╜хЫахнРхИЧшбихд▒ш┤е:', error);
        // хжВцЮЬAPIхд▒ш┤ея╝МцШ╛чд║щФЩшппф┐бцБп
        showError('factorsList', 'хКаш╜╜хЫахнРхИЧшбихд▒ш┤ея╝Мшп╖цгАцЯецЬНхКбхЩиш┐ЮцОе: ' + error.message);
    }
}

// цЫ┤цЦ░ч╗Яшобф┐бцБп
function updateStatistics() {
    const totalFactors = allFactors.length;
    const builtinFactors = allFactors.filter(f => f.is_builtin).length;
    const customFactors = allFactors.filter(f => !f.is_builtin).length;
    const activeFactors = allFactors.filter(f => f.is_active).length;
    
    document.getElementById('total-factors').textContent = totalFactors;
    document.getElementById('builtin-factors').textContent = builtinFactors;
    document.getElementById('custom-factors').textContent = customFactors;
    document.getElementById('active-factors').textContent = activeFactors;
}

// чнЫщАЙхЫахнР
function filterFactors() {
    const typeFilter = document.getElementById('factorTypeFilter').value;
    const sourceFilter = document.getElementById('factorSourceFilter').value;
    const statusFilter = document.getElementById('factorStatusFilter').value;
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    
    filteredFactors = allFactors.filter(factor => {
        // ч▒╗хЮЛчнЫщАЙ
        if (typeFilter && factor.factor_type !== typeFilter) return false;
        
        // цЭец║РчнЫщАЙ
        if (sourceFilter === 'builtin' && !factor.is_builtin) return false;
        if (sourceFilter === 'custom' && factor.is_builtin) return false;
        
        // чК╢цАБчнЫщАЙ
        if (statusFilter === 'active' && !factor.is_active) return false;
        if (statusFilter === 'inactive' && factor.is_active) return false;
        
        // цРЬч┤вчнЫщАЙ
        if (searchText && 
            !factor.factor_id.toLowerCase().includes(searchText) &&
            !factor.factor_name.toLowerCase().includes(searchText)) return false;
        
        return true;
    });
    
    renderFactors();
}

// ц╕▓цЯУхЫахнРхИЧшби
function renderFactors() {
    const container = document.getElementById('factorsList');
    
    if (filteredFactors.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">ц▓бцЬЙцЙ╛хИ░хМ╣щЕНчЪДхЫахнР</div>';
        return;
    }
    
    const html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>хЫахнРID</th>
                        <th>хЫахнРхРНчз░</th>
                        <th>ч▒╗хЮЛ</th>
                        <th>цЭец║Р</th>
                        <th>чК╢цАБ</th>
                        <th>цППш┐░</th>
                        <th>цУНф╜Ь</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredFactors.map(factor => `
                        <tr>
                            <td><code>${factor.factor_id}</code></td>
                            <td>${factor.factor_name}</td>
                            <td>
                                <span class="badge bg-${getTypeColor(factor.factor_type)}">
                                    ${getTypeLabel(factor.factor_type)}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-${factor.is_builtin ? 'primary' : 'secondary'}">
                                    ${factor.is_builtin ? 'хЖЕч╜о' : 'шЗкхоЪф╣Й'}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-${factor.is_active ? 'success' : 'danger'}">
                                    ${factor.is_active ? 'ц┤╗ш╖Г' : 'щЭЮц┤╗ш╖Г'}
                                </span>
                            </td>
                            <td>${factor.description || '--'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewFactor('${factor.factor_id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${!factor.is_builtin ? `
                                    <button class="btn btn-sm btn-outline-warning" onclick="editFactor('${factor.factor_id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFactor('${factor.factor_id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// шО╖хПЦч▒╗хЮЛщвЬшЙ▓
function getTypeColor(type) {
    const colors = {
        'technical': 'primary',
        'fundamental': 'success',
        'money_flow': 'warning',
        'chip': 'info',
        'other': 'secondary'
    };
    return colors[type] || 'secondary';
}

// шО╖хПЦч▒╗хЮЛцаЗчн╛
function getTypeLabel(type) {
    const labels = {
        'technical': 'цКАцЬпщЭв',
        'fundamental': 'хЯ║цЬмщЭв',
        'money_flow': 'ш╡ДщЗСщЭв',
        'chip': 'чн╣чаБщЭв',
        'other': 'хЕ╢ф╗Ц'
    };
    return labels[type] || type;
}

// хИЫх╗║хЫахнР
async function createFactor() {
    const form = document.getElementById('createFactorForm');
    const formData = new FormData(form);
    
    const factorData = {
        factor_id: document.getElementById('factorId').value,
        factor_name: document.getElementById('factorName').value,
        factor_type: document.getElementById('factorType').value,
        factor_formula: document.getElementById('factorFormula').value,
        description: document.getElementById('factorDescription').value
    };
    
    // щкМшпБх┐ЕхблхнЧцо╡
    if (!factorData.factor_id || !factorData.factor_name || !factorData.factor_type || !factorData.factor_formula) {
        alert('шп╖хблхЖЩцЙАцЬЙх┐ЕхблхнЧцо╡');
        return;
    }
    
    try {
        const response = await axios.post('/api/ml-factor/factors/custom', factorData);
        if (response.data.success) {
            alert('хЫахнРхИЫх╗║цИРхКЯ');
            bootstrap.Modal.getInstance(document.getElementById('createFactorModal')).hide();
            form.reset();
            loadFactors(); // щЗНцЦ░хКаш╜╜хЫахнРхИЧшби
        } else {
            alert('хИЫх╗║хд▒ш┤е: ' + response.data.error);
        }
    } catch (error) {
        console.error('хИЫх╗║хЫахнРхд▒ш┤е:', error);
        alert('хИЫх╗║хд▒ш┤е: ' + error.message);
    }
}

// цЯечЬЛхЫахнРшпжцГЕ
function viewFactor(factorId) {
    const factor = allFactors.find(f => f.factor_id === factorId);
    if (factor) {
        alert(`хЫахнРшпжцГЕ:\n\nID: ${factor.factor_id}\nхРНчз░: ${factor.factor_name}\nч▒╗хЮЛ: ${getTypeLabel(factor.factor_type)}\nцППш┐░: ${factor.description || 'цЧа'}\n${factor.formula ? 'хЕмх╝П: ' + factor.formula : ''}`);
    }
}

// ч╝Цш╛СхЫахнР
function editFactor(factorId) {
    alert('ч╝Цш╛СхКЯшГ╜х╛ЕхоЮчО░');
}

// хИащЩдхЫахнР
function deleteFactor(factorId) {
    if (confirm('чбохоЪшжБхИащЩдш┐Щф╕кхЫахнРхРЧя╝Я')) {
        alert('хИащЩдхКЯшГ╜х╛ЕхоЮчО░');
    }
}

// шобчоЧцЙАцЬЙхЫахнР
async function calculateAllFactors() {
    if (!confirm('чбохоЪшжБшобчоЧцЙАцЬЙхЫахнРхРЧя╝Яш┐ЩхПпшГ╜щЬАшжБф╕Аф║ЫцЧ╢щЧ┤уАВ')) {
        return;
    }
    
    try {
        // шО╖хПЦцЬАцЦ░ф║дцШУцЧецЬЯ
        const today = new Date().toISOString().split('T')[0];
        
        const response = await axios.post('/api/ml-factor/factors/calculate', {
            trade_date: today,
            factor_ids: [], // чй║цХ░ч╗Дшбичд║шобчоЧцЙАцЬЙхЫахнР
            ts_codes: [] // чй║цХ░ч╗Дшбичд║шобчоЧцЙАцЬЙшВбчеи
        });
        
        if (response.data.success) {
            alert(`хЫахнРшобчоЧхоМцИРя╝Б\nф║дцШУцЧецЬЯ: ${response.data.trade_date}\nшобчоЧч╗УцЮЬ: ${JSON.stringify(response.data.results, null, 2)}`);
        } else {
            alert('хЫахнРшобчоЧхд▒ш┤е: ' + response.data.error);
        }
    } catch (error) {
        console.error('шобчоЧхЫахнРхд▒ш┤е:', error);
        alert('шобчоЧхЫахнРхд▒ш┤е: ' + error.message);
    }
}

// цШ╛чд║щФЩшппф┐бцБп
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }
}
</script>
{% endblock %} 