{% extends "base.html" %}

{% block title %}å› å­ç®¡ç† - å¤šå› å­æ¨¡å‹ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>ğŸ§  å› å­ç®¡ç†</h1>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="calculateAllFactors()">
                        <i class="fas fa-calculator"></i> è®¡ç®—å› å­
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createFactorModal">
                        <i class="fas fa-plus"></i> åˆ›å»ºè‡ªå®šä¹‰å› å­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å› å­ç»Ÿè®¡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" id="total-factors">--</h3>
                    <p class="card-text">æ€»å› å­æ•°</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" id="builtin-factors">--</h3>
                    <p class="card-text">å†…ç½®å› å­</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning" id="custom-factors">--</h3>
                    <p class="card-text">è‡ªå®šä¹‰å› å­</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info" id="active-factors">--</h3>
                    <p class="card-text">æ´»è·ƒå› å­</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å› å­ç­›é€‰ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="factorTypeFilter" class="form-label">å› å­ç±»å‹</label>
                            <select class="form-select" id="factorTypeFilter">
                                <option value="">å…¨éƒ¨ç±»å‹</option>
                                <option value="technical">æŠ€æœ¯é¢</option>
                                <option value="fundamental">åŸºæœ¬é¢</option>
                                <option value="money_flow">èµ„é‡‘é¢</option>
                                <option value="chip">ç­¹ç é¢</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="factorSourceFilter" class="form-label">å› å­æ¥æº</label>
                            <select class="form-select" id="factorSourceFilter">
                                <option value="">å…¨éƒ¨æ¥æº</option>
                                <option value="builtin">å†…ç½®å› å­</option>
                                <option value="custom">è‡ªå®šä¹‰å› å­</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="factorStatusFilter" class="form-label">çŠ¶æ€</label>
                            <select class="form-select" id="factorStatusFilter">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="active">æ´»è·ƒ</option>
                                <option value="inactive">éæ´»è·ƒ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">æœç´¢</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢å› å­åç§°æˆ–ID">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å› å­åˆ—è¡¨ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">å› å­åˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    <div id="factorsList">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºå› å­æ¨¡æ€æ¡† -->
<div class="modal fade" id="createFactorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åˆ›å»ºè‡ªå®šä¹‰å› å­</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createFactorForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factorId" class="form-label">å› å­ID *</label>
                                <input type="text" class="form-control" id="factorId" required>
                                <div class="form-text">å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factorName" class="form-label">å› å­åç§° *</label>
                                <input type="text" class="form-control" id="factorName" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factorType" class="form-label">å› å­ç±»å‹ *</label>
                                <select class="form-select" id="factorType" required>
                                    <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                                    <option value="technical">æŠ€æœ¯é¢</option>
                                    <option value="fundamental">åŸºæœ¬é¢</option>
                                    <option value="money_flow">èµ„é‡‘é¢</option>
                                    <option value="chip">ç­¹ç é¢</option>
                                    <option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="factorFormula" class="form-label">å› å­å…¬å¼ *</label>
                                <input type="text" class="form-control" id="factorFormula" required>
                                <div class="form-text">ä¾‹å¦‚: (close - ma20) / ma20</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="factorDescription" class="form-label">æè¿°</label>
                        <textarea class="form-control" id="factorDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="createFactor()">åˆ›å»ºå› å­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allFactors = [];
let filteredFactors = [];

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadFactors();
    
    // ç»‘å®šç­›é€‰äº‹ä»¶
    document.getElementById('factorTypeFilter').addEventListener('change', filterFactors);
    document.getElementById('factorSourceFilter').addEventListener('change', filterFactors);
    document.getElementById('factorStatusFilter').addEventListener('change', filterFactors);
    document.getElementById('searchInput').addEventListener('input', filterFactors);
});

// åŠ è½½å› å­åˆ—è¡¨
async function loadFactors() {
    try {
        const response = await axios.get('/api/ml-factor/factors/list');
        if (response.data.success) {
            // å¤„ç†çœŸå®æ•°æ®ï¼Œæ·»åŠ is_builtinå­—æ®µ
            allFactors = response.data.factors.map(factor => ({
                ...factor,
                is_builtin: true, // ç›®å‰éƒ½æ˜¯å†…ç½®å› å­
                is_active: factor.is_active !== false
            }));
            filteredFactors = [...allFactors];
            updateStatistics();
            renderFactors();
        } else {
            showError('factorsList', 'åŠ è½½å› å­åˆ—è¡¨å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½å› å­åˆ—è¡¨å¤±è´¥:', error);
        // å¦‚æœAPIå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        showError('factorsList', 'åŠ è½½å› å­åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥: ' + error.message);
    }
}

// æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
function updateStatistics() {
    const totalFactors = allFactors.length;
    const builtinFactors = allFactors.filter(f => f.is_builtin).length;
    const customFactors = allFactors.filter(f => !f.is_builtin).length;
    const activeFactors = allFactors.filter(f => f.is_active).length;
    
    document.getElementById('total-factors').textContent = totalFactors;
    document.getElementById('builtin-factors').textContent = builtinFactors;
    document.getElementById('custom-factors').textContent = customFactors;
    document.getElementById('active-factors').textContent = activeFactors;
}

// ç­›é€‰å› å­
function filterFactors() {
    const typeFilter = document.getElementById('factorTypeFilter').value;
    const sourceFilter = document.getElementById('factorSourceFilter').value;
    const statusFilter = document.getElementById('factorStatusFilter').value;
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    
    filteredFactors = allFactors.filter(factor => {
        // ç±»å‹ç­›é€‰
        if (typeFilter && factor.factor_type !== typeFilter) return false;
        
        // æ¥æºç­›é€‰
        if (sourceFilter === 'builtin' && !factor.is_builtin) return false;
        if (sourceFilter === 'custom' && factor.is_builtin) return false;
        
        // çŠ¶æ€ç­›é€‰
        if (statusFilter === 'active' && !factor.is_active) return false;
        if (statusFilter === 'inactive' && factor.is_active) return false;
        
        // æœç´¢ç­›é€‰
        if (searchText && 
            !factor.factor_id.toLowerCase().includes(searchText) &&
            !factor.factor_name.toLowerCase().includes(searchText)) return false;
        
        return true;
    });
    
    renderFactors();
}

// æ¸²æŸ“å› å­åˆ—è¡¨
function renderFactors() {
    const container = document.getElementById('factorsList');
    
    if (filteredFactors.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å› å­</div>';
        return;
    }
    
    const html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>å› å­ID</th>
                        <th>å› å­åç§°</th>
                        <th>ç±»å‹</th>
                        <th>æ¥æº</th>
                        <th>çŠ¶æ€</th>
                        <th>æè¿°</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredFactors.map(factor => `
                        <tr>
                            <td><code>${factor.factor_id}</code></td>
                            <td>${factor.factor_name}</td>
                            <td>
                                <span class="badge bg-${getTypeColor(factor.factor_type)}">
                                    ${getTypeLabel(factor.factor_type)}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-${factor.is_builtin ? 'primary' : 'secondary'}">
                                    ${factor.is_builtin ? 'å†…ç½®' : 'è‡ªå®šä¹‰'}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-${factor.is_active ? 'success' : 'danger'}">
                                    ${factor.is_active ? 'æ´»è·ƒ' : 'éæ´»è·ƒ'}
                                </span>
                            </td>
                            <td>${factor.description || '--'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewFactor('${factor.factor_id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${!factor.is_builtin ? `
                                    <button class="btn btn-sm btn-outline-warning" onclick="editFactor('${factor.factor_id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFactor('${factor.factor_id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// è·å–ç±»å‹é¢œè‰²
function getTypeColor(type) {
    const colors = {
        'technical': 'primary',
        'fundamental': 'success',
        'money_flow': 'warning',
        'chip': 'info',
        'other': 'secondary'
    };
    return colors[type] || 'secondary';
}

// è·å–ç±»å‹æ ‡ç­¾
function getTypeLabel(type) {
    const labels = {
        'technical': 'æŠ€æœ¯é¢',
        'fundamental': 'åŸºæœ¬é¢',
        'money_flow': 'èµ„é‡‘é¢',
        'chip': 'ç­¹ç é¢',
        'other': 'å…¶ä»–'
    };
    return labels[type] || type;
}

// åˆ›å»ºå› å­
async function createFactor() {
    const form = document.getElementById('createFactorForm');
    const formData = new FormData(form);
    
    const factorData = {
        factor_id: document.getElementById('factorId').value,
        factor_name: document.getElementById('factorName').value,
        factor_type: document.getElementById('factorType').value,
        factor_formula: document.getElementById('factorFormula').value,
        description: document.getElementById('factorDescription').value
    };
    
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!factorData.factor_id || !factorData.factor_name || !factorData.factor_type || !factorData.factor_formula) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
        return;
    }
    
    try {
        const response = await axios.post('/api/ml-factor/factors/custom', factorData);
        if (response.data.success) {
            alert('å› å­åˆ›å»ºæˆåŠŸ');
            bootstrap.Modal.getInstance(document.getElementById('createFactorModal')).hide();
            form.reset();
            loadFactors(); // é‡æ–°åŠ è½½å› å­åˆ—è¡¨
        } else {
            alert('åˆ›å»ºå¤±è´¥: ' + response.data.error);
        }
    } catch (error) {
        console.error('åˆ›å»ºå› å­å¤±è´¥:', error);
        alert('åˆ›å»ºå¤±è´¥: ' + error.message);
    }
}

// æŸ¥çœ‹å› å­è¯¦æƒ…
function viewFactor(factorId) {
    const factor = allFactors.find(f => f.factor_id === factorId);
    if (factor) {
        alert(`å› å­è¯¦æƒ…:\n\nID: ${factor.factor_id}\nåç§°: ${factor.factor_name}\nç±»å‹: ${getTypeLabel(factor.factor_type)}\næè¿°: ${factor.description || 'æ— '}\n${factor.formula ? 'å…¬å¼: ' + factor.formula : ''}`);
    }
}

// ç¼–è¾‘å› å­
function editFactor(factorId) {
    alert('ç¼–è¾‘åŠŸèƒ½å¾…å®ç°');
}

// åˆ é™¤å› å­
function deleteFactor(factorId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå› å­å—ï¼Ÿ')) {
        alert('åˆ é™¤åŠŸèƒ½å¾…å®ç°');
    }
}

// è®¡ç®—æ‰€æœ‰å› å­
async function calculateAllFactors() {
    if (!confirm('ç¡®å®šè¦è®¡ç®—æ‰€æœ‰å› å­å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
        return;
    }
    
    try {
        // è·å–æœ€æ–°äº¤æ˜“æ—¥æœŸ
        const today = new Date().toISOString().split('T')[0];
        
        const response = await axios.post('/api/ml-factor/factors/calculate', {
            trade_date: today,
            factor_ids: [], // ç©ºæ•°ç»„è¡¨ç¤ºè®¡ç®—æ‰€æœ‰å› å­
            ts_codes: [] // ç©ºæ•°ç»„è¡¨ç¤ºè®¡ç®—æ‰€æœ‰è‚¡ç¥¨
        });
        
        if (response.data.success) {
            alert(`å› å­è®¡ç®—å®Œæˆï¼\näº¤æ˜“æ—¥æœŸ: ${response.data.trade_date}\nè®¡ç®—ç»“æœ: ${JSON.stringify(response.data.results, null, 2)}`);
        } else {
            alert('å› å­è®¡ç®—å¤±è´¥: ' + response.data.error);
        }
    } catch (error) {
        console.error('è®¡ç®—å› å­å¤±è´¥:', error);
        alert('è®¡ç®—å› å­å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    }
}
</script>
{% endblock %} 