{% extends "base.html" %}

{% block title %}ç­–ç•¥å›æµ‹ - è‚¡ç¥¨åˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">ğŸ“Š ç­–ç•¥å›æµ‹</h1>
            <p class="text-muted">åŸºäºå†å²æ•°æ®éªŒè¯æŠ•èµ„ç­–ç•¥çš„è¡¨ç°</p>
        </div>
    </div>

    <!-- ç­–ç•¥é…ç½® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">å›æµ‹é…ç½®</h5>
                </div>
                <div class="card-body">
                    <form id="backtest-form">
                        <div class="row g-3">
                            <!-- è‚¡ç¥¨é€‰æ‹© -->
                            <div class="col-md-6">
                                <label for="stock-select" class="form-label">é€‰æ‹©è‚¡ç¥¨ <span class="text-danger">*</span></label>
                                <select class="form-select" id="stock-select" required>
                                    <option value="">è¯·é€‰æ‹©è¦å›æµ‹çš„è‚¡ç¥¨</option>
                                </select>
                            </div>
                            
                            <!-- ç­–ç•¥ç±»å‹ -->
                            <div class="col-md-6">
                                <label for="strategy-type" class="form-label">ç­–ç•¥ç±»å‹ <span class="text-danger">*</span></label>
                                <select class="form-select" id="strategy-type" required>
                                    <option value="">é€‰æ‹©ç­–ç•¥ç±»å‹</option>
                                    <option value="ma_cross">å‡çº¿äº¤å‰ç­–ç•¥</option>
                                    <option value="macd">MACDç­–ç•¥</option>
                                    <option value="kdj">KDJç­–ç•¥</option>
                                    <option value="rsi">RSIç­–ç•¥</option>
                                    <option value="bollinger">å¸ƒæ—å¸¦ç­–ç•¥</option>
                                </select>
                            </div>

                            <!-- æ—¶é—´èŒƒå›´ -->
                            <div class="col-md-6">
                                <label for="start-date" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="start-date" required>
                            </div>
                            <div class="col-md-6">
                                <label for="end-date" class="form-label">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" class="form-control" id="end-date" required>
                            </div>

                            <!-- èµ„é‡‘é…ç½® -->
                            <div class="col-md-6">
                                <label for="initial-capital" class="form-label">åˆå§‹èµ„é‡‘(å…ƒ)</label>
                                <input type="number" class="form-control" id="initial-capital" value="100000" min="10000" step="1000">
                            </div>
                            <div class="col-md-6">
                                <label for="commission-rate" class="form-label">æ‰‹ç»­è´¹ç‡(%)</label>
                                <input type="number" class="form-control" id="commission-rate" value="0.1" step="0.01" min="0" max="1">
                            </div>

                            <!-- ç­–ç•¥å‚æ•° -->
                            <div class="col-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">ç­–ç•¥å‚æ•°</h6>
                                        <div id="strategy-params">
                                            <p class="text-muted">è¯·å…ˆé€‰æ‹©ç­–ç•¥ç±»å‹</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-play"></i> å¼€å§‹å›æµ‹
                                </button>
                                <button type="button" class="btn btn-secondary" id="reset-backtest">
                                    <i class="fas fa-redo"></i> é‡ç½®é…ç½®
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- å›æµ‹ç»“æœ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">å›æµ‹ç»“æœ</h5>
                    <div id="backtest-status" class="badge bg-secondary">ç­‰å¾…å›æµ‹</div>
                </div>
                <div class="card-body">
                    <div id="backtest-results">
                        <div class="text-center py-5">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">è¯·é…ç½®å›æµ‹å‚æ•°å¹¶ç‚¹å‡»"å¼€å§‹å›æµ‹"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStock = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('å›æµ‹é¡µé¢åˆå§‹åŒ–...');
    
    initializeDates();
    loadStockOptions();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('backtest-form').addEventListener('submit', handleBacktest);
    document.getElementById('reset-backtest').addEventListener('click', resetBacktest);
    document.getElementById('strategy-type').addEventListener('change', updateStrategyParams);
    document.getElementById('stock-select').addEventListener('change', handleStockChange);
});

// åˆå§‹åŒ–æ—¥æœŸ
function initializeDates() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setFullYear(endDate.getFullYear() - 1); // é»˜è®¤å›æµ‹1å¹´
    
    document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
}

// åŠ è½½è‚¡ç¥¨é€‰é¡¹
async function loadStockOptions() {
    try {
        console.log('åŠ è½½è‚¡ç¥¨é€‰é¡¹...');
        const response = await apiRequest('/stocks?page_size=100');
        if (response.code === 200) {
            const select = document.getElementById('stock-select');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è¦å›æµ‹çš„è‚¡ç¥¨</option>';
            
            response.data.stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock.ts_code;
                option.textContent = `${stock.symbol} - ${stock.name}`;
                select.appendChild(option);
            });
            console.log('è‚¡ç¥¨é€‰é¡¹åŠ è½½å®Œæˆ');
        }
    } catch (error) {
        console.error('åŠ è½½è‚¡ç¥¨é€‰é¡¹å¤±è´¥:', error);
    }
}

// å¤„ç†è‚¡ç¥¨é€‰æ‹©å˜åŒ–
function handleStockChange(event) {
    currentStock = event.target.value;
    console.log('é€‰æ‹©è‚¡ç¥¨:', currentStock);
}

// æ›´æ–°ç­–ç•¥å‚æ•°
function updateStrategyParams() {
    const strategyType = document.getElementById('strategy-type').value;
    const paramsContainer = document.getElementById('strategy-params');
    
    let paramsHtml = '';
    
    switch (strategyType) {
        case 'ma_cross':
            paramsHtml = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">çŸ­æœŸå‡çº¿å‘¨æœŸ</label>
                        <input type="number" class="form-control" id="ma-short" value="5" min="1" max="30">
                        <div class="form-text">å»ºè®®: 5-10å¤©</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">é•¿æœŸå‡çº¿å‘¨æœŸ</label>
                        <input type="number" class="form-control" id="ma-long" value="20" min="10" max="100">
                        <div class="form-text">å»ºè®®: 20-60å¤©</div>
                    </div>
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>ç­–ç•¥è¯´æ˜:</strong> å½“çŸ­æœŸå‡çº¿ä¸Šç©¿é•¿æœŸå‡çº¿æ—¶ä¹°å…¥ï¼Œä¸‹ç©¿æ—¶å–å‡º
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'macd':
            paramsHtml = `
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">å¿«çº¿å‘¨æœŸ</label>
                        <input type="number" class="form-control" id="macd-fast" value="12" min="5" max="30">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">æ…¢çº¿å‘¨æœŸ</label>
                        <input type="number" class="form-control" id="macd-slow" value="26" min="15" max="50">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ä¿¡å·çº¿å‘¨æœŸ</label>
                        <input type="number" class="form-control" id="macd-signal" value="9" min="5" max="20">
                    </div>
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>ç­–ç•¥è¯´æ˜:</strong> å½“MACDçº¿ä¸Šç©¿ä¿¡å·çº¿æ—¶ä¹°å…¥ï¼Œä¸‹ç©¿æ—¶å–å‡º
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'kdj':
            paramsHtml = `
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Kå€¼å‘¨æœŸ</label>
                        <input type="number" class="form-control" id="kdj-period" value="9" min="5" max="20">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">è¶…ä¹°é˜ˆå€¼</label>
                        <input type="number" class="form-control" id="kdj-overbought" value="80" min="70" max="90">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">è¶…å–é˜ˆå€¼</label>
                        <input type="number" class="form-control" id="kdj-oversold" value="20" min="10" max="30">
                    </div>
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>ç­–ç•¥è¯´æ˜:</strong> å½“KDJä»è¶…å–åŒºåŸŸå‘ä¸Šçªç ´æ—¶ä¹°å…¥ï¼Œä»è¶…ä¹°åŒºåŸŸå‘ä¸‹çªç ´æ—¶å–å‡º
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'rsi':
            paramsHtml = `
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">RSIå‘¨æœŸ</label>
                        <input type="number" class="form-control" id="rsi-period" value="14" min="6" max="30">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">è¶…ä¹°é˜ˆå€¼</label>
                        <input type="number" class="form-control" id="rsi-overbought" value="70" min="60" max="80">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">è¶…å–é˜ˆå€¼</label>
                        <input type="number" class="form-control" id="rsi-oversold" value="30" min="20" max="40">
                    </div>
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>ç­–ç•¥è¯´æ˜:</strong> å½“RSIä»è¶…å–åŒºåŸŸå‘ä¸Šçªç ´æ—¶ä¹°å…¥ï¼Œä»è¶…ä¹°åŒºåŸŸå‘ä¸‹çªç ´æ—¶å–å‡º
                        </div>
                    </div>
                </div>
            `;
            break;
        case 'bollinger':
            paramsHtml = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">å‡çº¿å‘¨æœŸ</label>
                        <input type="number" class="form-control" id="boll-period" value="20" min="10" max="50">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">æ ‡å‡†å·®å€æ•°</label>
                        <input type="number" class="form-control" id="boll-std" value="2" min="1" max="3" step="0.1">
                    </div>
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>ç­–ç•¥è¯´æ˜:</strong> å½“ä»·æ ¼è§¦åŠä¸‹è½¨æ—¶ä¹°å…¥ï¼Œè§¦åŠä¸Šè½¨æ—¶å–å‡º
                        </div>
                    </div>
                </div>
            `;
            break;
        default:
            paramsHtml = '<p class="text-muted">è¯·å…ˆé€‰æ‹©ç­–ç•¥ç±»å‹</p>';
    }
    
    paramsContainer.innerHTML = paramsHtml;
}

// å¤„ç†å›æµ‹
async function handleBacktest(event) {
    event.preventDefault();
    
    const tsCode = document.getElementById('stock-select').value;
    const strategyType = document.getElementById('strategy-type').value;
    
    if (!tsCode) {
        alert('è¯·é€‰æ‹©è¦å›æµ‹çš„è‚¡ç¥¨');
        return;
    }
    
    if (!strategyType) {
        alert('è¯·é€‰æ‹©ç­–ç•¥ç±»å‹');
        return;
    }
    
    // æ”¶é›†å›æµ‹å‚æ•°
    const config = {
        ts_code: tsCode,
        strategy_type: strategyType,
        start_date: document.getElementById('start-date').value,
        end_date: document.getElementById('end-date').value,
        initial_capital: parseFloat(document.getElementById('initial-capital').value),
        commission_rate: parseFloat(document.getElementById('commission-rate').value) / 100,
        params: collectStrategyParams(strategyType)
    };
    
    console.log('å¼€å§‹å›æµ‹ï¼Œé…ç½®:', config);
    await performBacktest(config);
}

// æ”¶é›†ç­–ç•¥å‚æ•°
function collectStrategyParams(strategyType) {
    const params = {};
    
    switch (strategyType) {
        case 'ma_cross':
            params.ma_short = parseInt(document.getElementById('ma-short').value);
            params.ma_long = parseInt(document.getElementById('ma-long').value);
            break;
        case 'macd':
            params.fast = parseInt(document.getElementById('macd-fast').value);
            params.slow = parseInt(document.getElementById('macd-slow').value);
            params.signal = parseInt(document.getElementById('macd-signal').value);
            break;
        case 'kdj':
            params.period = parseInt(document.getElementById('kdj-period').value);
            params.overbought = parseInt(document.getElementById('kdj-overbought').value);
            params.oversold = parseInt(document.getElementById('kdj-oversold').value);
            break;
        case 'rsi':
            params.period = parseInt(document.getElementById('rsi-period').value);
            params.overbought = parseInt(document.getElementById('rsi-overbought').value);
            params.oversold = parseInt(document.getElementById('rsi-oversold').value);
            break;
        case 'bollinger':
            params.period = parseInt(document.getElementById('boll-period').value);
            params.std_dev = parseFloat(document.getElementById('boll-std').value);
            break;
    }
    
    return params;
}

// æ‰§è¡Œå›æµ‹
async function performBacktest(config) {
    const statusBadge = document.getElementById('backtest-status');
    const resultsContainer = document.getElementById('backtest-results');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    statusBadge.className = 'badge bg-warning';
    statusBadge.textContent = 'å›æµ‹ä¸­...';
    
    resultsContainer.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">å›æµ‹ä¸­...</span>
            </div>
            <p class="mt-3 text-muted">æ­£åœ¨åŸºäºå†å²æ•°æ®è¿›è¡Œç­–ç•¥å›æµ‹ï¼Œè¯·ç¨å€™...</p>
        </div>
    `;
    
    try {
        console.log('è°ƒç”¨å›æµ‹API...');
        const response = await apiRequest('/analysis/backtest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            data: config
        });
        
        if (response.code === 200) {
            console.log('å›æµ‹æˆåŠŸï¼Œç»“æœ:', response.data);
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'å›æµ‹å®Œæˆ';
            renderBacktestResults(response.data, config);
        } else {
            throw new Error(response.message || 'å›æµ‹å¤±è´¥');
        }
    } catch (error) {
        console.error('å›æµ‹å¤±è´¥:', error);
        statusBadge.className = 'badge bg-danger';
        statusBadge.textContent = 'å›æµ‹å¤±è´¥';
        
        resultsContainer.innerHTML = `
            <div class="alert alert-danger">
                <h6 class="alert-heading">å›æµ‹å¤±è´¥</h6>
                <p class="mb-0">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                <hr>
                <p class="mb-0">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
            </div>
        `;
    }
}

// æ¸²æŸ“å›æµ‹ç»“æœ
function renderBacktestResults(results, config) {
    const container = document.getElementById('backtest-results');
    const perf = results.performance;
    
    // è·å–è‚¡ç¥¨ä¿¡æ¯
    const stockSelect = document.getElementById('stock-select');
    const stockName = stockSelect.options[stockSelect.selectedIndex].text;
    
    const html = `
        <div class="row g-4">
            <!-- ç­–ç•¥ä¿¡æ¯ -->
            <div class="col-md-6">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-info-circle"></i> ç­–ç•¥ä¿¡æ¯</h6>
                        <p class="mb-1"><strong>å›æµ‹è‚¡ç¥¨:</strong> ${stockName}</p>
                        <p class="mb-1"><strong>ç­–ç•¥ç±»å‹:</strong> ${getStrategyTypeName(config.strategy_type)}</p>
                        <p class="mb-1"><strong>å›æµ‹æœŸé—´:</strong> ${config.start_date} è‡³ ${config.end_date}</p>
                        <p class="mb-0"><strong>åˆå§‹èµ„é‡‘:</strong> Â¥${formatNumber(config.initial_capital, 0)}</p>
                    </div>
                </div>
            </div>
            
            <!-- æ”¶ç›ŠæŒ‡æ ‡ -->
            <div class="col-md-6">
                <div class="card ${perf.total_return >= 0 ? 'bg-success' : 'bg-danger'} text-white">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-chart-line"></i> æ”¶ç›ŠæŒ‡æ ‡</h6>
                        <p class="mb-1"><strong>æ€»æ”¶ç›Šç‡:</strong> ${formatPercent(perf.total_return)}</p>
                        <p class="mb-1"><strong>å¹´åŒ–æ”¶ç›Šç‡:</strong> ${formatPercent(perf.annual_return)}</p>
                        <p class="mb-1"><strong>å¤æ™®æ¯”ç‡:</strong> ${formatNumber(perf.sharpe_ratio, 2)}</p>
                        <p class="mb-0"><strong>æœ€å¤§å›æ’¤:</strong> ${formatPercent(perf.max_drawdown)}</p>
                    </div>
                </div>
            </div>
            
            <!-- äº¤æ˜“ç»Ÿè®¡ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-exchange-alt"></i> äº¤æ˜“ç»Ÿè®¡</h6>
                        <p class="mb-1"><strong>æ€»äº¤æ˜“æ¬¡æ•°:</strong> ${perf.total_trades}</p>
                        <p class="mb-1"><strong>ç›ˆåˆ©äº¤æ˜“:</strong> ${perf.winning_trades}</p>
                        <p class="mb-1"><strong>èƒœç‡:</strong> ${formatPercent(perf.win_rate)}</p>
                        <p class="mb-0"><strong>å¹³å‡æŒä»“å¤©æ•°:</strong> ${perf.avg_holding_days} å¤©</p>
                    </div>
                </div>
            </div>
            
            <!-- é£é™©æŒ‡æ ‡ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-shield-alt"></i> é£é™©æŒ‡æ ‡</h6>
                        <p class="mb-1"><strong>æ³¢åŠ¨ç‡:</strong> ${formatPercent(perf.volatility)}</p>
                        <p class="mb-1"><strong>æœ€ç»ˆèµ„é‡‘:</strong> Â¥${formatNumber(perf.final_capital, 0)}</p>
                        <p class="mb-1"><strong>æ‰‹ç»­è´¹æ€»è®¡:</strong> Â¥${formatNumber(perf.total_commission, 0)}</p>
                        <p class="mb-0"><strong>åŸºå‡†æ”¶ç›Šç‡:</strong> ${formatPercent(perf.benchmark_return)}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- äº¤æ˜“è®°å½• -->
        ${results.trades && results.trades.length > 0 ? `
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-list"></i> äº¤æ˜“è®°å½• (æœ€è¿‘10ç¬”)</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ“ä½œ</th>
                                    <th>ä»·æ ¼</th>
                                    <th>æ•°é‡</th>
                                    <th>é‡‘é¢</th>
                                    <th>æ”¶ç›Šç‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${results.trades.slice(0, 10).map(trade => `
                                    <tr>
                                        <td>${trade.date}</td>
                                        <td>
                                            <span class="badge ${trade.action === 'buy' ? 'bg-success' : 'bg-danger'}">
                                                ${trade.action === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'}
                                            </span>
                                        </td>
                                        <td>Â¥${formatNumber(trade.price, 2)}</td>
                                        <td>${trade.quantity}</td>
                                        <td>Â¥${formatNumber(trade.amount, 0)}</td>
                                        <td class="${trade.return_rate >= 0 ? 'text-success' : 'text-danger'}">
                                            ${trade.return_rate ? formatPercent(trade.return_rate) : '--'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
        
        <div class="mt-4">
            <div class="alert alert-info">
                <h6 class="alert-heading"><i class="fas fa-info-circle"></i> å›æµ‹è¯´æ˜</h6>
                <ul class="mb-0">
                    <li>å›æµ‹åŸºäºå†å²æ•°æ®ï¼Œä¸è€ƒè™‘æµåŠ¨æ€§ã€æ»‘ç‚¹ç­‰å®é™…äº¤æ˜“æˆæœ¬</li>
                    <li>ç­–ç•¥ä¿¡å·åŸºäºæ”¶ç›˜ä»·è®¡ç®—ï¼Œå®é™…äº¤æ˜“å¯èƒ½å­˜åœ¨å»¶è¿Ÿ</li>
                    <li>å›æµ‹ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®</li>
                    <li>è¿‡å¾€è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Š</li>
                </ul>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// è·å–ç­–ç•¥ç±»å‹åç§°
function getStrategyTypeName(type) {
    const names = {
        'ma_cross': 'å‡çº¿äº¤å‰ç­–ç•¥',
        'macd': 'MACDç­–ç•¥',
        'kdj': 'KDJç­–ç•¥',
        'rsi': 'RSIç­–ç•¥',
        'bollinger': 'å¸ƒæ—å¸¦ç­–ç•¥'
    };
    return names[type] || type;
}

// é‡ç½®å›æµ‹
function resetBacktest() {
    document.getElementById('backtest-form').reset();
    initializeDates();
    updateStrategyParams();
    
    document.getElementById('backtest-status').className = 'badge bg-secondary';
    document.getElementById('backtest-status').textContent = 'ç­‰å¾…å›æµ‹';
    
    document.getElementById('backtest-results').innerHTML = `
        <div class="text-center py-5">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <p class="text-muted">è¯·é…ç½®å›æµ‹å‚æ•°å¹¶ç‚¹å‡»"å¼€å§‹å›æµ‹"</p>
        </div>
    `;
}

// å·¥å…·å‡½æ•°
function formatNumber(num, decimals = 2) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    return Number(num).toLocaleString('zh-CN', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

function formatPercent(num) {
    if (num === null || num === undefined || isNaN(num)) return '--';
    const sign = num >= 0 ? '+' : '';
    return sign + Number(num).toFixed(2) + '%';
}
</script>
{% endblock %} 