{% extends "base.html" %}

{% block title %}è‚¡ç¥¨åˆ—è¡¨ - è‚¡ç¥¨åˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2">ğŸ“‹ è‚¡ç¥¨åˆ—è¡¨</h1>
            <p class="text-muted">æµè§ˆæ‰€æœ‰è‚¡ç¥¨ä¿¡æ¯ï¼Œæ”¯æŒæŒ‰è¡Œä¸šã€åœ°åŸŸç­›é€‰</p>
        </div>
    </div>

    <!-- ç­›é€‰æ¡ä»¶ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form id="filter-form" class="row g-3">
                        <div class="col-md-4">
                            <label for="industry-select" class="form-label">è¡Œä¸š</label>
                            <select class="form-select" id="industry-select">
                                <option value="">å…¨éƒ¨è¡Œä¸š</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="area-select" class="form-label">åœ°åŸŸ</label>
                            <select class="form-select" id="area-select">
                                <option value="">å…¨éƒ¨åœ°åŸŸ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="search-input" class="form-label">æœç´¢</label>
                            <input type="text" class="form-control" id="search-input" placeholder="è‚¡ç¥¨ä»£ç æˆ–åç§°">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">ç­›é€‰</button>
                            <button type="button" class="btn btn-secondary" id="reset-btn">é‡ç½®</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- è‚¡ç¥¨åˆ—è¡¨ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">è‚¡ç¥¨åˆ—è¡¨</h5>
                    <span class="badge bg-primary" id="total-count">0</span>
                </div>
                <div class="card-body">
                    <div id="stocks-container">
                        <!-- è‚¡ç¥¨åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <nav aria-label="è‚¡ç¥¨åˆ—è¡¨åˆ†é¡µ" class="mt-4">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- åˆ†é¡µæŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadIndustries();
    loadAreas();
    loadStocks();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('filter-form').addEventListener('submit', handleFilter);
    document.getElementById('reset-btn').addEventListener('click', resetFilters);
});

// åŠ è½½è¡Œä¸šåˆ—è¡¨
async function loadIndustries() {
    try {
        const response = await apiRequest('/industries');
        if (response.code === 200) {
            const select = document.getElementById('industry-select');
            response.data.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½è¡Œä¸šåˆ—è¡¨å¤±è´¥:', error);
    }
}

// åŠ è½½åœ°åŸŸåˆ—è¡¨
async function loadAreas() {
    try {
        const response = await apiRequest('/areas');
        if (response.code === 200) {
            const select = document.getElementById('area-select');
            response.data.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('åŠ è½½åœ°åŸŸåˆ—è¡¨å¤±è´¥:', error);
    }
}

// åŠ è½½è‚¡ç¥¨åˆ—è¡¨
async function loadStocks(page = 1) {
    showLoading('stocks-container');
    
    try {
        const params = new URLSearchParams({
            page: page,
            page_size: 20,
            ...currentFilters
        });
        
        const response = await apiRequest(`/stocks?${params}`);
        if (response.code === 200) {
            renderStocks(response.data.stocks);
            renderPagination(response.data);
            document.getElementById('total-count').textContent = response.data.total;
            currentPage = page;
        }
    } catch (error) {
        showError('stocks-container', 'åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥');
        console.error('åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ¸²æŸ“è‚¡ç¥¨åˆ—è¡¨
function renderStocks(stocks) {
    const container = document.getElementById('stocks-container');
    
    if (stocks.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">æš‚æ— æ•°æ®</p></div>';
        return;
    }
    
    const html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨ä»£ç </th>
                        <th>è‚¡ç¥¨åç§°</th>
                        <th>è¡Œä¸š</th>
                        <th>åœ°åŸŸ</th>
                        <th>ä¸Šå¸‚æ—¥æœŸ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${stocks.map(stock => `
                        <tr>
                            <td><code>${stock.symbol}</code></td>
                            <td><strong>${stock.name}</strong></td>
                            <td><span class="badge bg-secondary">${stock.industry || '--'}</span></td>
                            <td>${stock.area || '--'}</td>
                            <td>${stock.list_date || '--'}</td>
                            <td>
                                <a href="/stock/${stock.ts_code}" class="btn btn-sm btn-primary">è¯¦æƒ…</a>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// æ¸²æŸ“åˆ†é¡µ
function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    const { page, total_pages } = data;
    
    if (total_pages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // ä¸Šä¸€é¡µ
    html += `
        <li class="page-item ${page <= 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadStocks(${page - 1}); return false;">ä¸Šä¸€é¡µ</a>
        </li>
    `;
    
    // é¡µç 
    const startPage = Math.max(1, page - 2);
    const endPage = Math.min(total_pages, page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadStocks(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    // ä¸‹ä¸€é¡µ
    html += `
        <li class="page-item ${page >= total_pages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="loadStocks(${page + 1}); return false;">ä¸‹ä¸€é¡µ</a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

// å¤„ç†ç­›é€‰
function handleFilter(event) {
    event.preventDefault();
    
    currentFilters = {};
    
    const industry = document.getElementById('industry-select').value;
    const area = document.getElementById('area-select').value;
    const search = document.getElementById('search-input').value;
    
    if (industry) currentFilters.industry = industry;
    if (area) currentFilters.area = area;
    if (search) currentFilters.search = search;
    
    loadStocks(1);
}

// é‡ç½®ç­›é€‰
function resetFilters() {
    document.getElementById('industry-select').value = '';
    document.getElementById('area-select').value = '';
    document.getElementById('search-input').value = '';
    currentFilters = {};
    loadStocks(1);
}
</script>
{% endblock %} 